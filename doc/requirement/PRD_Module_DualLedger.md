# PRD - åŒè½¨è´¦æœ¬æ¨¡å—

**æ¨¡å—ID:** MOD-003
**æ¨¡å—åç§°:** åŒè½¨è´¦æœ¬ï¼ˆç”Ÿå­˜è´¦æˆ· + çµé­‚è´¦æˆ·ï¼‰
**ç‰ˆæœ¬:** 1.0
**åˆ›å»ºæ—¥æœŸ:** 2026å¹´2æœˆ3æ—¥
**ä¼˜å…ˆçº§:** P0ï¼ˆMVPå¿…å¤‡ï¼‰
**é¢„ä¼°å·¥æ—¶:** 8å¤©

---

## 1. æ¨¡å—æ¦‚è¿°

### 1.1 åŠŸèƒ½å®šä¹‰

åŒè½¨è´¦æœ¬æ˜¯Home Pocketçš„æ ¸å¿ƒå·®å¼‚åŒ–åŠŸèƒ½,å°†æ‰€æœ‰æ¶ˆè´¹è‡ªåŠ¨åˆ†ç±»ä¸ºä¸¤ä¸ªè´¦æˆ·:
- **ç”Ÿå­˜è´¦æˆ·ï¼ˆã‚µãƒã‚¤ãƒãƒ«å‹˜å®šï¼‰:** å¿…éœ€æ”¯å‡º,å¦‚æˆ¿ç§Ÿã€æ°´ç”µã€è¶…å¸‚é£Ÿå“
- **çµé­‚è´¦æˆ·ï¼ˆã‚½ã‚¦ãƒ«å‹˜å®šï¼‰:** çˆ±å¥½æ”¯å‡º,å¦‚å¤–é£Ÿã€å¨±ä¹ã€å…´è¶£æ¶ˆè´¹

**æ ¸å¿ƒä»·å€¼ä¸»å¼ :**
èµ‹äºˆçˆ±å¥½æ¶ˆè´¹æ­£å‘æ„ä¹‰,é¿å…æ„§ç–šæ„Ÿã€‚å°†"ä¹°é«˜è¾¾æ¨¡å‹"é‡æ„ä¸º"ç²¾ç¥èµ„äº§æŠ•èµ„",è€Œé"æµªè´¹é’±"ã€‚

### 1.2 ç”¨æˆ·åœºæ™¯ä¸ç—›ç‚¹

**ç”¨æˆ·ç”»åƒ:**
- ç”°ä¸­å’Œç¾æƒ ï¼ˆ35å²å¤«å¦‡ï¼‰,ç¾æƒ å–œæ¬¢ä¹°ç¾å¦†,ç”°ä¸­å–œæ¬¢ä¹°é«˜è¾¾æ¨¡å‹
- æ¯æœˆè®°è´¦æ—¶å› "å…´è¶£æ¶ˆè´¹"äº‰åµ
- ä¼ ç»Ÿè®°è´¦åº”ç”¨å°†æ‰€æœ‰æ”¯å‡ºè§†ä¸º"è´Ÿæ‹…",ç¼ºä¹æƒ…æ„Ÿè®¾è®¡

**ç—›ç‚¹:**
1. **ä¼ ç»Ÿè®°è´¦çš„è´Ÿé¢æƒ…ç»ª:** çœ‹åˆ°æ”¯å‡ºæŠ¥è¡¨æ—¶åªæœ‰ç„¦è™‘å’Œæ„§ç–š
2. **çˆ±å¥½æ¶ˆè´¹çš„é“å¾·å‹åŠ›:** ä¹°å–œæ¬¢çš„ä¸œè¥¿æ—¶å¿ƒç†è´Ÿæ‹…é‡
3. **å¤«å¦»é—´å› çˆ±å¥½æ¶ˆè´¹äº‰æ‰§:** "ä½ åˆä¹°æ¨¡å‹äº†?" vs "ä½ çš„åŒ–å¦†å“è¿˜ä¸å¤Ÿå¤š?"

**Home Pocketè§£å†³æ–¹æ¡ˆ:**
- è‡ªåŠ¨å°†æ¶ˆè´¹åˆ†ä¸º"å¿…éœ€"å’Œ"äº«ä¹"ä¸¤ç±»
- ç»™çµé­‚æ¶ˆè´¹æ­£å‘åé¦ˆï¼ˆåº†ç¥åŠ¨ç”»ï¼‰
- å¤«å¦»æ¨¡å¼ä¸‹:ä¼´ä¾£åªèƒ½çœ‹åˆ°çµé­‚è´¦æˆ·é¢„ç®—è¿›åº¦,ä¸èƒ½çœ‹åˆ°æ˜ç»†ï¼ˆéšç§ä¿æŠ¤ï¼‰

### 1.3 ä¸å…¶ä»–æ¨¡å—çš„ä¾èµ–å…³ç³»

**å‰ç½®ä¾èµ–:**
- MOD-001 åŸºç¡€è®°è´¦ï¼ˆéœ€è¦äº¤æ˜“æ•°æ®ï¼‰
- MOD-002 åˆ†ç±»ç®¡ç†ï¼ˆéœ€è¦åˆ†ç±»ä¿¡æ¯ï¼‰

**è¢«ä¾èµ–:**
- MOD-007 æ•°æ®åˆ†æï¼ˆåŒè½¨æŠ¥è¡¨ï¼‰
- MOD-009 è¶£å‘³åŠŸèƒ½ï¼ˆçµé­‚æ¶ˆè´¹åº†ç¥åŠ¨ç”»ï¼‰
- MOD-004 å®¶åº­åŒæ­¥ï¼ˆä¼´ä¾£éšç§è®¾ç½®ï¼‰

---

## 2. è¯¦ç»†åŠŸèƒ½è§„æ ¼

### 2.1 è‡ªåŠ¨åˆ†ç±»å¼•æ“ï¼ˆä¸‰å±‚ç­–ç•¥ï¼‰

#### 2.1.1 Layer 1: è§„åˆ™å¼•æ“ï¼ˆä¼˜å…ˆçº§æœ€é«˜ï¼‰

**åŠŸèƒ½æ¦‚è¿°:**
åŸºäºé¢„è®¾è§„åˆ™,å°†20ä¸ªç³»ç»Ÿåˆ†ç±»æ˜ å°„åˆ°ç”Ÿå­˜/çµé­‚è´¦æˆ·ã€‚

**è§„åˆ™æ˜ å°„è¡¨:**

| åˆ†ç±»ID | åˆ†ç±»åç§° | è´¦æˆ·ç±»å‹ | ç½®ä¿¡åº¦ |
|--------|---------|---------|--------|
| food_groceries | é£Ÿè²»ï¼ˆã‚¹ãƒ¼ãƒ‘ãƒ¼ï¼‰ | survival | 100% |
| food_restaurant | é£Ÿè²»ï¼ˆå¤–é£Ÿï¼‰ | soul | 95% |
| housing_rent | ä½å®…ï¼ˆå®¶è³ƒï¼‰ | survival | 100% |
| utilities | å…‰ç†±è²» | survival | 100% |
| transport_commute | äº¤é€šè²»ï¼ˆé€šå‹¤ï¼‰ | survival | 100% |
| transport_travel | äº¤é€šè²»ï¼ˆæ—…è¡Œï¼‰ | soul | 95% |
| medical | åŒ»ç™‚è²» | survival | 100% |
| entertainment | å¨¯æ¥½ | soul | 100% |
| hobby | è¶£å‘³ | soul | 100% |
| shopping_fashion | ãƒ•ã‚¡ãƒƒã‚·ãƒ§ãƒ³ | soul | 90% |
| beauty | ç¾å®¹ | soul | 90% |
| education | å­¦ç¿’ | survival | 80% |
| insurance | ä¿é™º | survival | 100% |
| communication | é€šä¿¡è²» | survival | 100% |
| daily_goods | æ—¥ç”¨å“ | survival | 95% |

**å®ç°ä»£ç :**

```dart
// lib/features/dual_ledger/domain/classifiers/rule_based_classifier.dart

class RuleBasedClassifier {
  /// è§„åˆ™å¼•æ“æ˜ å°„è¡¨
  static const Map<String, LedgerTypeRule> categoryRules = {
    // ç”Ÿå­˜å¿…éœ€ï¼ˆ9ä¸ªï¼‰
    'food_groceries': LedgerTypeRule(LedgerType.survival, 1.0),
    'housing_rent': LedgerTypeRule(LedgerType.survival, 1.0),
    'utilities': LedgerTypeRule(LedgerType.survival, 1.0),
    'transport_commute': LedgerTypeRule(LedgerType.survival, 1.0),
    'medical': LedgerTypeRule(LedgerType.survival, 1.0),
    'insurance': LedgerTypeRule(LedgerType.survival, 1.0),
    'communication': LedgerTypeRule(LedgerType.survival, 1.0),
    'daily_goods': LedgerTypeRule(LedgerType.survival, 0.95),
    'education': LedgerTypeRule(LedgerType.survival, 0.8),

    // çµé­‚äº«ä¹ï¼ˆ7ä¸ªï¼‰
    'food_restaurant': LedgerTypeRule(LedgerType.soul, 0.95),
    'entertainment': LedgerTypeRule(LedgerType.soul, 1.0),
    'hobby': LedgerTypeRule(LedgerType.soul, 1.0),
    'shopping_fashion': LedgerTypeRule(LedgerType.soul, 0.9),
    'beauty': LedgerTypeRule(LedgerType.soul, 0.9),
    'travel': LedgerTypeRule(LedgerType.soul, 0.95),
    'education_hobby': LedgerTypeRule(LedgerType.soul, 0.85),
  };

  /// åˆ†ç±»ä¸ºç”Ÿå­˜/çµé­‚è´¦æˆ·
  ClassificationResult classify({
    required String categoryId,
    String? note,
    int? amount,
  }) {
    final rule = categoryRules[categoryId];

    if (rule == null) {
      // æœªçŸ¥åˆ†ç±»,é»˜è®¤ç”Ÿå­˜ï¼ˆä¿å®ˆç­–ç•¥ï¼‰
      return ClassificationResult(
        ledgerType: LedgerType.survival,
        confidence: 0.5,
        source: ClassificationSource.defaultRule,
      );
    }

    return ClassificationResult(
      ledgerType: rule.type,
      confidence: rule.confidence,
      source: ClassificationSource.ruleEngine,
    );
  }
}

class LedgerTypeRule {
  final LedgerType type;
  final double confidence;  // 0.0 - 1.0

  const LedgerTypeRule(this.type, this.confidence);
}
```

**è¾¹ç•Œæ¡ä»¶:**
- ç”¨æˆ·åˆ›å»ºçš„è‡ªå®šä¹‰åˆ†ç±»é»˜è®¤ä¸º`survival`,éœ€ç”¨æˆ·æ‰‹åŠ¨è®¾ç½®
- æ”¶å…¥ç±»å‹ä¸å‚ä¸åŒè½¨åˆ†ç±»,ç»Ÿä¸€å½’ä¸º`income`

#### 2.1.2 Layer 2: å•†å®¶æ•°æ®åº“ï¼ˆ500+å•†å®¶ï¼‰

**åŠŸèƒ½æ¦‚è¿°:**
æ ¹æ®å•†å®¶åç§°æ¨æ–­è´¦æˆ·ç±»å‹,ç”¨äºOCRæ‰«ææˆ–å¤‡æ³¨æ–‡æœ¬åŒ¹é…ã€‚

**å•†å®¶æ•°æ®åº“ç¤ºä¾‹:**

```dart
// lib/features/dual_ledger/data/merchant_database.dart

class MerchantDatabase {
  /// æ—¥æœ¬å¸¸è§å•†å®¶æ•°æ®åº“ï¼ˆ500+å•†å®¶ï¼‰
  static const Map<String, MerchantInfo> merchants = {
    // é£Ÿå“ - ç”Ÿå­˜
    'ã‚»ãƒ–ãƒ³ã‚¤ãƒ¬ãƒ–ãƒ³': MerchantInfo(
      category: 'food_groceries',
      ledgerType: LedgerType.survival,
      confidence: 0.9,
      tags: ['ã‚³ãƒ³ãƒ“ãƒ‹', 'é£Ÿå“', 'æ—¥ç”¨å“'],
    ),
    'ãƒ•ã‚¡ãƒŸãƒªãƒ¼ãƒãƒ¼ãƒˆ': MerchantInfo(
      category: 'food_groceries',
      ledgerType: LedgerType.survival,
      confidence: 0.9,
      tags: ['ã‚³ãƒ³ãƒ“ãƒ‹'],
    ),
    'ã‚¤ã‚ªãƒ³': MerchantInfo(
      category: 'food_groceries',
      ledgerType: LedgerType.survival,
      confidence: 0.85,
      tags: ['ã‚¹ãƒ¼ãƒ‘ãƒ¼'],
    ),

    // é£Ÿå“ - çµé­‚
    'å‰é‡å®¶': MerchantInfo(
      category: 'food_restaurant',
      ledgerType: LedgerType.soul,
      confidence: 0.95,
      tags: ['å¤–é£Ÿ', 'ç‰›ä¸¼'],
    ),
    'ãƒã‚¯ãƒ‰ãƒŠãƒ«ãƒ‰': MerchantInfo(
      category: 'food_restaurant',
      ledgerType: LedgerType.soul,
      confidence: 0.95,
      tags: ['å¤–é£Ÿ', 'ãƒ•ã‚¡ã‚¹ãƒˆãƒ•ãƒ¼ãƒ‰'],
    ),
    'ã‚¹ã‚¿ãƒ¼ãƒãƒƒã‚¯ã‚¹': MerchantInfo(
      category: 'food_restaurant',
      ledgerType: LedgerType.soul,
      confidence: 0.9,
      tags: ['ã‚«ãƒ•ã‚§'],
    ),

    // äº¤é€š - ç”Ÿå­˜
    'JRæ±æ—¥æœ¬': MerchantInfo(
      category: 'transport_commute',
      ledgerType: LedgerType.survival,
      confidence: 0.95,
      tags: ['é›»è»Š', 'é€šå‹¤'],
    ),
    'æ±äº¬ãƒ¡ãƒˆãƒ­': MerchantInfo(
      category: 'transport_commute',
      ledgerType: LedgerType.survival,
      confidence: 0.95,
      tags: ['åœ°ä¸‹é‰„', 'é€šå‹¤'],
    ),

    // è´­ç‰© - çµé­‚
    'ãƒ¨ãƒ‰ãƒã‚·ã‚«ãƒ¡ãƒ©': MerchantInfo(
      category: 'shopping_electronics',
      ledgerType: LedgerType.soul,
      confidence: 0.8,  // å¯èƒ½ä¹°å¿…éœ€å“æˆ–å¨±ä¹å“
      tags: ['å®¶é›»', 'ã‚«ãƒ¡ãƒ©'],
    ),
    'ãƒ¦ãƒ‹ã‚¯ãƒ­': MerchantInfo(
      category: 'shopping_fashion',
      ledgerType: LedgerType.soul,
      confidence: 0.85,
      tags: ['ãƒ•ã‚¡ãƒƒã‚·ãƒ§ãƒ³'],
    ),
    'ç„¡å°è‰¯å“': MerchantInfo(
      category: 'shopping_general',
      ledgerType: LedgerType.soul,
      confidence: 0.8,
      tags: ['é›‘è²¨'],
    ),

    // å¨±ä¹ - çµé­‚
    'TOHO': MerchantInfo(
      category: 'entertainment',
      ledgerType: LedgerType.soul,
      confidence: 0.95,
      tags: ['æ˜ ç”»'],
    ),
    'ãƒ©ã‚¦ãƒ³ãƒ‰ãƒ¯ãƒ³': MerchantInfo(
      category: 'entertainment',
      ledgerType: LedgerType.soul,
      confidence: 0.95,
      tags: ['ã‚²ãƒ¼ãƒ ', 'ãƒœã‚¦ãƒªãƒ³ã‚°'],
    ),

    // åŒ»ç–— - ç”Ÿå­˜
    'ãƒãƒ„ãƒ¢ãƒˆã‚­ãƒ¨ã‚·': MerchantInfo(
      category: 'medical',
      ledgerType: LedgerType.survival,
      confidence: 0.85,
      tags: ['è–¬å±€'],
    ),

    // çˆ±å¥½ - çµé­‚
    'ãƒ¨ãƒ‰ãƒã‚·': MerchantInfo(
      category: 'hobby',
      ledgerType: LedgerType.soul,
      confidence: 0.9,
      tags: ['ãƒ›ãƒ“ãƒ¼', 'æ¨¡å‹'],
    ),
  };

  /// æ ¹æ®å•†å®¶åç§°æŸ¥æ‰¾
  MerchantInfo? findMerchant(String merchantName) {
    // ç²¾ç¡®åŒ¹é…
    if (merchants.containsKey(merchantName)) {
      return merchants[merchantName];
    }

    // æ¨¡ç³ŠåŒ¹é…ï¼ˆåŒ…å«å…³ç³»ï¼‰
    for (final entry in merchants.entries) {
      if (merchantName.contains(entry.key) || entry.key.contains(merchantName)) {
        return entry.value;
      }
    }

    return null;
  }

  /// ä»å¤‡æ³¨æ–‡æœ¬ä¸­æå–å•†å®¶åç§°
  String? extractMerchantFromNote(String note) {
    // æ­£åˆ™æå– "@ å•†å®¶å" æˆ– "å•†å®¶åã§"
    final patterns = [
      RegExp(r'@\s*([^\s]+)'),  // "@ å‰é‡å®¶"
      RegExp(r'([^\s]+)ã§'),    // "å‰é‡å®¶ã§"
    ];

    for (final pattern in patterns) {
      final match = pattern.firstMatch(note);
      if (match != null && match.groupCount > 0) {
        return match.group(1);
      }
    }

    return null;
  }
}

class MerchantInfo {
  final String category;
  final LedgerType ledgerType;
  final double confidence;
  final List<String> tags;

  const MerchantInfo({
    required this.category,
    required this.ledgerType,
    required this.confidence,
    required this.tags,
  });
}
```

**æ•°æ®ç»´æŠ¤ç­–ç•¥:**
- MVPç‰ˆæœ¬:500ä¸ªæ—¥æœ¬å¸¸è§å•†å®¶ï¼ˆæ‰‹å·¥ç»´æŠ¤ï¼‰
- V1.0:é€šè¿‡OTAçƒ­æ›´æ–°JSONæ–‡ä»¶æ‰©å±•è‡³2000+å•†å®¶
- V2.0:ç¤¾åŒºè´¡çŒ®æœºåˆ¶,ç”¨æˆ·æäº¤æ–°å•†å®¶

#### 2.1.3 Layer 3: TensorFlow Liteæ¨¡å‹ï¼ˆå­¦ä¹ ç”¨æˆ·ä¹ æƒ¯ï¼‰

**æ³¨æ„:** æ ¹æ®å¯è¡Œæ€§ç ”ç©¶,**ä¸ä½¿ç”¨Gemini Nano**ï¼ˆé…é¢é™åˆ¶ã€ä»…å‰å°ã€è®¾å¤‡å…¼å®¹æ€§é—®é¢˜ï¼‰,æ”¹ç”¨TensorFlow Liteæœ¬åœ°æ¨¡å‹ã€‚

**æ¨¡å‹æ¶æ„:**

```dart
// lib/features/dual_ledger/domain/classifiers/tflite_classifier.dart

class TFLiteClassifier {
  late Interpreter _interpreter;

  Future<void> initialize() async {
    // åŠ è½½æ¨¡å‹æ–‡ä»¶ï¼ˆ200KBè½»é‡çº§æ¨¡å‹ï¼‰
    _interpreter = await Interpreter.fromAsset('assets/models/ledger_classifier.tflite');
  }

  Future<ClassificationResult> predict({
    required String merchant,
    required String note,
    required int amount,
    required DateTime timestamp,
  }) async {
    // æ„å»ºè¾“å…¥ç‰¹å¾å‘é‡ï¼ˆ191ç»´ï¼‰
    final input = _buildInputTensor(merchant, note, amount, timestamp);

    // è¿è¡Œæ¨ç†
    final output = List.filled(2, 0.0).reshape([1, 2]);
    _interpreter.run(input, output);

    // è§£æè¾“å‡ºï¼š[survival_prob, soul_prob]
    final survivalProb = output[0][0];
    final soulProb = output[0][1];

    return ClassificationResult(
      ledgerType: soulProb > survivalProb ? LedgerType.soul : LedgerType.survival,
      confidence: math.max(survivalProb, soulProb),
      source: ClassificationSource.mlModel,
    );
  }

  List<List<double>> _buildInputTensor(
    String merchant,
    String note,
    int amount,
    DateTime timestamp,
  ) {
    final features = <double>[];

    // 1. å•†å®¶åµŒå…¥ï¼ˆ100ç»´ï¼‰
    features.addAll(_merchantEmbedding(merchant));

    // 2. å¤‡æ³¨å…³é”®è¯åµŒå…¥ï¼ˆ50ç»´ï¼‰
    features.addAll(_noteKeywordEmbedding(note));

    // 3. é‡‘é¢åˆ†æ¡¶ï¼ˆ10ç»´ - one-hotç¼–ç ï¼‰
    features.addAll(_amountBucket(amount));

    // 4. æ—¶é—´ç‰¹å¾ï¼ˆ31ç»´ï¼‰
    features.addAll(_timeFeatures(timestamp));

    return [features];
  }

  List<double> _merchantEmbedding(String merchant) {
    // ä½¿ç”¨é¢„è®­ç»ƒçš„Word2VecåµŒå…¥ï¼ˆç®€åŒ–ç‰ˆæœ¬ï¼‰
    // å®é™…ç”Ÿäº§ä¸­åº”ä½¿ç”¨çœŸå®çš„åµŒå…¥å‘é‡
    final hash = merchant.hashCode.abs() % 100;
    final embedding = List.filled(100, 0.0);
    embedding[hash] = 1.0;
    return embedding;
  }

  List<double> _noteKeywordEmbedding(String note) {
    // å…³é”®è¯æ£€æµ‹
    final soulKeywords = ['æ—…è¡Œ', 'è¶£å‘³', 'å¤–é£Ÿ', 'ã‚²ãƒ¼ãƒ ', 'æ˜ ç”»', 'ã‚«ãƒ•ã‚§'];
    final survivalKeywords = ['ã‚¹ãƒ¼ãƒ‘ãƒ¼', 'é€šå‹¤', 'å®¶è³ƒ', 'é›»æ°—', 'ã‚¬ã‚¹', 'è–¬'];

    final embedding = List.filled(50, 0.0);
    for (var i = 0; i < soulKeywords.length; i++) {
      if (note.contains(soulKeywords[i])) {
        embedding[i] = 1.0;
      }
    }
    for (var i = 0; i < survivalKeywords.length; i++) {
      if (note.contains(survivalKeywords[i])) {
        embedding[25 + i] = 1.0;
      }
    }
    return embedding;
  }

  List<double> _amountBucket(int amount) {
    // é‡‘é¢åˆ†æ¡¶ï¼š0-500, 500-1000, 1000-2000, ..., >10000
    final buckets = [0, 500, 1000, 2000, 3000, 5000, 7000, 10000, 20000, 50000];
    final embedding = List.filled(10, 0.0);

    for (var i = 0; i < buckets.length; i++) {
      if (amount >= buckets[i]) {
        embedding[i] = 1.0;
      } else {
        break;
      }
    }
    return embedding;
  }

  List<double> _timeFeatures(DateTime timestamp) {
    final features = <double>[];

    // æ—¶é—´ï¼ˆ0-23ï¼‰- one-hotç¼–ç 
    final hourEmbedding = List.filled(24, 0.0);
    hourEmbedding[timestamp.hour] = 1.0;
    features.addAll(hourEmbedding);

    // æ˜ŸæœŸï¼ˆ0-6ï¼‰- one-hotç¼–ç 
    final dowEmbedding = List.filled(7, 0.0);
    dowEmbedding[timestamp.weekday - 1] = 1.0;
    features.addAll(dowEmbedding);

    return features;
  }

  void dispose() {
    _interpreter.close();
  }
}
```

**æ¨¡å‹è®­ç»ƒæµç¨‹ï¼ˆV1.0ï¼‰:**
1. æ”¶é›†ç”¨æˆ·æ‰‹åŠ¨ä¿®æ­£çš„äº¤æ˜“æ•°æ®ï¼ˆæ ‡æ³¨æ•°æ®ï¼‰
2. æ¯å‘¨ç¦»çº¿è®­ç»ƒæ–°æ¨¡å‹
3. é€šè¿‡OTAæ¨é€æ›´æ–°çš„`.tflite`æ–‡ä»¶
4. ä¸ªæ€§åŒ–:æ¯ä¸ªç”¨æˆ·å¯é€‰æ‹©è®­ç»ƒä¸ªäººæ¨¡å‹ï¼ˆæœ¬åœ°è®­ç»ƒï¼‰

**æ€§èƒ½æŒ‡æ ‡:**
- æ¨ç†æ—¶é—´: <50msï¼ˆç§»åŠ¨è®¾å¤‡ï¼‰
- æ¨¡å‹å¤§å°: <500KB
- å‡†ç¡®ç‡ç›®æ ‡: >85%

#### 2.1.4 åˆ†ç±»å†³ç­–æµç¨‹

```
æ–°äº¤æ˜“åˆ›å»º
    â†“
Layer 1: è§„åˆ™å¼•æ“
    â”œâ”€ åˆ†ç±»IDåœ¨è§„åˆ™è¡¨ä¸­? â”€â”€Yesâ”€â”€â–º ä½¿ç”¨è§„åˆ™ç»“æœï¼ˆç½®ä¿¡åº¦100%ï¼‰
    â””â”€ No
        â†“
Layer 2: å•†å®¶æ•°æ®åº“
    â”œâ”€ å¤‡æ³¨åŒ…å«å•†å®¶å? â”€â”€Yesâ”€â”€â–º æŸ¥æ‰¾å•†å®¶æ•°æ®åº“
    â”‚                              â”œâ”€ æ‰¾åˆ°? â”€â”€Yesâ”€â”€â–º ä½¿ç”¨å•†å®¶ç»“æœï¼ˆç½®ä¿¡åº¦80-95%ï¼‰
    â”‚                              â””â”€ No â†“
    â””â”€ No â†“
        â†“
Layer 3: TensorFlow Liteæ¨¡å‹
    â””â”€ è¿è¡ŒMLæ¨ç† â”€â”€â–º ä½¿ç”¨æ¨¡å‹ç»“æœï¼ˆç½®ä¿¡åº¦50-90%ï¼‰
        â†“
    å¦‚æœç½®ä¿¡åº¦<70% â”€â”€â–º æç¤ºç”¨æˆ·æ‰‹åŠ¨ç¡®è®¤
        â†“
    ä¿å­˜æœ€ç»ˆåˆ†ç±»ç»“æœ
```

**Dartå®ç°:**

```dart
// lib/features/dual_ledger/domain/use_cases/classify_transaction.dart

class ClassifyTransactionUseCase {
  final RuleBasedClassifier _ruleClassifier;
  final MerchantDatabase _merchantDB;
  final TFLiteClassifier _mlClassifier;

  Future<ClassificationResult> execute(Transaction tx) async {
    // Layer 1: è§„åˆ™å¼•æ“
    final ruleResult = _ruleClassifier.classify(
      categoryId: tx.categoryId,
      note: tx.note,
      amount: tx.amount,
    );

    if (ruleResult.confidence >= 0.95) {
      return ruleResult;
    }

    // Layer 2: å•†å®¶æ•°æ®åº“
    if (tx.note != null) {
      final merchantName = _merchantDB.extractMerchantFromNote(tx.note!);
      if (merchantName != null) {
        final merchantInfo = _merchantDB.findMerchant(merchantName);
        if (merchantInfo != null && merchantInfo.confidence >= 0.8) {
          return ClassificationResult(
            ledgerType: merchantInfo.ledgerType,
            confidence: merchantInfo.confidence,
            source: ClassificationSource.merchantDB,
          );
        }
      }
    }

    // Layer 3: TF Liteæ¨¡å‹
    final mlResult = await _mlClassifier.predict(
      merchant: tx.note ?? '',
      note: tx.note ?? '',
      amount: tx.amount,
      timestamp: tx.timestamp,
    );

    // å¦‚æœç½®ä¿¡åº¦ä½,æ ‡è®°éœ€è¦æ‰‹åŠ¨ç¡®è®¤
    if (mlResult.confidence < 0.7) {
      return mlResult.copyWith(needsConfirmation: true);
    }

    return mlResult;
  }
}

class ClassificationResult {
  final LedgerType ledgerType;
  final double confidence;
  final ClassificationSource source;
  final bool needsConfirmation;

  ClassificationResult({
    required this.ledgerType,
    required this.confidence,
    required this.source,
    this.needsConfirmation = false,
  });

  ClassificationResult copyWith({
    LedgerType? ledgerType,
    double? confidence,
    ClassificationSource? source,
    bool? needsConfirmation,
  }) {
    return ClassificationResult(
      ledgerType: ledgerType ?? this.ledgerType,
      confidence: confidence ?? this.confidence,
      source: source ?? this.source,
      needsConfirmation: needsConfirmation ?? this.needsConfirmation,
    );
  }
}

enum ClassificationSource {
  ruleEngine,
  merchantDB,
  mlModel,
  defaultRule,
  userOverride,
}
```

---

### 2.2 çµé­‚è´¦æˆ·é…ç½®

#### 2.2.1 çµé­‚è´¦æˆ·ä¸ªæ€§åŒ–

**åŠŸèƒ½æ¦‚è¿°:**
ç”¨æˆ·å¯ä»¥è‡ªå®šä¹‰çµé­‚è´¦æˆ·çš„åç§°ã€å›¾æ ‡ã€é¢œè‰²,èµ‹äºˆå…¶ä¸ªæ€§åŒ–æ„ä¹‰ã€‚

**UIè®¾è®¡ï¼ˆå’Œé£æ¨¡å¼ï¼‰:**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ â† çµé­‚è´¦æˆ·è®¾ç½®                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                     â”‚
â”‚  ğŸ’– æˆ‘çš„ç²¾ç¥èµ„äº§                    â”‚
â”‚  â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”      â”‚
â”‚                                     â”‚
â”‚  è´¦æˆ·åç§°ï¼š                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚ é«˜è¾¾åŸºé‡‘                    â”‚    â”‚  â† å¯ç¼–è¾‘ï¼ˆæœ€å¤š20å­—ç¬¦ï¼‰
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                     â”‚
â”‚  é€‰æ‹©å›¾æ ‡ï¼š                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚ ğŸ¤– âœ¨ ğŸ¨ ğŸ® ğŸ’… âœˆï¸ ğŸ“š       â”‚    â”‚  â† å›¾æ ‡é€‰æ‹©å™¨
â”‚  â”‚ ğŸœ ğŸ¬ ğŸ¸ âš½ ğŸƒ ğŸ§˜ ğŸ“¸       â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                     â”‚
â”‚  é€‰æ‹©é¢œè‰²ï¼š                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚ ğŸ”´ ğŸŸ  ğŸŸ¡ ğŸŸ¢ ğŸ”µ ğŸŸ£ ğŸŸ¤       â”‚    â”‚  â† é¢œè‰²é€‰æ‹©å™¨
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                     â”‚
â”‚  æœˆåº¦é¢„ç®—ï¼š                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚ Â¥30,000                     â”‚    â”‚  â† å¯é€‰è®¾ç½®
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                     â”‚
â”‚  é¢„ç®—æé†’ï¼š                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚ â˜‘ è¾¾åˆ°80%æ—¶æé†’              â”‚    â”‚
â”‚  â”‚ â˜ è¾¾åˆ°100%æ—¶è­¦å‘Š             â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                     â”‚
â”‚  [ä¿å­˜è®¾ç½®]                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**æ•°æ®æ¨¡å‹:**

```dart
// lib/features/dual_ledger/data/models/soul_account_config.dart

@DataClassName('SoulAccountConfigData')
class SoulAccountConfig extends Table {
  TextColumn get id => text()();
  TextColumn get bookId => text()();
  TextColumn get deviceId => text()();

  // ä¸ªæ€§åŒ–è®¾ç½®
  TextColumn get soulName => text().nullable()();  // "é«˜è¾¾åŸºé‡‘", "ç¾å¦†åŸºé‡‘"
  TextColumn get iconEmoji => text().nullable()();  // "ğŸ¤–", "ğŸ’…"
  TextColumn get colorHex => text().nullable()();   // "#FF8C42"

  // é¢„ç®—è®¾ç½®
  IntColumn get monthlyBudget => integer().nullable()();  // 30000æ—¥å…ƒ
  BoolColumn get alertAt80Percent => boolean().withDefault(const Constant(true))();
  BoolColumn get alertAt100Percent => boolean().withDefault(const Constant(false))();

  IntColumn get createdAt => integer()();
  IntColumn get updatedAt => integer()();

  @override
  Set<Column> get primaryKey => {id};

  @override
  List<Set<Column>> get uniqueKeys => [
    {bookId, deviceId},
  ];
}
```

**å®ç°ä»£ç :**

```dart
// lib/features/dual_ledger/presentation/soul_config_screen.dart

class SoulConfigScreen extends ConsumerWidget {
  @override
  Widget build(BuildContext context, WidgetRef ref) {
    final config = ref.watch(soulAccountConfigProvider);

    return Scaffold(
      appBar: AppBar(
        title: Text('çµé­‚è´¦æˆ·è®¾ç½®'),
        actions: [
          TextButton(
            onPressed: () => _saveConfig(ref),
            child: Text('ä¿å­˜'),
          ),
        ],
      ),
      body: ListView(
        padding: EdgeInsets.all(16),
        children: [
          _buildHeader(config),
          SizedBox(height: 32),
          _buildNameInput(ref),
          SizedBox(height: 24),
          _buildIconPicker(ref),
          SizedBox(height: 24),
          _buildColorPicker(ref),
          SizedBox(height: 24),
          _buildBudgetInput(ref),
          SizedBox(height: 24),
          _buildAlertSettings(ref),
        ],
      ),
    );
  }

  Widget _buildHeader(SoulAccountConfig config) {
    return Container(
      padding: EdgeInsets.all(24),
      decoration: BoxDecoration(
        gradient: LinearGradient(
          colors: [
            Color(int.parse('0xFF${config.colorHex ?? 'FF8C42'}')),
            Color(int.parse('0xFF${config.colorHex ?? 'FF8C42'}'))
                .withOpacity(0.6),
          ],
        ),
        borderRadius: BorderRadius.circular(16),
      ),
      child: Row(
        children: [
          Text(
            config.iconEmoji ?? 'ğŸ’–',
            style: TextStyle(fontSize: 48),
          ),
          SizedBox(width: 16),
          Expanded(
            child: Column(
              crossAxisAlignment: CrossAxisAlignment.start,
              children: [
                Text(
                  config.soulName ?? 'æˆ‘çš„ç²¾ç¥èµ„äº§',
                  style: TextStyle(
                    fontSize: 24,
                    fontWeight: FontWeight.bold,
                    color: Colors.white,
                  ),
                ),
                if (config.monthlyBudget != null)
                  Text(
                    'æœˆåº¦é¢„ç®— Â¥${_formatAmount(config.monthlyBudget!)}',
                    style: TextStyle(
                      fontSize: 14,
                      color: Colors.white70,
                    ),
                  ),
              ],
            ),
          ),
        ],
      ),
    );
  }

  Widget _buildIconPicker(WidgetRef ref) {
    final icons = [
      'ğŸ¤–', 'âœ¨', 'ğŸ¨', 'ğŸ®', 'ğŸ’…', 'âœˆï¸', 'ğŸ“š',
      'ğŸœ', 'ğŸ¬', 'ğŸ¸', 'âš½', 'ğŸƒ', 'ğŸ§˜', 'ğŸ“¸',
    ];

    return Column(
      crossAxisAlignment: CrossAxisAlignment.start,
      children: [
        Text('é€‰æ‹©å›¾æ ‡', style: TextStyle(fontSize: 16, fontWeight: FontWeight.bold)),
        SizedBox(height: 12),
        Wrap(
          spacing: 12,
          runSpacing: 12,
          children: icons.map((icon) {
            return _buildIconButton(icon, ref);
          }).toList(),
        ),
      ],
    );
  }

  Widget _buildColorPicker(WidgetRef ref) {
    final colors = [
      '#F44336', '#FF9800', '#FFEB3B', '#4CAF50',
      '#2196F3', '#9C27B0', '#795548', '#607D8B',
    ];

    return Column(
      crossAxisAlignment: CrossAxisAlignment.start,
      children: [
        Text('é€‰æ‹©é¢œè‰²', style: TextStyle(fontSize: 16, fontWeight: FontWeight.bold)),
        SizedBox(height: 12),
        Wrap(
          spacing: 12,
          runSpacing: 12,
          children: colors.map((colorHex) {
            return _buildColorButton(colorHex, ref);
          }).toList(),
        ),
      ],
    );
  }

  String _formatAmount(int amount) {
    final formatter = NumberFormat('#,###', 'ja_JP');
    return formatter.format(amount);
  }
}
```

**é¢„è®¾æ¨¡æ¿:**

```dart
// é¢„è®¾çµé­‚è´¦æˆ·æ¨¡æ¿
const soulAccountTemplates = [
  SoulAccountTemplate(
    name: 'é«˜è¾¾åŸºé‡‘',
    icon: 'ğŸ¤–',
    color: '#FF8C42',
    suggestedBudget: 30000,
  ),
  SoulAccountTemplate(
    name: 'ç¾å¦†åŸºé‡‘',
    icon: 'ğŸ’…',
    color: '#E91E63',
    suggestedBudget: 20000,
  ),
  SoulAccountTemplate(
    name: 'æ—…è¡ŒåŸºé‡‘',
    icon: 'âœˆï¸',
    color: '#00BCD4',
    suggestedBudget: 50000,
  ),
  SoulAccountTemplate(
    name: 'å­¦ä¹ æˆé•¿',
    icon: 'ğŸ“š',
    color: '#3F51B5',
    suggestedBudget: 15000,
  ),
  SoulAccountTemplate(
    name: 'æ¸¸æˆå¨±ä¹',
    icon: 'ğŸ®',
    color: '#9C27B0',
    suggestedBudget: 25000,
  ),
];
```

---

### 2.3 çµé­‚æ¶ˆè´¹åº†ç¥åŠ¨ç”»ï¼ˆC04ï¼‰

#### 2.3.1 è§¦å‘æ¡ä»¶

```dart
// lib/features/dual_ledger/domain/use_cases/trigger_celebration.dart

class TriggerCelebrationUseCase {
  Future<bool> shouldCelebrate(Transaction tx) async {
    // æ¡ä»¶1: äº¤æ˜“ç±»å‹ä¸ºæ”¯å‡º
    if (tx.type != TransactionType.expense) {
      return false;
    }

    // æ¡ä»¶2: è´¦æˆ·ç±»å‹ä¸ºçµé­‚
    if (tx.ledgerType != LedgerType.soul) {
      return false;
    }

    // æ¡ä»¶3: ç”¨æˆ·æœªå…³é—­åº†ç¥åŠ¨ç”»
    final settings = await _settingsRepo.getSettings();
    if (!settings.enableCelebration) {
      return false;
    }

    // æ¡ä»¶4: ä¸è¦åœ¨ä¿®æ­£äº¤æ˜“æ—¶åº†ç¥
    if (tx.type == TransactionType.correction) {
      return false;
    }

    return true;
  }
}
```

#### 2.3.2 åŠ¨ç”»æ•ˆæœ

**æŠ€æœ¯å®ç°ï¼ˆä½¿ç”¨Lottieï¼‰:**

```dart
// lib/features/dual_ledger/presentation/widgets/soul_celebration_animation.dart

class SoulCelebrationAnimation extends StatefulWidget {
  final int amount;
  final VoidCallback onComplete;

  const SoulCelebrationAnimation({
    required this.amount,
    required this.onComplete,
  });

  @override
  State<SoulCelebrationAnimation> createState() => _SoulCelebrationAnimationState();
}

class _SoulCelebrationAnimationState extends State<SoulCelebrationAnimation>
    with SingleTickerProviderStateMixin {
  late AnimationController _controller;
  late String _message;

  @override
  void initState() {
    super.initState();
    _controller = AnimationController(
      vsync: this,
      duration: Duration(seconds: 2),
    );

    _message = _selectMessage();
    _controller.forward().then((_) {
      Future.delayed(Duration(milliseconds: 500), widget.onComplete);
    });
  }

  @override
  Widget build(BuildContext context) {
    return GestureDetector(
      onTap: widget.onComplete,  // ç‚¹å‡»è·³è¿‡
      child: Container(
        color: Colors.black.withOpacity(0.5),
        child: Stack(
          children: [
            // ç²’å­çˆ†å‘æ•ˆæœ
            Center(
              child: Lottie.asset(
                'assets/animations/particle_burst.json',
                controller: _controller,
                width: 300,
                height: 300,
              ),
            ),

            // å½©è™¹å…‰æ™•
            Center(
              child: AnimatedBuilder(
                animation: _controller,
                builder: (context, child) {
                  return Container(
                    width: 200 * _controller.value,
                    height: 200 * _controller.value,
                    decoration: BoxDecoration(
                      shape: BoxShape.circle,
                      gradient: RadialGradient(
                        colors: [
                          Colors.pink.withOpacity(0.5 * (1 - _controller.value)),
                          Colors.purple.withOpacity(0.3 * (1 - _controller.value)),
                          Colors.transparent,
                        ],
                      ),
                    ),
                  );
                },
              ),
            ),

            // æ­£å‘æ–‡æ¡ˆ
            Center(
              child: FadeTransition(
                opacity: Tween<double>(begin: 0, end: 1).animate(
                  CurvedAnimation(
                    parent: _controller,
                    curve: Interval(0.3, 0.6, curve: Curves.easeIn),
                  ),
                ),
                child: Column(
                  mainAxisSize: MainAxisSize.min,
                  children: [
                    Text(
                      _message,
                      style: TextStyle(
                        fontSize: 28,
                        fontWeight: FontWeight.bold,
                        color: Colors.white,
                        shadows: [
                          Shadow(
                            color: Colors.pink,
                            blurRadius: 10,
                          ),
                        ],
                      ),
                    ),
                    SizedBox(height: 16),
                    Text(
                      'Â¥${_formatAmount(widget.amount)}',
                      style: TextStyle(
                        fontSize: 36,
                        fontWeight: FontWeight.bold,
                        color: Colors.white,
                      ),
                    ),
                  ],
                ),
              ),
            ),

            // è·³è¿‡æç¤º
            Positioned(
              bottom: 40,
              left: 0,
              right: 0,
              child: Center(
                child: Text(
                  'ã‚¿ãƒƒãƒ—ã—ã¦ã‚¹ã‚­ãƒƒãƒ—',
                  style: TextStyle(
                    fontSize: 14,
                    color: Colors.white70,
                  ),
                ),
              ),
            ),
          ],
        ),
      ),
    );
  }

  String _selectMessage() {
    final messages = [
      'ç²¾ç¥èµ„äº§ +1 ğŸ’–',
      'å¿«ä¹å€¼å……èƒ½ä¸­ âš¡',
      'çµé­‚æ»¡è¶³åº¦ UP âœ¨',
      'è¿™æ˜¯å¯¹è‡ªå·±çš„æŠ•èµ„ï¼ğŸ‰',
      'ç”Ÿæ´»éœ€è¦ä¸€äº›å°ç¡®å¹¸ ğŸŒŸ',
      'ä»Šæ—¥ã®è‡ªåˆ†ã¸ã®ã”è¤’ç¾ âœ¨',
      'å¿ƒã‚’æº€ãŸã™æ™‚é–“ ğŸ’«',
      'ã‚½ã‚¦ãƒ«å……é›»ä¸­ âš¡',
    ];

    return messages[Random().nextInt(messages.length)];
  }

  String _formatAmount(int amount) {
    final formatter = NumberFormat('#,###', 'ja_JP');
    return formatter.format(amount);
  }

  @override
  void dispose() {
    _controller.dispose();
    super.dispose();
  }
}
```

**LottieåŠ¨ç”»æ–‡ä»¶ï¼ˆparticle_burst.jsonï¼‰:**
- ä½¿ç”¨LottieFilesç¤¾åŒºåŠ¨ç”»,æˆ–è‡ªå®šä¹‰åˆ›å»º
- æ¨èåŠ¨ç”»: "Confetti", "Stars Burst", "Heart Particles"
- æ–‡ä»¶å¤§å°: <100KB
- å¸§ç‡: 30fps
- æ—¶é•¿: 2ç§’

#### 2.3.3 æ–‡æ¡ˆåº“ï¼ˆOTAçƒ­æ›´æ–°ï¼‰

```json
{
  "version": "1.0.0",
  "celebration_messages": [
    {
      "id": "msg_001",
      "text_ja": "ç²¾ç¥è³‡ç”£ +1 ğŸ’–",
      "text_cn": "ç²¾ç¥èµ„äº§ +1 ğŸ’–",
      "weight": 1.0
    },
    {
      "id": "msg_002",
      "text_ja": "ãƒãƒƒãƒ”ãƒ¼å……é›»ä¸­ âš¡",
      "text_cn": "å¿«ä¹å€¼å……èƒ½ä¸­ âš¡",
      "weight": 1.0
    },
    {
      "id": "msg_003",
      "text_ja": "é­‚ã®æº€è¶³åº¦ UP âœ¨",
      "text_cn": "çµé­‚æ»¡è¶³åº¦ UP âœ¨",
      "weight": 1.0
    },
    {
      "id": "msg_004",
      "text_ja": "ã“ã‚Œã¯è‡ªåˆ†ã¸ã®æŠ•è³‡ï¼ğŸ‰",
      "text_cn": "è¿™æ˜¯å¯¹è‡ªå·±çš„æŠ•èµ„ï¼ğŸ‰",
      "weight": 0.8
    },
    {
      "id": "msg_005",
      "text_ja": "äººç”Ÿã«ã¯å°ç¢ºå¹¸ãŒå¿…è¦ ğŸŒŸ",
      "text_cn": "ç”Ÿæ´»éœ€è¦ä¸€äº›å°ç¡®å¹¸ ğŸŒŸ",
      "weight": 0.8
    },
    {
      "id": "msg_006",
      "text_ja": "ä»Šæ—¥ã®è‡ªåˆ†ã¸ã®ã”è¤’ç¾ âœ¨",
      "text_cn": "ä»Šæ—¥çš„è‡ªæˆ‘å¥–åŠ± âœ¨",
      "weight": 1.0
    },
    {
      "id": "msg_007",
      "text_ja": "å¿ƒã‚’æº€ãŸã™æ™‚é–“ ğŸ’«",
      "text_cn": "å……ç›ˆå†…å¿ƒçš„æ—¶åˆ» ğŸ’«",
      "weight": 0.9
    },
    {
      "id": "msg_008",
      "text_ja": "ã‚½ã‚¦ãƒ«å……é›»å®Œäº† âš¡",
      "text_cn": "çµé­‚å……ç”µå®Œæˆ âš¡",
      "weight": 1.0
    }
  ]
}
```

---

### 2.4 UIå·®å¼‚åŒ–è®¾è®¡

#### 2.4.1 ç”Ÿå­˜è´¦æˆ·è§†è§‰è®¾è®¡ï¼ˆå’Œé£æ²»æ„ˆï¼‰

**è®¾è®¡è§„èŒƒ:**

| å…ƒç´  | è§„èŒƒ |
|------|------|
| ä¸»è‰²è°ƒ | å†·é™è“ #4A90D9 |
| æ¬¡è‰²è°ƒ | ç°è“ #607D8B |
| å›¾æ ‡ | ğŸ ï¼ˆæˆ¿å±‹ï¼‰|
| å­—ä½“ | Noto Sans JP Regular |
| å¡ç‰‡èƒŒæ™¯ | #F5F5F5ï¼ˆæµ…ç°ï¼‰|
| è¾¹æ¡† | 1px solid #E0E0E0 |
| åœ†è§’ | 12px |

**è¿›åº¦æ¡æ ·å¼:**

```dart
// çº¢ç»¿ç¯é¢„è­¦å¼è¿›åº¦æ¡
class SurvivalProgressBar extends StatelessWidget {
  final int spent;  // å·²èŠ±è´¹
  final int budget; // é¢„ç®—

  Color _getColor() {
    final ratio = spent / budget;
    if (ratio < 0.7) return Colors.green;      // å®‰å…¨
    if (ratio < 0.9) return Colors.orange;     // è­¦å‘Š
    return Colors.red;                         // è¶…æ”¯
  }

  @override
  Widget build(BuildContext context) {
    final ratio = (spent / budget).clamp(0.0, 1.0);

    return Column(
      crossAxisAlignment: CrossAxisAlignment.start,
      children: [
        Row(
          mainAxisAlignment: MainAxisAlignment.spaceBetween,
          children: [
            Text('ç”Ÿå­˜æˆæœ¬', style: TextStyle(fontSize: 16, color: Color(0xFF4A90D9))),
            Text(
              'Â¥${_formatAmount(spent)} / Â¥${_formatAmount(budget)}',
              style: TextStyle(fontSize: 14, color: Colors.grey[700]),
            ),
          ],
        ),
        SizedBox(height: 8),
        LinearProgressIndicator(
          value: ratio,
          backgroundColor: Colors.grey[300],
          valueColor: AlwaysStoppedAnimation(_getColor()),
          minHeight: 8,
        ),
        if (spent > budget)
          Padding(
            padding: EdgeInsets.only(top: 8),
            child: Row(
              children: [
                Icon(Icons.warning, size: 16, color: Colors.red),
                SizedBox(width: 4),
                Text(
                  'âš ï¸ æœ¬æœˆè¶…æ”¯ Â¥${_formatAmount(spent - budget)}',
                  style: TextStyle(fontSize: 12, color: Colors.red),
                ),
              ],
            ),
          ),
      ],
    );
  }
}
```

**æœˆæŠ¥æ ‡é¢˜:**
- æ—¥æ–‡: "ç”Ÿå­˜ã‚³ã‚¹ãƒˆå ±å‘Š"
- ä¸­æ–‡: "ç”Ÿå­˜æˆæœ¬æŠ¥å‘Š"

#### 2.4.2 çµé­‚è´¦æˆ·è§†è§‰è®¾è®¡ï¼ˆèµ›åšå¯çˆ±ï¼‰

**è®¾è®¡è§„èŒƒ:**

| å…ƒç´  | è§„èŒƒ |
|------|------|
| ä¸»è‰²è°ƒ | æ´»åŠ›æ©™ #FF8C42 |
| æ¬¡è‰²è°ƒ | ç²‰ç´« #E91E63 |
| å›¾æ ‡ | ğŸ’–ï¼ˆå¿ƒå½¢ï¼‰|
| å­—ä½“ | Noto Sans JP Medium |
| å¡ç‰‡èƒŒæ™¯ | æ¸å˜ï¼ˆ#FF8C42 â†’ #FF6F61ï¼‰|
| è¾¹æ¡† | æ—  |
| åœ†è§’ | 16px |

**è¿›åº¦æ¡æ ·å¼:**

```dart
// å¿«ä¹å€¼å……èƒ½æ¡
class SoulProgressBar extends StatelessWidget {
  final int spent;  // å·²èŠ±è´¹
  final int budget; // é¢„ç®—

  @override
  Widget build(BuildContext context) {
    final ratio = (spent / budget).clamp(0.0, 1.2);  // å…è®¸è¶…è¿‡100%æ˜¾ç¤º

    return Container(
      decoration: BoxDecoration(
        gradient: LinearGradient(
          colors: [Color(0xFFFF8C42), Color(0xFFFF6F61)],
        ),
        borderRadius: BorderRadius.circular(16),
      ),
      padding: EdgeInsets.all(16),
      child: Column(
        crossAxisAlignment: CrossAxisAlignment.start,
        children: [
          Row(
            mainAxisAlignment: MainAxisAlignment.spaceBetween,
            children: [
              Row(
                children: [
                  Text('ğŸ’–', style: TextStyle(fontSize: 24)),
                  SizedBox(width: 8),
                  Text(
                    'çµé­‚è´¦æˆ·',
                    style: TextStyle(
                      fontSize: 18,
                      fontWeight: FontWeight.bold,
                      color: Colors.white,
                    ),
                  ),
                ],
              ),
              Text(
                'Â¥${_formatAmount(spent)}',
                style: TextStyle(
                  fontSize: 20,
                  fontWeight: FontWeight.bold,
                  color: Colors.white,
                ),
              ),
            ],
          ),
          SizedBox(height: 12),
          Stack(
            children: [
              // èƒŒæ™¯æ¡
              Container(
                height: 12,
                decoration: BoxDecoration(
                  color: Colors.white.withOpacity(0.3),
                  borderRadius: BorderRadius.circular(6),
                ),
              ),
              // å……èƒ½æ¡ï¼ˆå¸¦é—ªçƒæ•ˆæœï¼‰
              FractionallySizedBox(
                widthFactor: ratio,
                child: Container(
                  height: 12,
                  decoration: BoxDecoration(
                    gradient: LinearGradient(
                      colors: [
                        Colors.yellow,
                        Colors.pink,
                        Colors.purple,
                      ],
                    ),
                    borderRadius: BorderRadius.circular(6),
                    boxShadow: [
                      BoxShadow(
                        color: Colors.pink.withOpacity(0.5),
                        blurRadius: 8,
                      ),
                    ],
                  ),
                ),
              ),
            ],
          ),
          SizedBox(height: 8),
          if (spent > budget)
            Text(
              'âœ¨ çµé­‚å¤ªè¿‡å……å®äº†å‘¢ï½',
              style: TextStyle(
                fontSize: 12,
                color: Colors.white,
                fontStyle: FontStyle.italic,
              ),
            )
          else
            Text(
              'æ®‹ã‚Š Â¥${_formatAmount(budget - spent)}',
              style: TextStyle(
                fontSize: 12,
                color: Colors.white70,
              ),
            ),
        ],
      ),
    );
  }
}
```

**æœˆæŠ¥æ ‡é¢˜:**
- æ—¥æ–‡: "ã‚½ã‚¦ãƒ«è¼ãå ±å‘Š"
- ä¸­æ–‡: "çµé­‚é—ªè€€æŠ¥å‘Š"

#### 2.4.3 é¦–é¡µåŒè½¨å¡ç‰‡å¸ƒå±€

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Home Pocket            â˜°          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                     â”‚
â”‚  ä»Šæœˆã®æ”¯å‡º                          â”‚
â”‚  Â¥185,400                           â”‚
â”‚  â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”      â”‚
â”‚                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚
â”‚  â”‚ ğŸ  ç”Ÿå­˜è´¦æˆ·               â”‚      â”‚  â† å’Œé£å¡ç‰‡
â”‚  â”‚ Â¥155,400 / Â¥180,000      â”‚      â”‚
â”‚  â”‚ â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘ 86%           â”‚      â”‚
â”‚  â”‚                          â”‚      â”‚
â”‚  â”‚ é£Ÿè²»      Â¥45,000        â”‚      â”‚
â”‚  â”‚ ä½å®…      Â¥80,000        â”‚      â”‚
â”‚  â”‚ äº¤é€šè²»    Â¥15,000        â”‚      â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚
â”‚                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚
â”‚  â”‚ ğŸ’– é«˜è¾¾åŸºé‡‘               â”‚      â”‚  â† èµ›åšå¡ç‰‡ï¼ˆæ¸å˜èƒŒæ™¯ï¼‰
â”‚  â”‚ Â¥30,000 / Â¥30,000        â”‚      â”‚
â”‚  â”‚ â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ 100%        â”‚      â”‚
â”‚  â”‚                          â”‚      â”‚
â”‚  â”‚ è¶£å‘³      Â¥21,100        â”‚      â”‚
â”‚  â”‚ å¤–é£Ÿ      Â¥8,900         â”‚      â”‚
â”‚  â”‚ [æŸ¥çœ‹æ˜ç»† â†’]              â”‚      â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚
â”‚                                     â”‚
â”‚  [â• æ–°å¢è®°å½•]                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

### 2.5 å®¶åº­æ¨¡å¼ä¸‹çš„éšç§è®¾è®¡

#### 2.5.1 ä¼´ä¾£è§†å›¾é™åˆ¶

**è§„åˆ™:**
- ä¼´ä¾£å¯ä»¥çœ‹åˆ°:çµé­‚è´¦æˆ·çš„é¢„ç®—è¿›åº¦ï¼ˆå·²èŠ±è´¹/é¢„ç®—ï¼‰
- ä¼´ä¾£ä¸èƒ½çœ‹åˆ°:çµé­‚è´¦æˆ·çš„å…·ä½“äº¤æ˜“æ˜ç»†
- ç›®çš„:é¿å…"ä¹°äº†ä»€ä¹ˆ"å¼•å‘äº‰æ‰§,åªå…³æ³¨"èŠ±äº†å¤šå°‘"

**UIå®ç°:**

```dart
// lib/features/dual_ledger/presentation/widgets/soul_account_partner_view.dart

class SoulAccountPartnerView extends ConsumerWidget {
  final String partnerDeviceId;

  @override
  Widget build(BuildContext context, WidgetRef ref) {
    final soulSummary = ref.watch(partnerSoulSummaryProvider(partnerDeviceId));

    return Container(
      padding: EdgeInsets.all(16),
      decoration: BoxDecoration(
        gradient: LinearGradient(
          colors: [Color(0xFFFF8C42), Color(0xFFFF6F61)],
        ),
        borderRadius: BorderRadius.circular(16),
      ),
      child: Column(
        crossAxisAlignment: CrossAxisAlignment.start,
        children: [
          Row(
            children: [
              Text(
                soulSummary.iconEmoji ?? 'ğŸ’–',
                style: TextStyle(fontSize: 32),
              ),
              SizedBox(width: 12),
              Expanded(
                child: Column(
                  crossAxisAlignment: CrossAxisAlignment.start,
                  children: [
                    Text(
                      '${soulSummary.ownerName}ã®${soulSummary.soulName ?? 'çµé­‚è´¦æˆ·'}',
                      style: TextStyle(
                        fontSize: 18,
                        fontWeight: FontWeight.bold,
                        color: Colors.white,
                      ),
                    ),
                    Text(
                      'ä»Šæœˆã®æ”¯å‡º',
                      style: TextStyle(
                        fontSize: 12,
                        color: Colors.white70,
                      ),
                    ),
                  ],
                ),
              ),
            ],
          ),
          SizedBox(height: 16),
          // è¿›åº¦æ¡ï¼ˆä¸æ˜¾ç¤ºå…·ä½“é‡‘é¢,åªæ˜¾ç¤ºç™¾åˆ†æ¯”ï¼‰
          LinearProgressIndicator(
            value: soulSummary.progressRatio,
            backgroundColor: Colors.white.withOpacity(0.3),
            valueColor: AlwaysStoppedAnimation(Colors.yellow),
            minHeight: 8,
          ),
          SizedBox(height: 8),
          Row(
            mainAxisAlignment: MainAxisAlignment.spaceBetween,
            children: [
              Text(
                '${(soulSummary.progressRatio * 100).toInt()}% ä½¿ç”¨æ¸ˆã¿',
                style: TextStyle(color: Colors.white, fontSize: 14),
              ),
              // ğŸ”’ ä¸æ˜¾ç¤ºå…·ä½“é‡‘é¢
              Icon(Icons.lock, size: 16, color: Colors.white70),
            ],
          ),
          SizedBox(height: 12),
          Text(
            'ğŸ’¡ è¯¦ç»†ä¿¡æ¯å—éšç§ä¿æŠ¤',
            style: TextStyle(
              fontSize: 12,
              color: Colors.white70,
              fontStyle: FontStyle.italic,
            ),
          ),
        ],
      ),
    );
  }
}
```

**æ•°æ®æŸ¥è¯¢ï¼ˆéšç§è¿‡æ»¤ï¼‰:**

```dart
// lib/features/dual_ledger/domain/use_cases/get_partner_soul_summary.dart

class GetPartnerSoulSummaryUseCase {
  Future<SoulSummary> execute(String partnerDeviceId) async {
    final config = await _configRepo.getByDeviceId(partnerDeviceId);

    // åªè¿”å›æ±‡æ€»æ•°æ®,ä¸è¿”å›äº¤æ˜“æ˜ç»†
    final totalSpent = await _transactionRepo.sumByLedgerType(
      deviceId: partnerDeviceId,
      ledgerType: LedgerType.soul,
      month: DateTime.now().month,
      year: DateTime.now().year,
    );

    return SoulSummary(
      ownerName: config.ownerName,
      soulName: config.soulName,
      iconEmoji: config.iconEmoji,
      monthlyBudget: config.monthlyBudget,
      totalSpent: totalSpent,  // åªæœ‰æ€»é¢
      transactions: [],        // æ˜ç»†ä¸ºç©ºï¼
      progressRatio: config.monthlyBudget > 0
          ? (totalSpent / config.monthlyBudget).clamp(0.0, 1.0)
          : 0.0,
    );
  }
}
```

---

## 3. æ•°æ®æ¨¡å‹è®¾è®¡

### 3.1 Driftè¡¨å®šä¹‰

```dart
// lib/core/database/tables.dart

@DataClassName('TransactionData')
class Transactions extends Table {
  TextColumn get id => text()();
  TextColumn get bookId => text()();
  TextColumn get deviceId => text()();
  IntColumn get amount => integer()();
  TextColumn get type => text()();  // 'expense' | 'income' | 'transfer'
  TextColumn get categoryId => text()();

  // åŒè½¨è´¦æœ¬å­—æ®µ
  TextColumn get ledgerType => text()();  // 'survival' | 'soul'
  RealColumn get classificationConfidence => real().nullable()();  // åˆ†ç±»ç½®ä¿¡åº¦
  TextColumn get classificationSource => text().nullable()();  // 'rule' | 'merchant' | 'ml' | 'user'

  IntColumn get timestamp => integer()();
  TextColumn get note => text().nullable()();
  TextColumn get photoHash => text().nullable()();
  TextColumn get prevHash => text().nullable()();
  TextColumn get currentHash => text()();
  IntColumn get createdAt => integer()();
  BoolColumn get isPrivate => boolean().withDefault(const Constant(false))();

  @override
  Set<Column> get primaryKey => {id};
}

@DataClassName('SoulAccountConfigData')
class SoulAccountConfigs extends Table {
  TextColumn get id => text()();
  TextColumn get bookId => text()();
  TextColumn get deviceId => text()();
  TextColumn get soulName => text().nullable()();
  TextColumn get iconEmoji => text().nullable()();
  TextColumn get colorHex => text().nullable()();
  IntColumn get monthlyBudget => integer().nullable()();
  BoolColumn get alertAt80Percent => boolean().withDefault(const Constant(true))();
  BoolColumn get alertAt100Percent => boolean().withDefault(const Constant(false))();
  IntColumn get createdAt => integer()();
  IntColumn get updatedAt => integer()();

  @override
  Set<Column> get primaryKey => {id};
}

// åˆ†ç±»è§„åˆ™è¦†ç›–è¡¨ï¼ˆç”¨æˆ·æ‰‹åŠ¨ä¿®æ”¹çš„è§„åˆ™ï¼‰
@DataClassName('CategoryLedgerOverrideData')
class CategoryLedgerOverrides extends Table {
  TextColumn get id => text()();
  TextColumn get bookId => text()();
  TextColumn get categoryId => text()();
  TextColumn get ledgerType => text()();  // ç”¨æˆ·è¦†ç›–çš„è´¦æˆ·ç±»å‹
  IntColumn get createdAt => integer()();

  @override
  Set<Column> get primaryKey => {id};
}
```

### 3.2 å®ä½“å…³ç³»å›¾ï¼ˆERDï¼‰

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Transactions      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ id (PK)             â”‚
â”‚ bookId              â”‚â”€â”€â”
â”‚ categoryId          â”‚  â”‚
â”‚ ledgerType          â”‚  â”‚  å…³è”
â”‚ classification...   â”‚  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
                         â”‚
                         â†“
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”‚   Categories         â”‚
              â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
              â”‚ id (PK)              â”‚
              â”‚ bookId               â”‚
              â”‚ ledgerType           â”‚  â† é»˜è®¤è§„åˆ™
              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
                         â”‚  å¯è¢«è¦†ç›–
                         â†“
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”‚ CategoryLedger...    â”‚
              â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
              â”‚ categoryId (FK)      â”‚
              â”‚ ledgerType           â”‚  â† ç”¨æˆ·è¦†ç›–
              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ SoulAccountConfigs  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ id (PK)             â”‚
â”‚ bookId              â”‚
â”‚ deviceId            â”‚  â† æ¯ä¸ªè®¾å¤‡ä¸€ä¸ªé…ç½®
â”‚ soulName            â”‚
â”‚ iconEmoji           â”‚
â”‚ monthlyBudget       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 3.3 ç´¢å¼•è®¾è®¡

```dart
// æŸ¥è¯¢ä¼˜åŒ–ç´¢å¼•
@DataClassName('TransactionData')
class Transactions extends Table {
  // ... åˆ—å®šä¹‰ ...

  @override
  List<Set<Column>> get customIndexes => [
    // æŒ‰è´¦æˆ·ç±»å‹å’Œæ—¶é—´æŸ¥è¯¢
    {bookId, ledgerType, timestamp},

    // æŒ‰è®¾å¤‡å’Œè´¦æˆ·ç±»å‹æŸ¥è¯¢ï¼ˆå®¶åº­æ¨¡å¼ï¼‰
    {bookId, deviceId, ledgerType, timestamp},

    // æœˆåº¦æ±‡æ€»æŸ¥è¯¢
    {bookId, ledgerType, timestamp},
  ];
}
```

---

## 4. UI/UXè®¾è®¡

### 4.1 äº¤æ˜“å½•å…¥é¡µé¢ï¼ˆæ”¯æŒæ‰‹åŠ¨åˆ‡æ¢è´¦æˆ·ï¼‰

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ â† æ–°å¢æ”¯å‡º                     ä¿å­˜ â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚         Â¥  2,110            â”‚   â”‚
â”‚  â”‚         â”â”â”â”â”â”â”             â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                     â”‚
â”‚  åˆ†ç±»ï¼šğŸ® è¶£å‘³                      â”‚
â”‚                                     â”‚
â”‚  è´¦æˆ·ç±»å‹ï¼š                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚
â”‚  â”‚ ğŸ  ç”Ÿå­˜  â”‚  â”‚ ğŸ’– çµé­‚  â”‚ â†      â”‚  è‡ªåŠ¨æ¨èï¼ˆé«˜äº®ï¼‰
â”‚  â”‚          â”‚  â”‚   âœ“      â”‚        â”‚  ç”¨æˆ·å¯æ‰‹åŠ¨åˆ‡æ¢
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚
â”‚                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ âš™ï¸ è‡ªåŠ¨åˆ¤æ–­ï¼ˆç½®ä¿¡åº¦ 95%ï¼‰   â”‚   â”‚  æ˜¾ç¤ºåˆ†ç±»ä¾æ®
â”‚  â”‚ æ¥æºï¼šåˆ†ç±»è§„åˆ™               â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                     â”‚
â”‚  å¤‡æ³¨ï¼š                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚ HG 1/144 ã‚¶ã‚¯ II           â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                     â”‚
â”‚  [ğŸ“· æ‹ç…§]                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**äº¤äº’æµç¨‹:**
1. ç”¨æˆ·è¾“å…¥é‡‘é¢å’Œåˆ†ç±»
2. ç³»ç»Ÿè‡ªåŠ¨åˆ¤æ–­è´¦æˆ·ç±»å‹ï¼ˆé«˜äº®æ˜¾ç¤ºï¼‰
3. æ˜¾ç¤ºåˆ†ç±»ä¾æ®å’Œç½®ä¿¡åº¦
4. ç”¨æˆ·å¯æ‰‹åŠ¨åˆ‡æ¢ï¼ˆç‚¹å‡»å¦ä¸€ä¸ªæŒ‰é’®ï¼‰
5. ä¿å­˜æ—¶è®°å½•`classificationSource = 'user'`

### 4.2 äº¤æ˜“åˆ—è¡¨é¡µé¢ï¼ˆåŒæ ‡ç­¾å±•ç¤ºï¼‰

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Home Pocket            â˜°          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  [å…¨éƒ¨] [ç”Ÿå­˜ğŸ ] [çµé­‚ğŸ’–] [æ”¶å…¥ğŸ’°]  â”‚  â† æ ‡ç­¾è¿‡æ»¤
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                     â”‚
â”‚  ä»Šæ—¥  2/3                 Â¥3,390   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ ğŸš é£Ÿè²»ï¼ˆå¤–é£Ÿï¼‰  Â¥1,280  ğŸ’–  â”‚  â”‚  â† çµé­‚æ ‡è®°
â”‚  â”‚ åˆé¤ @ å‰é‡å®¶                â”‚  â”‚
â”‚  â”‚ 14:30                         â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ ğŸ® è¶£å‘³          Â¥2,110  ğŸ’–  â”‚  â”‚
â”‚  â”‚ HG ã‚¶ã‚¯ II                   â”‚  â”‚
â”‚  â”‚ 11:20                 [ç…§ç‰‡]  â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  æ˜¨æ—¥  2/2                Â¥12,580   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ ğŸ  ä½å®…          Â¥80,000 ğŸ   â”‚  â”‚  â† ç”Ÿå­˜æ ‡è®°
â”‚  â”‚ 2æœˆä»½æˆ¿ç§Ÿ                    â”‚  â”‚
â”‚  â”‚ 09:00                         â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ ğŸ›’ é£Ÿè²»ï¼ˆè¶…å¸‚ï¼‰  Â¥5,800  ğŸ   â”‚  â”‚
â”‚  â”‚ ã‚¤ã‚ªãƒ³                       â”‚  â”‚
â”‚  â”‚ 18:30                         â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 4.3 æœˆåº¦æŠ¥è¡¨é¡µé¢ï¼ˆåŒè½¨å¯¹æ¯”ï¼‰

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ â† 2æœˆæŠ¥è¡¨                  [å¯¼å‡ºPDF]â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                     â”‚
â”‚  æ€»æ”¯å‡ºï¼šÂ¥185,400                   â”‚
â”‚  â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”      â”‚
â”‚                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ ç”Ÿå­˜æˆæœ¬æŠ¥å‘Š                 â”‚   â”‚
â”‚  â”‚ â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”   â”‚   â”‚
â”‚  â”‚                             â”‚   â”‚
â”‚  â”‚ æ€»è®¡ï¼šÂ¥155,400              â”‚   â”‚
â”‚  â”‚ é¢„ç®—ï¼šÂ¥180,000              â”‚   â”‚
â”‚  â”‚ å‰©ä½™ï¼šÂ¥24,600               â”‚   â”‚
â”‚  â”‚                             â”‚   â”‚
â”‚  â”‚ [é¥¼å›¾]                      â”‚   â”‚
â”‚  â”‚  ä½å®…    51%  Â¥80,000       â”‚   â”‚
â”‚  â”‚  é£Ÿè²»    29%  Â¥45,000       â”‚   â”‚
â”‚  â”‚  äº¤é€š    10%  Â¥15,000       â”‚   â”‚
â”‚  â”‚  å…¶ä»–    10%  Â¥15,400       â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ ğŸ’– çµé­‚é—ªè€€æŠ¥å‘Š              â”‚   â”‚  â† æ¸å˜èƒŒæ™¯
â”‚  â”‚ â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”   â”‚   â”‚
â”‚  â”‚                             â”‚   â”‚
â”‚  â”‚ æ€»è®¡ï¼šÂ¥30,000               â”‚   â”‚
â”‚  â”‚ é¢„ç®—ï¼šÂ¥30,000               â”‚   â”‚
â”‚  â”‚ çµé­‚æ»¡è¶³åº¦ï¼š100% âœ¨         â”‚   â”‚
â”‚  â”‚                             â”‚   â”‚
â”‚  â”‚ [é¥¼å›¾]                      â”‚   â”‚
â”‚  â”‚  è¶£å‘³    70%  Â¥21,100       â”‚   â”‚
â”‚  â”‚  å¤–é£Ÿ    30%  Â¥8,900        â”‚   â”‚
â”‚  â”‚                             â”‚   â”‚
â”‚  â”‚ æœ¬æœˆç²¾ç¥èµ„äº§æŠ•èµ„å›æŠ¥ï¼š      â”‚   â”‚
â”‚  â”‚ ğŸ¤– é«˜è¾¾æ¨¡å‹ x3              â”‚   â”‚
â”‚  â”‚ ğŸœ ç¾é£Ÿä½“éªŒ x5              â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                     â”‚
â”‚  [æŸ¥çœ‹è¯¦ç»†åˆ†æ]                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 5. æŠ€æœ¯å®ç°æ–¹æ¡ˆ

### 5.1 æ ¸å¿ƒç®—æ³•ä¼ªä»£ç 

```
ç®—æ³•: åŒè½¨è´¦æœ¬è‡ªåŠ¨åˆ†ç±»
è¾“å…¥: Transaction tx
è¾“å‡º: ClassificationResult

function classifyTransaction(tx):
    # Layer 1: è§„åˆ™å¼•æ“
    ruleResult = RuleEngine.classify(tx.categoryId)
    if ruleResult.confidence >= 0.95:
        return ruleResult

    # Layer 2: å•†å®¶æ•°æ®åº“
    if tx.note != null:
        merchant = extractMerchant(tx.note)
        if merchant != null:
            merchantResult = MerchantDB.lookup(merchant)
            if merchantResult.confidence >= 0.8:
                return merchantResult

    # Layer 3: TF Liteæ¨¡å‹
    mlResult = TFLiteModel.predict(tx)

    # ä½ç½®ä¿¡åº¦éœ€è¦ç”¨æˆ·ç¡®è®¤
    if mlResult.confidence < 0.7:
        mlResult.needsConfirmation = true

    return mlResult

function extractMerchant(note):
    patterns = ["@ (\w+)", "(\w+)ã§"]
    for pattern in patterns:
        match = regex.search(pattern, note)
        if match:
            return match.group(1)
    return null
```

### 5.2 çŠ¶æ€ç®¡ç†ï¼ˆRiverpodï¼‰

```dart
// lib/features/dual_ledger/presentation/providers/dual_ledger_providers.dart

// çµé­‚è´¦æˆ·é…ç½®
final soulAccountConfigProvider = StreamProvider.autoDispose<SoulAccountConfig>((ref) {
  final bookId = ref.watch(currentBookIdProvider);
  final deviceId = ref.watch(currentDeviceIdProvider);

  return ref.read(soulAccountConfigRepositoryProvider)
      .watchConfig(bookId: bookId, deviceId: deviceId);
});

// ç”Ÿå­˜è´¦æˆ·æœˆåº¦æ±‡æ€»
final survivalMonthlySummaryProvider = FutureProvider.autoDispose<MonthlySummary>((ref) async {
  final bookId = ref.watch(currentBookIdProvider);
  final now = DateTime.now();

  return ref.read(dualLedgerServiceProvider).getMonthlySummary(
    bookId: bookId,
    ledgerType: LedgerType.survival,
    year: now.year,
    month: now.month,
  );
});

// çµé­‚è´¦æˆ·æœˆåº¦æ±‡æ€»
final soulMonthlySummaryProvider = FutureProvider.autoDispose<MonthlySummary>((ref) async {
  final bookId = ref.watch(currentBookIdProvider);
  final now = DateTime.now();

  return ref.read(dualLedgerServiceProvider).getMonthlySummary(
    bookId: bookId,
    ledgerType: LedgerType.soul,
    year: now.year,
    month: now.month,
  );
});

// åˆ†ç±»å™¨
final classifierProvider = Provider<TransactionClassifier>((ref) {
  return TransactionClassifier(
    ruleClassifier: ref.read(ruleBasedClassifierProvider),
    merchantDB: ref.read(merchantDatabaseProvider),
    mlClassifier: ref.read(tfliteClassifierProvider),
  );
});
```

### 5.3 ç¬¬ä¸‰æ–¹åº“ä¾èµ–

```yaml
# pubspec.yaml

dependencies:
  # TensorFlow Lite
  tflite_flutter: ^0.10.4

  # åŠ¨ç”»
  lottie: ^3.1.0

  # æ•°å­—æ ¼å¼åŒ–
  intl: ^0.19.0

  # çŠ¶æ€ç®¡ç†
  flutter_riverpod: ^2.5.1

  # æ•°æ®åº“
  drift: ^2.16.0
  sqlite3_flutter_libs: ^0.5.20

  # åŠ å¯†
  cryptography: ^2.7.0
```

---

## 6. éªŒæ”¶æ ‡å‡†

### 6.1 åŠŸèƒ½å®Œæ•´æ€§

- âœ… æ‰€æœ‰äº¤æ˜“è‡ªåŠ¨åˆ†ç±»ä¸ºç”Ÿå­˜æˆ–çµé­‚è´¦æˆ·
- âœ… è§„åˆ™å¼•æ“è¦†ç›–20ä¸ªé¢„è®¾åˆ†ç±»,å‡†ç¡®ç‡100%
- âœ… å•†å®¶æ•°æ®åº“åŒ…å«è‡³å°‘500ä¸ªæ—¥æœ¬å•†å®¶
- âœ… TF Liteæ¨¡å‹å‡†ç¡®ç‡ >85%ï¼ˆåœ¨æµ‹è¯•é›†ä¸Šï¼‰
- âœ… ç”¨æˆ·å¯æ‰‹åŠ¨ä¿®æ”¹è‡ªåŠ¨åˆ†ç±»ç»“æœ
- âœ… çµé­‚æ¶ˆè´¹æ’­æ”¾2ç§’åº†ç¥åŠ¨ç”»ï¼ˆå¯è·³è¿‡ï¼‰
- âœ… ç”¨æˆ·å¯è‡ªå®šä¹‰çµé­‚è´¦æˆ·åç§°ã€å›¾æ ‡ã€é¢œè‰²
- âœ… å®¶åº­æ¨¡å¼ä¸‹,ä¼´ä¾£åªèƒ½çœ‹åˆ°çµé­‚é¢„ç®—è¿›åº¦,ä¸èƒ½çœ‹åˆ°æ˜ç»†

### 6.2 æ€§èƒ½æŒ‡æ ‡

| æŒ‡æ ‡ | ç›®æ ‡ | æµ‹è¯•æ–¹æ³• |
|------|------|---------|
| è‡ªåŠ¨åˆ†ç±»æ—¶é—´ | <100ms | å•ç¬”äº¤æ˜“,ä»ä¿å­˜åˆ°åˆ†ç±»å®Œæˆ |
| TF Liteæ¨ç†æ—¶é—´ | <50ms | è¿è¡Œ100æ¬¡å–å¹³å‡å€¼ |
| åº†ç¥åŠ¨ç”»æµç•…åº¦ | 60fps | ä½¿ç”¨Flutter DevToolsæ€§èƒ½ç›‘æ§ |
| æœˆæŠ¥ç”Ÿæˆæ—¶é—´ | <2s | 1000ç¬”äº¤æ˜“,ç”ŸæˆæŠ¥è¡¨ |
| å•†å®¶æŸ¥æ‰¾æ—¶é—´ | <10ms | ä»500+å•†å®¶ä¸­æŸ¥æ‰¾ |

### 6.3 ç”¨æˆ·ä½“éªŒæŒ‡æ ‡

- âœ… è‡ªåŠ¨åˆ†ç±»å‡†ç¡®ç‡ >90%ï¼ˆç”¨æˆ·æ‰‹åŠ¨ä¿®æ”¹ç‡<10%ï¼‰
- âœ… åº†ç¥åŠ¨ç”»å¥½è¯„ç‡ >80%ï¼ˆA/Bæµ‹è¯•ï¼‰
- âœ… çµé­‚è´¦æˆ·è®¾ç½®å®Œæˆç‡ >70%
- âœ… æœˆæŠ¥æŸ¥çœ‹ç‡ >50%

---

## 7. æµ‹è¯•ç”¨ä¾‹

### 7.1 å•å…ƒæµ‹è¯•

```dart
// test/features/dual_ledger/domain/classifiers/rule_based_classifier_test.dart

void main() {
  group('RuleBasedClassifier', () {
    late RuleBasedClassifier classifier;

    setUp(() {
      classifier = RuleBasedClassifier();
    });

    test('should classify food_groceries as survival', () {
      // Given
      final categoryId = 'food_groceries';

      // When
      final result = classifier.classify(categoryId: categoryId);

      // Then
      expect(result.ledgerType, LedgerType.survival);
      expect(result.confidence, 1.0);
      expect(result.source, ClassificationSource.ruleEngine);
    });

    test('should classify hobby as soul', () {
      // Given
      final categoryId = 'hobby';

      // When
      final result = classifier.classify(categoryId: categoryId);

      // Then
      expect(result.ledgerType, LedgerType.soul);
      expect(result.confidence, 1.0);
      expect(result.source, ClassificationSource.ruleEngine);
    });

    test('should return default survival for unknown category', () {
      // Given
      final categoryId = 'unknown_category';

      // When
      final result = classifier.classify(categoryId: categoryId);

      // Then
      expect(result.ledgerType, LedgerType.survival);
      expect(result.confidence, 0.5);
      expect(result.source, ClassificationSource.defaultRule);
    });

    test('should classify food_restaurant as soul with high confidence', () {
      // Given
      final categoryId = 'food_restaurant';

      // When
      final result = classifier.classify(categoryId: categoryId);

      // Then
      expect(result.ledgerType, LedgerType.soul);
      expect(result.confidence, 0.95);
    });

    test('should classify medical as survival', () {
      // Given
      final categoryId = 'medical';

      // When
      final result = classifier.classify(categoryId: categoryId);

      // Then
      expect(result.ledgerType, LedgerType.survival);
      expect(result.confidence, 1.0);
    });
  });

  group('MerchantDatabase', () {
    late MerchantDatabase db;

    setUp(() {
      db = MerchantDatabase();
    });

    test('should find merchant by exact name', () {
      // Given
      final merchantName = 'å‰é‡å®¶';

      // When
      final result = db.findMerchant(merchantName);

      // Then
      expect(result, isNotNull);
      expect(result!.ledgerType, LedgerType.soul);
      expect(result.category, 'food_restaurant');
      expect(result.confidence, 0.95);
    });

    test('should extract merchant from note with @ pattern', () {
      // Given
      final note = 'åˆé¤ @ å‰é‡å®¶';

      // When
      final merchant = db.extractMerchantFromNote(note);

      // Then
      expect(merchant, 'å‰é‡å®¶');
    });

    test('should extract merchant from note with ã§ pattern', () {
      // Given
      final note = 'å‰é‡å®¶ã§ç‰›ä¸¼ã‚’é£Ÿã¹ãŸ';

      // When
      final merchant = db.extractMerchantFromNote(note);

      // Then
      expect(merchant, 'å‰é‡å®¶');
    });

    test('should return null if no merchant pattern found', () {
      // Given
      final note = 'æ™®é€šã®å‚™è€ƒ';

      // When
      final merchant = db.extractMerchantFromNote(note);

      // Then
      expect(merchant, isNull);
    });
  });
}
```

### 7.2 Widgetæµ‹è¯•

```dart
// test/features/dual_ledger/presentation/widgets/soul_celebration_animation_test.dart

void main() {
  testWidgets('should display celebration animation', (tester) async {
    // Given
    var completed = false;

    await tester.pumpWidget(
      MaterialApp(
        home: Scaffold(
          body: SoulCelebrationAnimation(
            amount: 2110,
            onComplete: () => completed = true,
          ),
        ),
      ),
    );

    // When - animation starts
    await tester.pump();

    // Then - should show message
    expect(find.textContaining('ç²¾ç¥èµ„äº§'), findsOneWidget);
    expect(find.text('Â¥2,110'), findsOneWidget);

    // When - tap to skip
    await tester.tap(find.byType(SoulCelebrationAnimation));
    await tester.pumpAndSettle();

    // Then - should complete
    expect(completed, isTrue);
  });

  testWidgets('should auto-complete after 2 seconds', (tester) async {
    // Given
    var completed = false;

    await tester.pumpWidget(
      MaterialApp(
        home: Scaffold(
          body: SoulCelebrationAnimation(
            amount: 1280,
            onComplete: () => completed = true,
          ),
        ),
      ),
    );

    // When - wait for animation to complete
    await tester.pump(Duration(seconds: 2));
    await tester.pump(Duration(milliseconds: 500));

    // Then - should auto-complete
    expect(completed, isTrue);
  });
}

// test/features/dual_ledger/presentation/widgets/soul_progress_bar_test.dart

void main() {
  testWidgets('should display soul progress bar correctly', (tester) async {
    // Given
    await tester.pumpWidget(
      MaterialApp(
        home: Scaffold(
          body: SoulProgressBar(
            spent: 15000,
            budget: 30000,
          ),
        ),
      ),
    );

    // Then
    expect(find.text('ğŸ’–'), findsOneWidget);
    expect(find.text('çµé­‚è´¦æˆ·'), findsOneWidget);
    expect(find.text('Â¥15,000'), findsOneWidget);
    expect(find.text('æ®‹ã‚Š Â¥15,000'), findsOneWidget);
  });

  testWidgets('should show over-budget message', (tester) async {
    // Given
    await tester.pumpWidget(
      MaterialApp(
        home: Scaffold(
          body: SoulProgressBar(
            spent: 35000,
            budget: 30000,
          ),
        ),
      ),
    );

    // Then
    expect(find.text('âœ¨ çµé­‚å¤ªè¿‡å……å®äº†å‘¢ï½'), findsOneWidget);
  });
}
```

### 7.3 é›†æˆæµ‹è¯•

```dart
// integration_test/dual_ledger_flow_test.dart

void main() {
  IntegrationTestWidgetsFlutterBinding.ensureInitialized();

  testWidgets('complete dual ledger flow', (tester) async {
    // Given - launch app
    await tester.pumpWidget(MyApp());
    await tester.pumpAndSettle();

    // When - create a soul transaction
    await tester.tap(find.byIcon(Icons.add));
    await tester.pumpAndSettle();

    // Input amount
    await tester.tap(find.text('2'));
    await tester.tap(find.text('1'));
    await tester.tap(find.text('1'));
    await tester.tap(find.text('0'));
    await tester.pumpAndSettle();

    // Select hobby category
    await tester.tap(find.text('è¶£å‘³'));
    await tester.pumpAndSettle();

    // Then - should auto-classify as soul
    expect(find.text('ğŸ’– çµé­‚'), findsOneWidget);

    // Verify soul account is highlighted
    final soulButton = find.ancestor(
      of: find.text('ğŸ’– çµé­‚'),
      matching: find.byType(Container),
    );
    // TODO: verify button is highlighted

    // When - save transaction
    await tester.tap(find.text('ä¿å­˜'));
    await tester.pumpAndSettle();

    // Then - should show celebration animation
    expect(find.textContaining('ç²¾ç¥èµ„äº§'), findsOneWidget);

    // When - skip animation
    await tester.tap(find.byType(SoulCelebrationAnimation));
    await tester.pumpAndSettle();

    // Then - should return to home with transaction listed
    expect(find.text('Â¥2,110'), findsOneWidget);
    expect(find.text('ğŸ’–'), findsWidgets);  // Soul icon in list
  });

  testWidgets('manual classification override', (tester) async {
    // Given
    await tester.pumpWidget(MyApp());
    await tester.pumpAndSettle();

    // Create transaction
    await tester.tap(find.byIcon(Icons.add));
    await tester.pumpAndSettle();

    await tester.tap(find.text('1'));
    await tester.tap(find.text('0'));
    await tester.tap(find.text('0'));
    await tester.tap(find.text('0'));
    await tester.pumpAndSettle();

    // Select groceries (auto-classified as survival)
    await tester.tap(find.text('é£Ÿè²»ï¼ˆã‚¹ãƒ¼ãƒ‘ãƒ¼ï¼‰'));
    await tester.pumpAndSettle();

    // Verify auto-classification
    expect(find.text('ğŸ  ç”Ÿå­˜'), findsOneWidget);

    // When - manually change to soul
    await tester.tap(find.text('ğŸ’– çµé­‚'));
    await tester.pumpAndSettle();

    // Then - classification source should be 'user'
    // Save and verify
    await tester.tap(find.text('ä¿å­˜'));
    await tester.pumpAndSettle();

    // Transaction should be saved as soul type
    // (verify in database or transaction list)
  });
}
```

---

## 8. å¼€å‘é‡Œç¨‹ç¢‘

### 8.1 è¯¦ç»†ä»»åŠ¡æ‹†è§£ï¼ˆ8å¤©ï¼‰

| Day | ä»»åŠ¡ | äº§å‡º | é£é™© |
|-----|------|------|------|
| **Day 1** | æ•°æ®æ¨¡å‹è®¾è®¡ä¸å®ç° | - Driftè¡¨å®šä¹‰<br>- Repositoryå®ç°<br>- å•å…ƒæµ‹è¯• | ä½ |
| **Day 2** | è§„åˆ™å¼•æ“å®ç° | - RuleBasedClassifier<br>- 20ä¸ªåˆ†ç±»è§„åˆ™<br>- å•å…ƒæµ‹è¯• | ä½ |
| **Day 3** | å•†å®¶æ•°æ®åº“å®ç° | - MerchantDatabaseï¼ˆ500+å•†å®¶ï¼‰<br>- å•†å®¶æŸ¥æ‰¾ç®—æ³•<br>- å•å…ƒæµ‹è¯• | ä¸­ï¼ˆæ•°æ®æ”¶é›†å·¥ä½œé‡ï¼‰|
| **Day 4** | TF Liteæ¨¡å‹é›†æˆ | - TFLiteClassifier<br>- æ¨¡å‹æ–‡ä»¶ï¼ˆé¢„è®­ç»ƒï¼‰<br>- æ¨ç†æµ‹è¯• | é«˜ï¼ˆæ¨¡å‹è®­ç»ƒå¤æ‚ï¼‰|
| **Day 5** | çµé­‚è´¦æˆ·é…ç½®UI | - SoulConfigScreen<br>- ä¸ªæ€§åŒ–è®¾ç½®<br>- Widgetæµ‹è¯• | ä½ |
| **Day 6** | åº†ç¥åŠ¨ç”»å®ç° | - SoulCelebrationAnimation<br>- Lottieé›†æˆ<br>- åŠ¨ç”»æµ‹è¯• | ä¸­ï¼ˆåŠ¨ç”»æ•ˆæœè°ƒä¼˜ï¼‰|
| **Day 7** | UIå·®å¼‚åŒ–è®¾è®¡ | - åŒè½¨è¿›åº¦æ¡<br>- æœˆæŠ¥é¡µé¢<br>- ä¸»é¢˜åˆ‡æ¢ | ä¸­ï¼ˆè®¾è®¡ç»†èŠ‚ï¼‰|
| **Day 8** | é›†æˆæµ‹è¯•ä¸ä¼˜åŒ– | - ç«¯åˆ°ç«¯æµ‹è¯•<br>- æ€§èƒ½ä¼˜åŒ–<br>- Bugä¿®å¤ | ä¸­ |

### 8.2 å…³é”®è·¯å¾„è¯†åˆ«

```
Day 1 (æ•°æ®æ¨¡å‹)
    â†“
Day 2 (è§„åˆ™å¼•æ“) â”€â”€â”
                   â”œâ”€â”€â–º Day 5 (é…ç½®UI)
Day 3 (å•†å®¶åº“) â”€â”€â”€â”€â”¤
                   â”‚
Day 4 (TF Lite) â”€â”€â”€â”˜
    â†“
Day 6 (åº†ç¥åŠ¨ç”») â”€â”€â”
                   â”œâ”€â”€â–º Day 8 (é›†æˆæµ‹è¯•)
Day 7 (UIè®¾è®¡) â”€â”€â”€â”€â”˜
```

**å…³é”®è·¯å¾„:** Day 1 â†’ Day 4 â†’ Day 8
**TF Liteæ¨¡å‹æ˜¯æœ€å¤§é£é™©ç‚¹,å¯èƒ½éœ€è¦å»¶æœŸè‡³V1.0**

### 8.3 ä¾èµ–é¡¹ç®¡ç†

**å¤–éƒ¨ä¾èµ–:**
- TensorFlow Lite Flutteræ’ä»¶ï¼ˆå¯èƒ½æœ‰å…¼å®¹æ€§é—®é¢˜ï¼‰
- LottieåŠ¨ç”»åº“ï¼ˆéœ€è¦å‡†å¤‡åŠ¨ç”»æ–‡ä»¶ï¼‰
- å•†å®¶æ•°æ®æ”¶é›†ï¼ˆéœ€è¦æ•°æ®å›¢é˜Ÿæ”¯æŒï¼‰

**å†…éƒ¨ä¾èµ–:**
- MOD-001 åŸºç¡€è®°è´¦ï¼ˆå¿…é¡»å®Œæˆï¼‰
- MOD-002 åˆ†ç±»ç®¡ç†ï¼ˆå¿…é¡»å®Œæˆï¼‰

### 8.4 é£é™©ä¸ç¼“è§£æªæ–½

| é£é™© | æ¦‚ç‡ | å½±å“ | ç¼“è§£æªæ–½ |
|------|------|------|---------|
| TF Liteæ¨¡å‹å‡†ç¡®ç‡ä¸è¾¾æ ‡ | é«˜ | é«˜ | MVPé˜¶æ®µé™ä½ç›®æ ‡è‡³75%,V1.0ä¼˜åŒ– |
| å•†å®¶æ•°æ®æ”¶é›†å·¥ä½œé‡å¤§ | ä¸­ | ä¸­ | å…ˆå®ç°200ä¸ªæ ¸å¿ƒå•†å®¶,åç»­OTAæ›´æ–° |
| åº†ç¥åŠ¨ç”»å½±å“æ€§èƒ½ | ä½ | ä¸­ | æä¾›"å…³é—­åŠ¨ç”»"é€‰é¡¹,ä¼˜åŒ–æ¸²æŸ“ |
| æ–‡åŒ–æ¥å—åº¦é—®é¢˜ | ä¸­ | é«˜ | A/Bæµ‹è¯•éªŒè¯,å‡†å¤‡é™çº§æ–¹æ¡ˆ |

---

## 9. é™„å½•

### 9.1 ç›¸å…³æ–‡æ¡£é“¾æ¥

- [PRD_Module_BasicAccounting.md](/Users/xinz/Development/ThinkCenter/claudedocs/PRD_Module_BasicAccounting.md)
- [PRD_Modules_Summary.md](/Users/xinz/Development/ThinkCenter/claudedocs/PRD_Modules_Summary.md)
- [research_home_pocket_feasibility_strategy_20260202_CN.md](/Users/xinz/Development/ThinkCenter/claudedocs/research_home_pocket_feasibility_strategy_20260202_CN.md)

### 9.2 æŠ€æœ¯å‚è€ƒèµ„æ–™

**TensorFlow Lite:**
- [TensorFlow Lite Flutteræ’ä»¶](https://pub.dev/packages/tflite_flutter)
- [æ–‡æœ¬åˆ†ç±»æ¨¡å‹è®­ç»ƒ](https://www.tensorflow.org/lite/examples/text_classification/overview)

**LottieåŠ¨ç”»:**
- [Lottie Flutter](https://pub.dev/packages/lottie)
- [LottieFilesç¤¾åŒº](https://lottiefiles.com/)

**å•†å®¶æ•°æ®:**
- [æ—¥æœ¬è¿é”åº—åˆ—è¡¨](https://ja.wikipedia.org/wiki/æ—¥æœ¬ã®å°å£²æ¥­è€…ä¸€è¦§)
- [ã‚³ãƒ³ãƒ“ãƒ‹ã‚¨ãƒ³ã‚¹ã‚¹ãƒˆã‚¢](https://ja.wikipedia.org/wiki/ã‚³ãƒ³ãƒ“ãƒ‹ã‚¨ãƒ³ã‚¹ã‚¹ãƒˆã‚¢)

### 9.3 è®¾è®¡å†³ç­–è®°å½•

**å†³ç­–001: ä¸ºä»€ä¹ˆä¸ä½¿ç”¨Gemini Nano?**
- æ—¥æœŸ: 2026-02-03
- åŸå› : é…é¢é™åˆ¶ã€ä»…å‰å°ã€è®¾å¤‡å…¼å®¹æ€§é—®é¢˜
- æ›¿ä»£æ–¹æ¡ˆ: TensorFlow Liteæœ¬åœ°æ¨¡å‹
- å‚è€ƒ: research_home_pocket_feasibility_strategy_20260202_CN.md ç¬¬2.2èŠ‚

**å†³ç­–002: ä¸ºä»€ä¹ˆé»˜è®¤ä¿å®ˆç­–ç•¥ï¼ˆæœªçŸ¥åˆ†ç±»â†’ç”Ÿå­˜ï¼‰?**
- æ—¥æœŸ: 2026-02-03
- åŸå› : é¿å…å°†å¿…éœ€æ”¯å‡ºè¯¯åˆ¤ä¸ºäº«ä¹,å¯¼è‡´é¢„ç®—å¤±æ§
- æ›¿ä»£æ–¹æ¡ˆ: æç¤ºç”¨æˆ·æ‰‹åŠ¨ç¡®è®¤
- å½±å“: å¯èƒ½é™ä½çµé­‚æ¶ˆè´¹çš„è¯†åˆ«ç‡

**å†³ç­–003: ä¸ºä»€ä¹ˆå®¶åº­æ¨¡å¼åªæ˜¾ç¤ºçµé­‚è´¦æˆ·è¿›åº¦?**
- æ—¥æœŸ: 2026-02-03
- åŸå› : é¿å…"ä¹°äº†ä»€ä¹ˆ"å¼•å‘ä¼´ä¾£äº‰æ‰§,ä¿æŠ¤ä¸ªäººéšç§
- æ›¿ä»£æ–¹æ¡ˆ: å®Œå…¨é€æ˜ï¼ˆè¢«å¦å†³ï¼‰
- ç”¨æˆ·åé¦ˆ: Betaæµ‹è¯•éªŒè¯

---

**æ–‡æ¡£çŠ¶æ€:** å®Œæˆ
**å®¡æ ¸çŠ¶æ€:** å¾…è¯„å®¡
**éœ€è¦è¯„å®¡:** äº§å“ç»ç†ã€æŠ€æœ¯è´Ÿè´£äººã€UI/UXè®¾è®¡å¸ˆ

**å˜æ›´æ—¥å¿—:**
- 2026-02-03: åˆç‰ˆå®Œæˆï¼ˆåŸºäºæ¡†æ¶æ–‡æ¡£å’Œå¯è¡Œæ€§ç ”ç©¶ï¼‰
