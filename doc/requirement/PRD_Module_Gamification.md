# PRD - è¶£å‘³åŠŸèƒ½æ¨¡å—

**æ¨¡å—ID:** MOD-009
**æ¨¡å—åç§°:** è¶£å‘³åŠŸèƒ½æ¨¡å—ï¼ˆæ¸¸æˆåŒ–ï¼‰
**ç‰ˆæœ¬:** 1.0
**åˆ›å»ºæ—¥æœŸ:** 2026å¹´2æœˆ3æ—¥
**ä¼˜å…ˆçº§:** P2ï¼ˆå¯é€‰A/Bæµ‹è¯•ï¼‰
**é¢„ä¼°å·¥æ—¶:** 7å¤©

---

## 1. æ¨¡å—æ¦‚è¿°

### 1.1 åŠŸèƒ½å®šä¹‰

è¶£å‘³åŠŸèƒ½æ¨¡å—é€šè¿‡æ¸¸æˆåŒ–è®¾è®¡,ä¸ºè®°è´¦è¡Œä¸ºå¢æ·»ä¹è¶£,æå‡ç”¨æˆ·ç•™å­˜ç‡ã€‚åŒ…æ‹¬:

- **å¤§è°·ç¿”å¹³æ¢ç®—å™¨ï¼ˆC01ï¼‰:** å°†æ¶ˆè´¹é‡‘é¢æ¢ç®—æˆæ—¥æœ¬å›½æ°‘çº§æ–‡åŒ–ç¬¦å·
- **è¿åŠ¿å åœï¼ˆC02ï¼‰:** å°ç¥¨å åœï¼ˆOCRè§¦å‘ï¼‰+ ä»Šæ—¥è¿åŠ¿ï¼ˆä¸»åŠ¨è§¦å‘ï¼‰
- **çµé­‚æ¶ˆè´¹åº†ç¥ï¼ˆC04ï¼‰:** å·²åœ¨åŒè½¨è´¦æœ¬æ¨¡å—å®ç°

**é‡è¦å†³ç­–:** ä»…å½“Betaæµ‹è¯•ç”¨æˆ·æ¥å—åº¦>60%æ—¶æ‰åŒ…å«åœ¨MVPä¸­ã€‚

**æ ¸å¿ƒä»·å€¼ä¸»å¼ :**
å°†ä¸¥è‚ƒçš„è®°è´¦è¡Œä¸ºè½¬åŒ–ä¸ºæœ‰è¶£çš„ç¤¾äº¤ä½“éªŒ,åˆ›é€ "å°ç¡®å¹¸"æ—¶åˆ»ã€‚

### 1.2 ç”¨æˆ·åœºæ™¯ä¸ç—›ç‚¹

**ç”¨æˆ·ç”»åƒ:**
- å±±ç”°èŠ±å­ï¼ˆ28å²,å–œæ¬¢åˆ†äº«ç”Ÿæ´»ï¼‰
- è§‰å¾—ä¼ ç»Ÿè®°è´¦åº”ç”¨å¤ªæ¯ç‡¥,éš¾ä»¥åšæŒ
- å¸Œæœ›æœ‰ä¸€äº›æœ‰è¶£çš„å…ƒç´ è®©è®°è´¦å˜å¾—ä¸é‚£ä¹ˆæ— èŠ

**ç—›ç‚¹:**
1. **è®°è´¦æ— èŠ:** æ¯å¤©è¾“å…¥æ•°å­—,æ²¡æœ‰åé¦ˆ,ç¼ºä¹æˆå°±æ„Ÿ
2. **ç¼ºä¹åŠ¨åŠ›:** çœ‹åˆ°æ”¯å‡ºæŠ¥è¡¨åªæœ‰ç„¦è™‘,æ²¡æœ‰æ­£å‘æ¿€åŠ±
3. **ä¸æƒ³åˆ†äº«:** ä¼ ç»Ÿè®°è´¦æ•°æ®å¤ªéšç§,æ— æ³•ä¸æœ‹å‹åˆ†äº«

**Home Pocketè§£å†³æ–¹æ¡ˆ:**
- å¤§è°·ç¿”å¹³æ¢ç®—å™¨:åˆ›é€ ç¤¾äº¤è¯é¢˜("æˆ‘ä»Šå¤©èŠ±äº†å¤§è°·3ç§’çš„å·¥èµ„!")
- è¿åŠ¿å åœ:å°†æ¶ˆè´¹è½¬åŒ–ä¸º"æŠ½ç­¾"ä½“éªŒ,å¢åŠ ä»ªå¼æ„Ÿ
- çµé­‚æ¶ˆè´¹åº†ç¥:æ­£å‘åé¦ˆ,é¿å…æ„§ç–šæ„Ÿ

### 1.3 æ–‡åŒ–é£é™©è¯„ä¼°

**æ ¹æ®å¯è¡Œæ€§ç ”ç©¶:**
- âš ï¸ **ä¸»è¦é£é™©:** æ¸¸æˆåŒ–å¯èƒ½ä¸æ—¥æœ¬Kakeiboä¼ ç»Ÿï¼ˆæ·±æ€ç†Ÿè™‘çš„æ‘©æ“¦ï¼‰å†²çª
- âš ï¸ **å¹´é¾„é—®é¢˜:** 35-50å²ç›®æ ‡ç”¨æˆ·å¯èƒ½è§‰å¾—å¹¼ç¨š
- âœ… **ç¼“è§£æªæ–½:** A/Bæµ‹è¯•éªŒè¯,æä¾›"æˆç†Ÿæ¨¡å¼"å…³é—­è¶£å‘³åŠŸèƒ½

**A/Bæµ‹è¯•å†³ç­–æ¡†æ¶:**
```
Betaæµ‹è¯•ï¼ˆ100äººï¼‰
    â†“
å¯¹ç…§ç»„ï¼ˆ50äºº,æ— è¶£å‘³åŠŸèƒ½ï¼‰vs å®éªŒç»„ï¼ˆ50äºº,æœ‰è¶£å‘³åŠŸèƒ½ï¼‰
    â†“
æµ‹é‡æŒ‡æ ‡ï¼š
- D7ç•™å­˜ç‡
- æ¯æ—¥è®°è´¦ç¬”æ•°
- NPSè¯„åˆ†
- ç”¨æˆ·åé¦ˆæƒ…ç»ªï¼ˆæ­£é¢/è´Ÿé¢/ä¸­æ€§ï¼‰
    â†“
Go/No-Goå†³ç­–ï¼š
âœ… ç»§ç»­ï¼šå®éªŒç»„D7ç•™å­˜ > å¯¹ç…§ç»„ + 5%ï¼Œä¸”NPS â‰¥ å¯¹ç…§ç»„
âš ï¸ ä¼˜åŒ–ï¼šå®éªŒç»„D7ç•™å­˜ = å¯¹ç…§ç»„ Â± 3%ï¼Œéœ€è¦è°ƒæ•´æ–‡æ¡ˆ/è®¾è®¡
âŒ ç§»é™¤ï¼šå®éªŒç»„D7ç•™å­˜ < å¯¹ç…§ç»„ - 5%ï¼Œæˆ–NPSæ˜¾è‘—ä¸‹é™
```

### 1.4 ä¸å…¶ä»–æ¨¡å—çš„ä¾èµ–å…³ç³»

**å‰ç½®ä¾èµ–:**
- MOD-001 åŸºç¡€è®°è´¦ï¼ˆéœ€è¦äº¤æ˜“æ•°æ®ï¼‰
- MOD-005 OCRæ‰«æï¼ˆå°ç¥¨å åœè§¦å‘ï¼‰

**è¢«ä¾èµ–:**
- æ— ï¼ˆç‹¬ç«‹åŠŸèƒ½,å¯éšæ—¶å¯ç”¨/ç¦ç”¨ï¼‰

---

## 2. è¯¦ç»†åŠŸèƒ½è§„æ ¼

### 2.1 C01: å¤§è°·ç¿”å¹³æ¢ç®—å™¨

#### 2.1.1 åŠŸèƒ½æ¦‚è¿°

å°†æ¶ˆè´¹é‡‘é¢æ¢ç®—æˆæ—¥æœ¬å›½æ°‘çº§æ–‡åŒ–ç¬¦å·,åˆ›é€ "ç¤¾äº¤è´§å¸"å¼ä½“éªŒã€‚

**è§¦å‘æœºåˆ¶:**
- è§¦å‘æ—¶æœº:äº¤æ˜“ä¿å­˜æˆåŠŸå0.5ç§’
- å±•ç¤ºå½¢å¼:Toastæ¨ªå¹…åŠ¨ç”»,3ç§’åè‡ªåŠ¨æ¶ˆå¤±
- å¯å…³é—­:âœ… è®¾ç½®ä¸­å¯å…³é—­

**æ¢ç®—å•ä½åº“ï¼ˆOTAçƒ­æ›´æ–°ï¼‰:**

```json
{
  "version": "1.0.0",
  "last_updated": "2026-02-03",
  "units": [
    {
      "id": "ohtani_salary",
      "name": "å¤§è°·ç¿”å¹³ã®çµ¦æ–™",
      "unit_yen": 2000,
      "format_ja": "ã“ã®é‡‘é¡ã¯å¤§è°·ç¿”å¹³ã®{value}ç§’åˆ†ã®çµ¦æ–™ã§ã™ âš¾",
      "format_cn": "è¿™æ˜¯å¤§è°·ç¿”å¹³{value}ç§’çš„å·¥èµ„ âš¾",
      "icon": "âš¾",
      "category": "sports",
      "min_amount": 1000,
      "max_amount": 50000
    },
    {
      "id": "yoshinoya_gyudon",
      "name": "å‰é‡å®¶ã®ç‰›ä¸¼",
      "unit_yen": 500,
      "format_ja": "{value}æ¯ã®ç‰›ä¸¼ã‚’é£Ÿã¹ã¾ã—ãŸ ğŸš",
      "format_cn": "åƒäº†{value}ç¢—ç‰›è‚‰é¥­ ğŸš",
      "icon": "ğŸš",
      "category": "food",
      "min_amount": 100,
      "max_amount": 10000
    },
    {
      "id": "gacha_pull",
      "name": "ã‚½ã‚·ãƒ£ã‚²ã®10é€£ã‚¬ãƒãƒ£",
      "unit_yen": 3000,
      "format_ja": "{value}å›ã®10é€£ã‚¬ãƒãƒ£ãŒå›ã›ã¾ã™ ğŸ°",
      "format_cn": "å¯ä»¥æŠ½{value}æ¬¡åè¿ ğŸ°",
      "icon": "ğŸ°",
      "category": "game",
      "min_amount": 1000,
      "max_amount": 30000
    },
    {
      "id": "starbucks_latte",
      "name": "ã‚¹ã‚¿ãƒã®ãƒ©ãƒ†",
      "unit_yen": 450,
      "format_ja": "{value}æ¯ã®ã‚¹ã‚¿ãƒãƒ©ãƒ†ã§ã™ â˜•",
      "format_cn": "æ˜Ÿå·´å…‹æ‹¿é“{value}æ¯ â˜•",
      "icon": "â˜•",
      "category": "food",
      "min_amount": 100,
      "max_amount": 5000
    },
    {
      "id": "tokyo_metro",
      "name": "æ±äº¬ãƒ¡ãƒˆãƒ­ã®é‹è³ƒ",
      "unit_yen": 200,
      "format_ja": "æ±äº¬ãƒ¡ãƒˆãƒ­{value}å›åˆ†ã§ã™ ğŸš‡",
      "format_cn": "ä¸œäº¬åœ°é“{value}æ¬¡ ğŸš‡",
      "icon": "ğŸš‡",
      "category": "transport",
      "min_amount": 100,
      "max_amount": 3000
    },
    {
      "id": "onsen_entry",
      "name": "æ¸©æ³‰ã®å…¥æµ´æ–™",
      "unit_yen": 800,
      "format_ja": "{value}å›åˆ†ã®æ¸©æ³‰ã§ã™ â™¨ï¸",
      "format_cn": "æ¸©æ³‰{value}æ¬¡ â™¨ï¸",
      "icon": "â™¨ï¸",
      "category": "leisure",
      "min_amount": 500,
      "max_amount": 10000
    },
    {
      "id": "manga_volume",
      "name": "æ¼«ç”»ã®å˜è¡Œæœ¬",
      "unit_yen": 550,
      "format_ja": "{value}å†Šã®æ¼«ç”»ãŒè²·ãˆã¾ã™ ğŸ“š",
      "format_cn": "æ¼«ç”»ä¹¦{value}æœ¬ ğŸ“š",
      "icon": "ğŸ“š",
      "category": "hobby",
      "min_amount": 300,
      "max_amount": 10000
    },
    {
      "id": "shiba_inu_food",
      "name": "æŸ´çŠ¬ã®1æ—¥åˆ†ã®ã”é£¯",
      "unit_yen": 300,
      "format_ja": "æŸ´çŠ¬{value}æ—¥åˆ†ã®ã”é£¯ã§ã™ ğŸ•",
      "format_cn": "æŸ´çŠ¬{value}å¤©çš„ç‹—ç²® ğŸ•",
      "icon": "ğŸ•",
      "category": "pet",
      "min_amount": 100,
      "max_amount": 5000
    }
  ]
}
```

**å®ç°ä»£ç :**

```dart
// lib/features/gamification/domain/use_cases/ohtani_converter.dart

class OhtaniConverter {
  final ConversionUnitRepository _unitRepo;

  Future<String?> convert(int amount) async {
    // 1. è·å–æ¢ç®—å•ä½åº“ï¼ˆä»OTAé…ç½®ï¼‰
    final units = await _unitRepo.getUnits();

    // 2. æ ¹æ®é‡‘é¢èŒƒå›´ç­›é€‰åˆé€‚çš„å•ä½
    final suitableUnits = units.where((unit) {
      return amount >= unit.minAmount && amount <= unit.maxAmount;
    }).toList();

    if (suitableUnits.isEmpty) {
      return null;  // é‡‘é¢ä¸åœ¨ä»»ä½•å•ä½èŒƒå›´å†…
    }

    // 3. éšæœºé€‰æ‹©ä¸€ä¸ªå•ä½
    final random = Random();
    final selectedUnit = suitableUnits[random.nextInt(suitableUnits.length)];

    // 4. è®¡ç®—æ¢ç®—å€¼
    final count = (amount / selectedUnit.unitYen).round();

    // 5. æ ¼å¼åŒ–æ–‡æ¡ˆ
    return selectedUnit.formatJa.replaceAll('{value}', count.toString());
  }
}

// lib/features/gamification/presentation/widgets/ohtani_toast.dart

class OhtaniToast extends StatefulWidget {
  final String message;

  const OhtaniToast({required this.message});

  @override
  State<OhtaniToast> createState() => _OhtaniToastState();
}

class _OhtaniToastState extends State<OhtaniToast>
    with SingleTickerProviderStateMixin {
  late AnimationController _controller;
  late Animation<Offset> _slideAnimation;
  late Animation<double> _fadeAnimation;

  @override
  void initState() {
    super.initState();
    _controller = AnimationController(
      vsync: this,
      duration: Duration(milliseconds: 500),
    );

    _slideAnimation = Tween<Offset>(
      begin: Offset(0, -1),
      end: Offset.zero,
    ).animate(CurvedAnimation(
      parent: _controller,
      curve: Curves.easeOut,
    ));

    _fadeAnimation = Tween<double>(
      begin: 0,
      end: 1,
    ).animate(_controller);

    _controller.forward();

    // 3ç§’åè‡ªåŠ¨æ¶ˆå¤±
    Future.delayed(Duration(seconds: 3), () {
      if (mounted) {
        _controller.reverse().then((_) {
          Navigator.of(context).pop();
        });
      }
    });
  }

  @override
  Widget build(BuildContext context) {
    return SlideTransition(
      position: _slideAnimation,
      child: FadeTransition(
        opacity: _fadeAnimation,
        child: Container(
          margin: EdgeInsets.only(top: 60, left: 16, right: 16),
          padding: EdgeInsets.symmetric(horizontal: 20, vertical: 12),
          decoration: BoxDecoration(
            gradient: LinearGradient(
              colors: [Color(0xFF4A90D9), Color(0xFF00BCD4)],
            ),
            borderRadius: BorderRadius.circular(12),
            boxShadow: [
              BoxShadow(
                color: Colors.black.withOpacity(0.2),
                blurRadius: 10,
                offset: Offset(0, 5),
              ),
            ],
          ),
          child: Row(
            children: [
              Icon(Icons.info_outline, color: Colors.white, size: 24),
              SizedBox(width: 12),
              Expanded(
                child: Text(
                  widget.message,
                  style: TextStyle(
                    color: Colors.white,
                    fontSize: 15,
                    fontWeight: FontWeight.w500,
                  ),
                ),
              ),
            ],
          ),
        ),
      ),
    );
  }

  @override
  void dispose() {
    _controller.dispose();
    super.dispose();
  }
}
```

**ä½¿ç”¨ç¤ºä¾‹:**

```dart
// åœ¨äº¤æ˜“ä¿å­˜æˆåŠŸåè°ƒç”¨
Future<void> _onTransactionSaved(Transaction tx) async {
  final settings = await _settingsRepo.getSettings();

  if (settings.ohtaniConverterEnabled) {
    final message = await _ohtaniConverter.convert(tx.amount);

    if (message != null) {
      Navigator.of(context).push(
        PageRouteBuilder(
          opaque: false,
          pageBuilder: (context, _, __) => OhtaniToast(message: message),
        ),
      );
    }
  }
}
```

---

### 2.2 C02: è¿åŠ¿å åœ

#### 2.2.1 C02a: å°ç¥¨å åœï¼ˆè¢«åŠ¨è§¦å‘ï¼‰

**è§¦å‘æ—¶æœº:**
ç”¨æˆ·ä½¿ç”¨OCRæ‰«æå°ç¥¨æ—¶è‡ªåŠ¨è§¦å‘

**å åœæµç¨‹:**

```
æ‰«æå°ç¥¨ â†’ OCRè¯†åˆ« â†’ ç”¨æˆ·ç¡®è®¤
    â†“
ç‚¹å‡»"ä¿å­˜"
    â†“
å°ç¥¨å˜å½¢ä¸º"ç­¾çº¸"ï¼ˆç¿»è½¬åŠ¨ç”»ï¼‰
    â†“
å±•ç¤ºè¿åŠ¿ç»“æœ
    â†“
[å¯é€‰] æŸ¥çœ‹è¯¦ç»†è§£è¯»
    â†“
è¿”å›é¦–é¡µ
```

**è¿åŠ¿ç”Ÿæˆç®—æ³•:**

```dart
// lib/features/gamification/domain/use_cases/generate_omikuji.dart

class GenerateOmikujiUseCase {
  Future<OmikujiResult> execute(Transaction tx) async {
    // 1. ç”Ÿæˆç¡®å®šæ€§ç§å­ï¼ˆåŸºäºäº¤æ˜“æ•°æ®ï¼‰
    final seed = _generateSeed(tx);

    // 2. é€‰æ‹©è¿åŠ¿ç­‰çº§
    final level = _selectLevel(seed);

    // 3. ç”Ÿæˆä¸ªæ€§åŒ–æ–‡æ¡ˆ
    final message = await _generateMessage(level, tx);

    // 4. é€‰æ‹©ç›¸å…³åˆ†ç±»çš„è¿åŠ¿é¢„æµ‹
    final forecast = _generateForecast(level, tx.categoryId);

    return OmikujiResult(
      level: level,
      message: message,
      forecast: forecast,
      transactionId: tx.id,
    );
  }

  int _generateSeed(Transaction tx) {
    // ç¡®ä¿åŒä¸€ç¬”äº¤æ˜“æ¯æ¬¡ç”Ÿæˆç›¸åŒçš„è¿åŠ¿
    final dateHash = tx.timestamp.day * 31 + tx.timestamp.month;
    final amountHash = tx.amount % 1000;
    final noteHash = tx.note?.hashCode ?? 0;
    return (dateHash ^ amountHash ^ noteHash) & 0x7FFFFFFF;
  }

  OmikujiLevel _selectLevel(int seed) {
    final random = Random(seed);
    final roll = random.nextDouble() * 100;

    // è¿åŠ¿ç­‰çº§æ¦‚ç‡åˆ†å¸ƒ
    if (roll < 5) return OmikujiLevel.daikichi;      // å¤§å‰ 5%
    if (roll < 20) return OmikujiLevel.chukichi;     // ä¸­å‰ 15%
    if (roll < 45) return OmikujiLevel.shokichi;     // å°å‰ 25%
    if (roll < 75) return OmikujiLevel.kichi;        // å‰ 30%
    if (roll < 90) return OmikujiLevel.suekichi;     // æœ«å‰ 15%
    if (roll < 98) return OmikujiLevel.kyo;          // å‡¶ 8%
    return OmikujiLevel.daikyo;                      // å¤§å‡¶ 2%
  }

  Future<String> _generateMessage(OmikujiLevel level, Transaction tx) async {
    final templates = await _messageRepo.getTemplates(level);
    final random = Random(tx.id.hashCode);
    return templates[random.nextInt(templates.length)];
  }

  Map<String, String> _generateForecast(OmikujiLevel level, String categoryId) {
    // æ ¹æ®åˆ†ç±»ç”Ÿæˆä¸åŒçš„è¿åŠ¿é¢„æµ‹
    final forecasts = <String, String>{};

    if (categoryId.contains('food')) {
      forecasts['æ–™ç†é‹'] = _getFoodFortune(level);
    } else if (categoryId.contains('hobby')) {
      forecasts['è¶£å‘³é‹'] = _getHobbyFortune(level);
    } else if (categoryId.contains('shopping')) {
      forecasts['è²·ã„ç‰©é‹'] = _getShoppingFortune(level);
    }

    // é€šç”¨è¿åŠ¿
    forecasts['é‡‘é‹'] = _getMoneyFortune(level);
    forecasts['å¥åº·é‹'] = _getHealthFortune(level);

    return forecasts;
  }
}

enum OmikujiLevel {
  daikichi,   // å¤§å‰
  chukichi,   // ä¸­å‰
  shokichi,   // å°å‰
  kichi,      // å‰
  suekichi,   // æœ«å‰
  kyo,        // å‡¶
  daikyo,     // å¤§å‡¶
}

class OmikujiResult {
  final OmikujiLevel level;
  final String message;
  final Map<String, String> forecast;  // åˆ†ç±»è¿åŠ¿
  final String transactionId;

  OmikujiResult({
    required this.level,
    required this.message,
    required this.forecast,
    required this.transactionId,
  });
}
```

**UIè®¾è®¡ï¼ˆç­¾çº¸ç¿»è½¬åŠ¨ç”»ï¼‰:**

```dart
// lib/features/gamification/presentation/widgets/omikuji_reveal.dart

class OmikujiReveal extends StatefulWidget {
  final OmikujiResult result;

  const OmikujiReveal({required this.result});

  @override
  State<OmikujiReveal> createState() => _OmikujiRevealState();
}

class _OmikujiRevealState extends State<OmikujiReveal>
    with SingleTickerProviderStateMixin {
  late AnimationController _controller;
  late Animation<double> _flipAnimation;

  @override
  void initState() {
    super.initState();
    _controller = AnimationController(
      vsync: this,
      duration: Duration(milliseconds: 800),
    );

    _flipAnimation = Tween<double>(begin: 0, end: 1).animate(
      CurvedAnimation(parent: _controller, curve: Curves.easeInOut),
    );

    // å»¶è¿Ÿ0.5ç§’åå¼€å§‹ç¿»è½¬
    Future.delayed(Duration(milliseconds: 500), () {
      _controller.forward();
    });
  }

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      backgroundColor: Colors.black.withOpacity(0.8),
      body: Center(
        child: AnimatedBuilder(
          animation: _flipAnimation,
          builder: (context, child) {
            final angle = _flipAnimation.value * pi;
            final isFront = angle < pi / 2;

            return Transform(
              alignment: Alignment.center,
              transform: Matrix4.identity()
                ..setEntry(3, 2, 0.001)
                ..rotateY(angle),
              child: isFront ? _buildReceiptFront() : _buildOmikujiBack(),
            );
          },
        ),
      ),
    );
  }

  Widget _buildReceiptFront() {
    // æ”¶æ®æ­£é¢ï¼ˆæ¨¡æ‹Ÿçº¸è´¨æ”¶æ®ï¼‰
    return Container(
      width: 300,
      padding: EdgeInsets.all(24),
      decoration: BoxDecoration(
        color: Colors.white,
        borderRadius: BorderRadius.circular(12),
        boxShadow: [
          BoxShadow(
            color: Colors.black.withOpacity(0.3),
            blurRadius: 20,
            offset: Offset(0, 10),
          ),
        ],
      ),
      child: Column(
        mainAxisSize: MainAxisSize.min,
        children: [
          Text('ãƒ¬ã‚·ãƒ¼ãƒˆ', style: TextStyle(fontSize: 20)),
          Divider(),
          Text('å¤‰èº«ä¸­...', style: TextStyle(fontSize: 16, color: Colors.grey)),
        ],
      ),
    );
  }

  Widget _buildOmikujiBack() {
    // ç­¾çº¸èƒŒé¢ï¼ˆè¿åŠ¿ç»“æœï¼‰
    return Transform(
      alignment: Alignment.center,
      transform: Matrix4.identity()..rotateY(pi),  // ç¿»è½¬èƒŒé¢æ–‡å­—
      child: Container(
        width: 300,
        padding: EdgeInsets.all(24),
        decoration: BoxDecoration(
          gradient: LinearGradient(
            colors: _getGradientColors(widget.result.level),
            begin: Alignment.topLeft,
            end: Alignment.bottomRight,
          ),
          borderRadius: BorderRadius.circular(12),
          boxShadow: [
            BoxShadow(
              color: Colors.black.withOpacity(0.3),
              blurRadius: 20,
              offset: Offset(0, 10),
            ),
          ],
        ),
        child: Column(
          mainAxisSize: MainAxisSize.min,
          children: [
            Text(
              widget.result.level.displayName,
              style: TextStyle(
                fontSize: 48,
                fontWeight: FontWeight.bold,
                color: Colors.white,
              ),
            ),
            SizedBox(height: 16),
            Text(
              widget.result.message,
              textAlign: TextAlign.center,
              style: TextStyle(fontSize: 16, color: Colors.white),
            ),
            SizedBox(height: 24),
            ...widget.result.forecast.entries.map((entry) {
              return Padding(
                padding: EdgeInsets.symmetric(vertical: 4),
                child: Row(
                  mainAxisAlignment: MainAxisAlignment.spaceBetween,
                  children: [
                    Text(entry.key, style: TextStyle(color: Colors.white70)),
                    Text(entry.value, style: TextStyle(color: Colors.white)),
                  ],
                ),
              );
            }),
            SizedBox(height: 24),
            ElevatedButton(
              onPressed: () => Navigator.pop(context),
              child: Text('é–‰ã˜ã‚‹'),
            ),
          ],
        ),
      ),
    );
  }

  List<Color> _getGradientColors(OmikujiLevel level) {
    switch (level) {
      case OmikujiLevel.daikichi:
        return [Color(0xFFFFD700), Color(0xFFFF8C00)];  // é‡‘è‰²
      case OmikujiLevel.chukichi:
        return [Color(0xFFFF6B6B), Color(0xFFFF4757)];  // çº¢è‰²
      case OmikujiLevel.shokichi:
      case OmikujiLevel.kichi:
        return [Color(0xFF4CAF50), Color(0xFF45B7D1)];  // ç»¿è‰²
      case OmikujiLevel.suekichi:
        return [Color(0xFF5DADE2), Color(0xFF3498DB)];  // è“è‰²
      case OmikujiLevel.kyo:
        return [Color(0xFF95A5A6), Color(0xFF7F8C8D)];  // ç°è‰²
      case OmikujiLevel.daikyo:
        return [Color(0xFF9B59B6), Color(0xFF8E44AD)];  // ç´«è‰²
    }
  }

  @override
  void dispose() {
    _controller.dispose();
    super.dispose();
  }
}
```

#### 2.2.2 C02b: ä»Šæ—¥è¿åŠ¿ï¼ˆä¸»åŠ¨è§¦å‘ï¼‰

**è§¦å‘æ—¶æœº:**
ç”¨æˆ·ç‚¹å‡»é¦–é¡µçš„"ä»Šæ—¥è¿åŠ¿"å…¥å£

**è´§å¸åŒ–è®¾è®¡:**
é¢„æµ‹ç»“æœé¡µé¢å±•ç¤ºæ¿€åŠ±å¹¿å‘Šï¼ˆå˜ç°å…¥å£ï¼‰

**UIè®¾è®¡:**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ä»Šæ—¥é‹å‹¢                           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                             â”‚   â”‚
â”‚  â”‚      [æŠ½ç­¾åŠ¨ç”»]             â”‚   â”‚
â”‚  â”‚                             â”‚   â”‚
â”‚  â”‚   ç‚¹å‡»è·å–ä»Šæ—¥è¿åŠ¿           â”‚   â”‚
â”‚  â”‚                             â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                     â”‚
â”‚  [ç‚¹å‡»æŠ½ç­¾]                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â†“ ç‚¹å‡»å

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ä»Šæ—¥é‹å‹¢                      â† â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                     â”‚
â”‚          å¤§å‰                       â”‚
â”‚  â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”      â”‚
â”‚                                     â”‚
â”‚  ä»Šæ—¥ã®ã‚ãªãŸã¯æœ€é«˜ã®é‹æ°—ï¼         â”‚
â”‚  è²¡å¸ƒã«å„ªã—ã„æ—¥ã«ãªã‚‹ã§ã—ã‚‡ã†ã€‚      â”‚
â”‚                                     â”‚
â”‚  â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”      â”‚
â”‚  å„ç¨®é‹å‹¢                           â”‚
â”‚  â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”      â”‚
â”‚                                     â”‚
â”‚  é‡‘é‹:    â˜…â˜…â˜…â˜…â˜…               â”‚
â”‚  å¥åº·é‹:  â˜…â˜…â˜…â˜…â˜†               â”‚
â”‚  æ‹æ„›é‹:  â˜…â˜…â˜…â˜†â˜†               â”‚
â”‚                                     â”‚
â”‚  â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”      â”‚
â”‚  ä»Šæ—¥ã®ãƒ©ãƒƒã‚­ãƒ¼ã‚¢ã‚¤ãƒ†ãƒ               â”‚
â”‚  â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”      â”‚
â”‚                                     â”‚
â”‚  ğŸ€ ç‰›ä¸¼                            â”‚
â”‚                                     â”‚
â”‚  â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”      â”‚
â”‚                                     â”‚
â”‚  [åºƒå‘Š] â† æ¿€åŠ±å¹¿å‘Šæ’å…¥ä½ç½®          â”‚
â”‚                                     â”‚
â”‚  [ã‚‚ã†ä¸€åº¦å ã†]  [é–‰ã˜ã‚‹]           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 3. æ•°æ®æ¨¡å‹è®¾è®¡

### 3.1 Driftè¡¨å®šä¹‰

```dart
// lib/core/database/tables.dart

@DataClassName('OmikujiRecordData')
class OmikujiRecords extends Table {
  TextColumn get id => text()();
  TextColumn get transactionId => text()();  // å…³è”äº¤æ˜“
  TextColumn get level => text()();  // 'daikichi', 'chukichi', etc.
  TextColumn get message => text()();
  TextColumn get forecast => text()();  // JSONæ ¼å¼
  IntColumn get createdAt => integer()();

  @override
  Set<Column> get primaryKey => {id};
}

@DataClassName('GamificationSettingsData')
class GamificationSettings extends Table {
  TextColumn get id => text()();
  TextColumn get bookId => text()();
  BoolColumn get ohtaniConverterEnabled => boolean().withDefault(const Constant(true))();
  BoolColumn get omikujiEnabled => boolean().withDefault(const Constant(true))();
  BoolColumn get soulCelebrationEnabled => boolean().withDefault(const Constant(true))();

  @override
  Set<Column> get primaryKey => {id};
}
```

---

## 4. UI/UXè®¾è®¡

### 4.1 è®¾ç½®é¡µé¢ï¼ˆè¶£å‘³åŠŸèƒ½å¼€å…³ï¼‰

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ â† è®¾ç½®                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  è¶£å‘³åŠŸèƒ½                           â”‚
â”‚  â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”      â”‚
â”‚                                     â”‚
â”‚  âš¾ å¤§è°·ç¿”å¹³æ›ç®—å™¨                   â”‚
â”‚  [                            âœ“]   â”‚  â† å¼€å…³
â”‚  æ¶ˆè²»é‡‘é¡ã‚’é¢ç™½ãæ›ç®—               â”‚
â”‚                                     â”‚
â”‚  ğŸ´ é‹å‹¢å ã„                        â”‚
â”‚  [                            âœ“]   â”‚
â”‚  ãƒ¬ã‚·ãƒ¼ãƒˆå ã„ï¼†ä»Šæ—¥ã®é‹å‹¢           â”‚
â”‚                                     â”‚
â”‚  ğŸ’– é­‚æ¶ˆè²»ãŠç¥ã„                    â”‚
â”‚  [                            âœ“]   â”‚
â”‚  é­‚ã‚¢ã‚«ã‚¦ãƒ³ãƒˆæ”¯å‡ºæ™‚ã®ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³  â”‚
â”‚                                     â”‚
â”‚  â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”      â”‚
â”‚                                     â”‚
â”‚  âš ï¸ å…¨ã¦ã®è¶£å‘³åŠŸèƒ½ã‚’ç„¡åŠ¹ã«ã™ã‚‹      â”‚
â”‚  [æˆç†Ÿãƒ¢ãƒ¼ãƒ‰]                       â”‚  â† ä¸€é”®å…³é—­
â”‚                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 5. æŠ€æœ¯å®ç°æ–¹æ¡ˆ

### 5.1 OTAçƒ­æ›´æ–°

**æ¢ç®—å•ä½åº“çƒ­æ›´æ–°:**

```dart
// lib/features/gamification/data/ota_config_service.dart

class OTAConfigService {
  final http.Client _client;
  final String _configUrl = 'https://cdn.homepocket.app/config/conversion_units.json';

  Future<void> updateConversionUnits() async {
    try {
      final response = await _client.get(Uri.parse(_configUrl));

      if (response.statusCode == 200) {
        final json = jsonDecode(response.body);
        final version = json['version'];

        // æ£€æŸ¥ç‰ˆæœ¬æ˜¯å¦æ›´æ–°
        final currentVersion = await _prefs.getString('conversion_units_version');
        if (version != currentVersion) {
          // ä¿å­˜æ–°ç‰ˆæœ¬é…ç½®
          await _prefs.setString('conversion_units_json', response.body);
          await _prefs.setString('conversion_units_version', version);
        }
      }
    } catch (e) {
      // æ›´æ–°å¤±è´¥,ä½¿ç”¨æœ¬åœ°ç¼“å­˜
      print('OTAæ›´æ–°å¤±è´¥: $e');
    }
  }

  Future<List<ConversionUnit>> getUnits() async {
    // 1. å°è¯•ä»ç¼“å­˜è¯»å–
    final cachedJson = await _prefs.getString('conversion_units_json');

    if (cachedJson != null) {
      return _parseUnits(cachedJson);
    }

    // 2. å›é€€åˆ°å†…ç½®é…ç½®
    final defaultJson = await rootBundle.loadString('assets/config/conversion_units.json');
    return _parseUnits(defaultJson);
  }

  List<ConversionUnit> _parseUnits(String json) {
    final data = jsonDecode(json);
    return (data['units'] as List)
        .map((unit) => ConversionUnit.fromJson(unit))
        .toList();
  }
}
```

---

## 6. éªŒæ”¶æ ‡å‡†

### 6.1 åŠŸèƒ½å®Œæ•´æ€§

- âœ… å¤§è°·æ¢ç®—å™¨åœ¨äº¤æ˜“ä¿å­˜å0.5ç§’å†…æ˜¾ç¤º
- âœ… Toast 3ç§’åè‡ªåŠ¨æ¶ˆå¤±
- âœ… ç”¨æˆ·å¯åœ¨è®¾ç½®ä¸­å…³é—­è¶£å‘³åŠŸèƒ½
- âœ… å°ç¥¨å åœç¿»è½¬åŠ¨ç”»æµç•…ï¼ˆ60fpsï¼‰
- âœ… è¿åŠ¿ç­‰çº§æ¦‚ç‡åˆ†å¸ƒæ­£ç¡®
- âœ… åŒä¸€ç¬”äº¤æ˜“æ¯æ¬¡ç”Ÿæˆç›¸åŒè¿åŠ¿

### 6.2 A/Bæµ‹è¯•æŒ‡æ ‡

**å¯¹ç…§ç»„ï¼ˆæ— è¶£å‘³åŠŸèƒ½ï¼‰:**
- D7ç•™å­˜ç‡: åŸºå‡†å€¼
- æ¯æ—¥è®°è´¦ç¬”æ•°: åŸºå‡†å€¼
- NPSè¯„åˆ†: åŸºå‡†å€¼

**å®éªŒç»„ï¼ˆæœ‰è¶£å‘³åŠŸèƒ½ï¼‰:**
- D7ç•™å­˜ç‡: ç›®æ ‡ > åŸºå‡†å€¼ + 5%
- è¶£å‘³åŠŸèƒ½ä½¿ç”¨ç‡: ç›®æ ‡ > 50%
- ç”¨æˆ·åé¦ˆæƒ…ç»ª: ç›®æ ‡ > 70% æ­£é¢
- NPSè¯„åˆ†: ç›®æ ‡ â‰¥ åŸºå‡†å€¼

**Go/No-Goå†³ç­–:**
- âœ… ç»§ç»­: å®éªŒç»„D7ç•™å­˜ > å¯¹ç…§ç»„ + 5%ï¼Œä¸”NPS â‰¥ å¯¹ç…§ç»„
- âš ï¸ ä¼˜åŒ–: å®éªŒç»„D7ç•™å­˜ = å¯¹ç…§ç»„ Â± 3%ï¼Œéœ€è¦è°ƒæ•´æ–‡æ¡ˆ/è®¾è®¡
- âŒ ç§»é™¤: å®éªŒç»„D7ç•™å­˜ < å¯¹ç…§ç»„ - 5%ï¼Œæˆ–NPSæ˜¾è‘—ä¸‹é™

---

## 7. æµ‹è¯•ç”¨ä¾‹

### 7.1 å•å…ƒæµ‹è¯•

```dart
void main() {
  group('OhtaniConverter', () {
    test('should select suitable unit for amount', () async {
      // Given
      final amount = 1280;

      // When
      final message = await converter.convert(amount);

      // Then
      expect(message, isNotNull);
      expect(message, contains('æ¯'));  // åº”è¯¥åŒ¹é…å‰é‡å®¶ç‰›ä¸¼
    });

    test('should return null for amount out of range', () async {
      // Given
      final amount = 100000;  // è¶…è¿‡æ‰€æœ‰å•ä½çš„æœ€å¤§å€¼

      // When
      final message = await converter.convert(amount);

      // Then
      expect(message, isNull);
    });
  });

  group('GenerateOmikujiUseCase', () {
    test('should generate consistent result for same transaction', () async {
      // Given
      final tx = Transaction(id: 'tx-001', amount: 1280, /* ... */);

      // When
      final result1 = await useCase.execute(tx);
      final result2 = await useCase.execute(tx);

      // Then
      expect(result1.level, result2.level);
      expect(result1.message, result2.message);
    });

    test('should respect probability distribution', () async {
      // Given
      final results = <OmikujiLevel>[];

      // When - ç”Ÿæˆ1000æ¬¡
      for (var i = 0; i < 1000; i++) {
        final tx = Transaction(id: 'tx-$i', amount: i, /* ... */);
        final result = await useCase.execute(tx);
        results.add(result.level);
      }

      // Then - éªŒè¯æ¦‚ç‡åˆ†å¸ƒ
      final daikichi = results.where((l) => l == OmikujiLevel.daikichi).length;
      expect(daikichi, closeTo(50, 20));  // 5% Â± 2%
    });
  });
}
```

---

## 8. å¼€å‘é‡Œç¨‹ç¢‘ï¼ˆ7å¤©ï¼‰

| Day | ä»»åŠ¡ | äº§å‡º |
|-----|------|------|
| **Day 1** | å¤§è°·æ¢ç®—å™¨åŸºç¡€ | æ¢ç®—é€»è¾‘ã€Toast UI |
| **Day 2** | OTAé…ç½®ç³»ç»Ÿ | çƒ­æ›´æ–°æœºåˆ¶ã€å•ä½åº“ |
| **Day 3** | è¿åŠ¿ç®—æ³• | ç§å­ç”Ÿæˆã€æ¦‚ç‡åˆ†å¸ƒ |
| **Day 4** | å°ç¥¨å åœUI | ç¿»è½¬åŠ¨ç”»ã€ç­¾çº¸è®¾è®¡ |
| **Day 5** | ä»Šæ—¥è¿åŠ¿ | ä¸»åŠ¨è§¦å‘æµç¨‹ã€å¹¿å‘Šé›†æˆ |
| **Day 6** | è®¾ç½®é¡µé¢ | å¼€å…³ã€æˆç†Ÿæ¨¡å¼ |
| **Day 7** | A/Bæµ‹è¯•åŸ‹ç‚¹ | æ•°æ®æ”¶é›†ã€åˆ†æä»ªè¡¨ç›˜ |

---

**æ–‡æ¡£çŠ¶æ€:** å®Œæˆ
**å®¡æ ¸çŠ¶æ€:** å¾…è¯„å®¡

**é‡è¦æé†’:**
âš ï¸ æœ¬æ¨¡å—ä¸ºP2ä¼˜å…ˆçº§,**ä»…å½“Betaæµ‹è¯•éªŒè¯ç”¨æˆ·æ¥å—åº¦>60%æ—¶æ‰åŒ…å«åœ¨MVPä¸­**ã€‚
å¦‚æœA/Bæµ‹è¯•ç»“æœä¸ç†æƒ³,åº”ç«‹å³ç§»é™¤ä»¥é¿å…å½±å“æ ¸å¿ƒç”¨æˆ·ä½“éªŒã€‚

**å˜æ›´æ—¥å¿—:**
- 2026-02-03: åˆç‰ˆå®Œæˆï¼ˆåŒ…å«A/Bæµ‹è¯•å†³ç­–æ¡†æ¶ï¼‰
