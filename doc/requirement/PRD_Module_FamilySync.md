# PRD - å®¶åº­åŒæ­¥æ¨¡å—

**æ¨¡å—ID:** MOD-004
**æ¨¡å—åç§°:** å®¶åº­åŒæ­¥æ¨¡å—
**ç‰ˆæœ¬:** 1.0
**åˆ›å»ºæ—¥æœŸ:** 2026å¹´2æœˆ3æ—¥
**ä¼˜å…ˆçº§:** P0ï¼ˆMVPå¿…å¤‡ï¼‰
**é¢„ä¼°å·¥æ—¶:** 12å¤©

---

## 1. æ¨¡å—æ¦‚è¿°

### 1.1 åŠŸèƒ½å®šä¹‰

å®¶åº­åŒæ­¥æ¨¡å—å®ç°è®¾å¤‡é—´çš„å®‰å…¨æ•°æ®åŒæ­¥,æ”¯æŒå¤«å¦»/æƒ…ä¾£å…±äº«è´¦æœ¬ã€‚åŒ…æ‹¬:

- **è®¾å¤‡é…å¯¹ï¼ˆB01ï¼‰:** QRç é¢å¯¹é¢é…å¯¹ï¼ˆMVPï¼‰ã€è¿œç¨‹çŸ­ç é…å¯¹ï¼ˆV1.0ï¼‰
- **æ•°æ®åŒæ­¥ï¼ˆB03ï¼‰:** æœ¬åœ°ç›´è¿åŒæ­¥ã€å†²çªè§£å†³ã€ç¦»çº¿é˜Ÿåˆ—
- **å®¶åº­å†…éƒ¨è½¬è´¦ï¼ˆB05ï¼‰:** ä¸¤é˜¶æ®µæäº¤ã€çŠ¶æ€è¿½è¸ª
- **ä¼´ä¾£éšç§ä¿æŠ¤:** çµé­‚è´¦æˆ·æ˜ç»†éšè—ã€ç§å¯†äº¤æ˜“æ ‡è®°
- **åŒæ­¥åè®®:** ä½¿ç”¨Yjs CRDTåº“ï¼ˆä¸è‡ªç ”ï¼‰

**æ ¸å¿ƒä»·å€¼ä¸»å¼ :**
å¤«å¦»å…±åŒç®¡ç†å®¶åº­å¼€æ”¯,åŒæ—¶ä¿æŠ¤ä¸ªäººéšç§ã€‚é€šè¿‡E2EEå’Œæœ¬åœ°ä¼˜å…ˆæ¶æ„,å®ç°"å…±äº«é€æ˜"ä¸"ä¸ªäººç©ºé—´"çš„å¹³è¡¡ã€‚

### 1.2 ç”¨æˆ·åœºæ™¯ä¸ç—›ç‚¹

**ç”¨æˆ·ç”»åƒ:**
- ç”°ä¸­å’Œç¾æƒ ï¼ˆ35å²å¤«å¦‡ï¼‰
- å…±åŒæ‰¿æ‹…æˆ¿ç§Ÿã€æ°´ç”µç­‰å®¶åº­å¼€æ”¯
- å„æœ‰çˆ±å¥½é¢„ç®—ï¼ˆç”°ä¸­ä¹°é«˜è¾¾,ç¾æƒ ä¹°åŒ–å¦†å“ï¼‰

**ç—›ç‚¹:**
1. **è®°è´¦ä¸åŒæ­¥:** ç”°ä¸­åœ¨æ‰‹æœºä¸Šè®°äº†è´¦,ç¾æƒ çœ‹ä¸åˆ°,å¯¼è‡´é‡å¤è®°è´¦æˆ–é—æ¼
2. **éšç§å†²çª:** ä¼ ç»Ÿå®¶åº­è´¦æœ¬è¦æ±‚å®Œå…¨é€æ˜,ä½†ä¸ªäººçˆ±å¥½æ¶ˆè´¹ä¸æƒ³è®©å¯¹æ–¹çŸ¥é“ç»†èŠ‚
3. **è½¬è´¦éº»çƒ¦:** å¾®ä¿¡è½¬è´¦åè¿˜è¦æ‰‹åŠ¨åœ¨è®°è´¦åº”ç”¨ä¸­è®°å½•,å®¹æ˜“å¿˜è®°
4. **ç¦»çº¿é—®é¢˜:** å‡ºé—¨åœ¨å¤–æ²¡æœ‰ç½‘ç»œæ—¶æ— æ³•åŒæ­¥

**Home Pocketè§£å†³æ–¹æ¡ˆ:**
- æœ¬åœ°ç›´è¿åŒæ­¥ï¼ˆè“ç‰™/NFC/WiFiï¼‰,æ— éœ€æœåŠ¡å™¨
- çµé­‚è´¦æˆ·ä¿æŠ¤éšç§ï¼ˆåªæ˜¾ç¤ºè¿›åº¦,ä¸æ˜¾ç¤ºæ˜ç»†ï¼‰
- å®¶åº­å†…éƒ¨è½¬è´¦è‡ªåŠ¨åˆ›å»ºåŒæ–¹è®°å½•
- ç¦»çº¿é˜Ÿåˆ—,ä¸Šçº¿åè‡ªåŠ¨åŒæ­¥

### 1.3 ä¸å…¶ä»–æ¨¡å—çš„ä¾èµ–å…³ç³»

**å‰ç½®ä¾èµ–:**
- MOD-006 å®‰å…¨ä¸éšç§ï¼ˆéœ€è¦å¯†é’¥äº¤æ¢ï¼‰
- MOD-001 åŸºç¡€è®°è´¦ï¼ˆéœ€è¦äº¤æ˜“æ•°æ®ï¼‰

**è¢«ä¾èµ–:**
- MOD-007 æ•°æ®åˆ†æï¼ˆå®¶åº­æŠ¥è¡¨ï¼‰
- MOD-003 åŒè½¨è´¦æœ¬ï¼ˆä¼´ä¾£éšç§è®¾ç½®ï¼‰

---

## 2. è¯¦ç»†åŠŸèƒ½è§„æ ¼

### 2.1 B01: è®¾å¤‡é…å¯¹

#### 2.1.1 æ–¹å¼ä¸€ï¼šé¢å¯¹é¢QRç ï¼ˆMVPå®ç°ï¼‰

**é…å¯¹æµç¨‹:**

```
Device A (å‘èµ·æ–¹)                Device B (æ¥æ”¶æ–¹)
     â”‚                               â”‚
     â”œâ”€ ç”ŸæˆQRç  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º  â”‚
     â”‚  (å«å…¬é’¥+book_id+nonce)       â”‚ æ‰«æQRç 
     â”‚                               â”‚
     â”‚â—„â”€â”€â”€â”€â”€â”€ æ¡æ‰‹è¯·æ±‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
     â”‚  (Bçš„å…¬é’¥+ç­¾å)               â”‚
     â”‚                               â”‚
     â”œâ”€ éªŒè¯ç­¾å â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º  â”‚
     â”‚  éªŒè¯Bçš„èº«ä»½                  â”‚
     â”‚                               â”‚
     â”œâ”€ ç¡®è®¤é…å¯¹ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º  â”‚
     â”‚  (Açš„ç­¾å)                    â”‚
     â”‚                               â”‚
  [ä¿å­˜ä¼´ä¾£å…¬é’¥]                  [ä¿å­˜ä¼´ä¾£å…¬é’¥]
     â”‚                               â”‚
  [å¼€å§‹åŒæ­¥]                      [å¼€å§‹åŒæ­¥]
```

**QRç æ•°æ®ç»“æ„:**

```dart
// lib/features/family_sync/domain/models/pairing_qr_data.dart

class PairingQRData {
  final String bookId;           // è´¦æœ¬ID
  final String deviceId;         // è®¾å¤‡ID
  final String publicKey;        // å…¬é’¥ï¼ˆBase64ï¼‰
  final String deviceName;       // è®¾å¤‡æ˜µç§°
  final String nonce;            // éšæœºæ•°ï¼ˆé˜²é‡æ”¾æ”»å‡»ï¼‰
  final int expiresAt;          // è¿‡æœŸæ—¶é—´ï¼ˆ5åˆ†é’Ÿï¼‰

  String toJSON() {
    return jsonEncode({
      'v': 1,  // ç‰ˆæœ¬å·
      'b': bookId,
      'd': deviceId,
      'pk': publicKey,
      'n': deviceName,
      'nonce': nonce,
      'exp': expiresAt,
    });
  }

  factory PairingQRData.fromJSON(String json) {
    final data = jsonDecode(json);
    return PairingQRData(
      bookId: data['b'],
      deviceId: data['d'],
      publicKey: data['pk'],
      deviceName: data['n'],
      nonce: data['nonce'],
      expiresAt: data['exp'],
    );
  }

  bool get isExpired => DateTime.now().millisecondsSinceEpoch > expiresAt;
}
```

**å®ç°ä»£ç :**

```dart
// lib/features/family_sync/domain/use_cases/generate_pairing_qr.dart

class GeneratePairingQRUseCase {
  final KeyManager _keyManager;
  final BookRepository _bookRepo;

  Future<String> execute(String bookId) async {
    // 1. è·å–å½“å‰è®¾å¤‡ä¿¡æ¯
    final deviceId = await _keyManager.getDeviceId();
    final publicKey = await _keyManager.getPublicKey();
    final deviceName = await _getDeviceName();

    // 2. ç”Ÿæˆéšæœºæ•°ï¼ˆé˜²é‡æ”¾ï¼‰
    final nonce = _generateNonce();

    // 3. è®¾ç½®è¿‡æœŸæ—¶é—´ï¼ˆ5åˆ†é’Ÿï¼‰
    final expiresAt = DateTime.now()
        .add(Duration(minutes: 5))
        .millisecondsSinceEpoch;

    // 4. æ„é€ QRç æ•°æ®
    final qrData = PairingQRData(
      bookId: bookId,
      deviceId: deviceId!,
      publicKey: publicKey!,
      deviceName: deviceName,
      nonce: nonce,
      expiresAt: expiresAt,
    );

    // 5. è¿”å›JSONå­—ç¬¦ä¸²
    return qrData.toJSON();
  }

  String _generateNonce() {
    final random = Random.secure();
    final bytes = List.generate(16, (_) => random.nextInt(256));
    return base64Encode(bytes);
  }

  Future<String> _getDeviceName() async {
    final deviceInfo = DeviceInfoPlugin();
    if (Platform.isIOS) {
      final iosInfo = await deviceInfo.iosInfo;
      return '${iosInfo.name}ã®${iosInfo.model}';
    } else {
      final androidInfo = await deviceInfo.androidInfo;
      return '${androidInfo.manufacturer} ${androidInfo.model}';
    }
  }
}
```

**æ‰«æå¹¶é…å¯¹:**

```dart
// lib/features/family_sync/domain/use_cases/pair_with_device.dart

class PairWithDeviceUseCase {
  final KeyManager _keyManager;
  final BookRepository _bookRepo;
  final DeviceRepository _deviceRepo;

  Future<PairingResult> execute(String qrCode) async {
    try {
      // 1. è§£æQRç 
      final qrData = PairingQRData.fromJSON(qrCode);

      // 2. éªŒè¯è¿‡æœŸæ—¶é—´
      if (qrData.isExpired) {
        return PairingResult.expired();
      }

      // 3. éªŒè¯è´¦æœ¬æƒé™ï¼ˆç¡®ä¿æ˜¯åŒä¸€ä¸ªè´¦æœ¬ï¼‰
      final currentBookId = await _bookRepo.getCurrentBookId();
      if (currentBookId != qrData.bookId) {
        return PairingResult.bookMismatch();
      }

      // 4. éªŒè¯å¯¹æ–¹å…¬é’¥ç­¾åï¼ˆç¡®ä¿æ˜¯çœŸå®è®¾å¤‡ï¼‰
      final isValid = await _verifySignature(qrData);
      if (!isValid) {
        return PairingResult.invalidSignature();
      }

      // 5. ä¿å­˜ä¼´ä¾£è®¾å¤‡ä¿¡æ¯
      await _deviceRepo.addPartnerDevice(
        Device(
          id: qrData.deviceId,
          bookId: qrData.bookId,
          publicKey: qrData.publicKey,
          name: qrData.deviceName,
          role: DeviceRole.partner,
          pairedAt: DateTime.now(),
        ),
      );

      // 6. å‘é€æ¡æ‰‹ç¡®è®¤ï¼ˆé€šè¿‡è“ç‰™/NFCï¼‰
      await _sendHandshake(qrData);

      return PairingResult.success(
        partnerDeviceId: qrData.deviceId,
        partnerDeviceName: qrData.deviceName,
      );
    } catch (e) {
      return PairingResult.error(e.toString());
    }
  }

  Future<bool> _verifySignature(PairingQRData qrData) async {
    // TODO: å®ç°ç­¾åéªŒè¯é€»è¾‘
    // éœ€è¦å¯¹æ–¹è®¾å¤‡å‘é€ç­¾åæ•°æ®
    return true;
  }

  Future<void> _sendHandshake(PairingQRData qrData) async {
    // TODO: é€šè¿‡è“ç‰™/NFCå‘é€æ¡æ‰‹æ¶ˆæ¯
  }
}

class PairingResult {
  final PairingStatus status;
  final String? partnerDeviceId;
  final String? partnerDeviceName;
  final String? errorMessage;

  PairingResult.success({
    required this.partnerDeviceId,
    required this.partnerDeviceName,
  })  : status = PairingStatus.success,
        errorMessage = null;

  PairingResult.expired()
      : status = PairingStatus.expired,
        partnerDeviceId = null,
        partnerDeviceName = null,
        errorMessage = 'QRã‚³ãƒ¼ãƒ‰ã®æœ‰åŠ¹æœŸé™ãŒåˆ‡ã‚Œã¾ã—ãŸ';

  PairingResult.bookMismatch()
      : status = PairingStatus.bookMismatch,
        partnerDeviceId = null,
        partnerDeviceName = null,
        errorMessage = 'å¸³ç°¿ãŒä¸€è‡´ã—ã¾ã›ã‚“';

  PairingResult.invalidSignature()
      : status = PairingStatus.invalidSignature,
        partnerDeviceId = null,
        partnerDeviceName = null,
        errorMessage = 'ç½²åãŒç„¡åŠ¹ã§ã™';

  PairingResult.error(String message)
      : status = PairingStatus.error,
        partnerDeviceId = null,
        partnerDeviceName = null,
        errorMessage = message;
}

enum PairingStatus {
  success,
  expired,
  bookMismatch,
  invalidSignature,
  error,
}
```

**UIè®¾è®¡:**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ â† è®¾å¤‡é…å¯¹                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                     â”‚
â”‚  æ–¹å¼ä¸€ï¼šé¢å¯¹é¢é…å¯¹                  â”‚
â”‚  â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”      â”‚
â”‚                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚                             â”‚    â”‚
â”‚  â”‚      [QRç æ˜¾ç¤º]             â”‚    â”‚  â† ç”ŸæˆQRç 
â”‚  â”‚                             â”‚    â”‚
â”‚  â”‚   â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ      â”‚    â”‚
â”‚  â”‚   â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ      â”‚    â”‚
â”‚  â”‚   â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ      â”‚    â”‚
â”‚  â”‚                             â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                     â”‚
â”‚  è¯·è®©ä¼´ä¾£æ‰«ææ­¤QRç                   â”‚
â”‚  æœ‰æ•ˆæœŸï¼š4:32                        â”‚  â† å€’è®¡æ—¶
â”‚                                     â”‚
â”‚  [é‡æ–°ç”Ÿæˆ]                         â”‚
â”‚                                     â”‚
â”‚  â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”      â”‚
â”‚                                     â”‚
â”‚  æˆ–è€…æ‰«æä¼´ä¾£çš„QRç ï¼š                â”‚
â”‚  [ğŸ“· æ‰“å¼€ç›¸æœºæ‰«æ]                  â”‚
â”‚                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**æ‰«ææˆåŠŸæç¤º:**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  é…å¯¹æˆåŠŸï¼                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                     â”‚
â”‚           âœ“                         â”‚
â”‚                                     â”‚
â”‚  å·²ä¸ä»¥ä¸‹è®¾å¤‡é…å¯¹ï¼š                  â”‚
â”‚                                     â”‚
â”‚  ğŸ“± ç¾æƒ ã®iPhone 14 Pro            â”‚
â”‚  è®¾å¤‡ID: abc123def456               â”‚
â”‚                                     â”‚
â”‚  ç°åœ¨ä½ ä»¬å¯ä»¥å…±äº«è´¦æœ¬äº†ï¼            â”‚
â”‚                                     â”‚
â”‚  [å¼€å§‹åŒæ­¥]                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### 2.1.2 æ–¹å¼äºŒï¼šè¿œç¨‹çŸ­ç ï¼ˆV1.0åæœŸï¼‰

**é…å¯¹æµç¨‹:**

```
Device A           Relay Server       Device B
   â”‚                     â”‚                 â”‚
   â”œâ”€ è¯·æ±‚çŸ­ç  â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚                 â”‚
   â”‚                     â”‚                 â”‚
   â”‚â—„â”€ è¿”å›123456 â”€â”€â”€â”€â”€â”€â”€â”¤                 â”‚
   â”‚                     â”‚                 â”‚
   â”‚  [é€šè¿‡Lineå‘é€]     â”‚                 â”‚
   â”‚                     â”‚                 â”‚
   â”‚                     â”‚â—„â”€â”€â”€ è¾“å…¥çŸ­ç  â”€â”€â”€â”€â”¤
   â”‚                     â”‚                 â”‚
   â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ äº¤æ¢å…¬é’¥ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚
   â”‚      (ç«¯åˆ°ç«¯åŠ å¯†)   â”‚                 â”‚
   â”‚                     â”‚                 â”‚
[é…å¯¹å®Œæˆ]                              [é…å¯¹å®Œæˆ]
```

**æ³¨æ„:** MVPé˜¶æ®µä¸å®ç°,V1.0å†è€ƒè™‘ã€‚

---

### 2.2 B03: æ•°æ®åŒæ­¥

#### 2.2.1 åŒæ­¥åè®®ï¼ˆä½¿ç”¨Yjs CRDTï¼‰

**ä¸ºä»€ä¹ˆä½¿ç”¨Yjs?**
- æˆç†Ÿçš„CRDTåº“,æ— éœ€è‡ªç ”å†²çªè§£å†³ç®—æ³•
- æ”¯æŒç¦»çº¿ç¼–è¾‘+è‡ªåŠ¨åˆå¹¶
- è½»é‡çº§ï¼ˆ<50KB gzippedï¼‰
- æ”¯æŒDart/Flutterï¼ˆé€šè¿‡y-crdt Rustç»‘å®šï¼‰

**æŠ€æœ¯æ¶æ„:**

```dart
// lib/features/family_sync/data/sync_engine.dart

import 'package:y_crdt/y_crdt.dart';

class SyncEngine {
  late YDoc _doc;
  final String _bookId;
  final ConnectionManager _connectionManager;

  Future<void> initialize() async {
    // 1. åˆ›å»ºYjsæ–‡æ¡£
    _doc = YDoc();

    // 2. å®šä¹‰å…±äº«æ•°æ®ç»“æ„
    final transactions = _doc.getArray('transactions');
    final categories = _doc.getArray('categories');

    // 3. ç›‘å¬æœ¬åœ°å˜æ›´
    _doc.on('update', (update, origin) {
      if (origin != 'remote') {
        _syncUpdate(update);
      }
    });

    // 4. åŠ è½½æœ¬åœ°çŠ¶æ€
    await _loadLocalState();
  }

  /// åŒæ­¥æœ¬åœ°å˜æ›´åˆ°ä¼´ä¾£è®¾å¤‡
  Future<void> _syncUpdate(Uint8List update) async {
    final partnerDevices = await _deviceRepo.getPartnerDevices(_bookId);

    for (final device in partnerDevices) {
      try {
        // é€šè¿‡è“ç‰™/WiFiå‘é€æ›´æ–°
        await _connectionManager.sendUpdate(
          deviceId: device.id,
          update: update,
        );
      } catch (e) {
        // å‘é€å¤±è´¥,åŠ å…¥ç¦»çº¿é˜Ÿåˆ—
        await _queueOfflineUpdate(device.id, update);
      }
    }
  }

  /// æ¥æ”¶ä¼´ä¾£è®¾å¤‡çš„å˜æ›´
  Future<void> receiveUpdate(Uint8List update) async {
    // 1. åº”ç”¨æ›´æ–°åˆ°Yjsæ–‡æ¡£
    YDoc.applyUpdate(_doc, update, origin: 'remote');

    // 2. æå–å˜æ›´çš„äº¤æ˜“
    final transactions = _doc.getArray('transactions');
    final changes = _extractChanges(transactions);

    // 3. å†™å…¥æœ¬åœ°æ•°æ®åº“
    for (final tx in changes) {
      await _transactionRepo.upsert(tx);
    }

    // 4. è§¦å‘UIåˆ·æ–°
    _notifyListeners();
  }
}
```

**è¿æ¥ç®¡ç†å™¨ï¼ˆè“ç‰™ä¼˜å…ˆï¼‰:**

```dart
// lib/features/family_sync/data/connection_manager.dart

class ConnectionManager {
  final FlutterBlue _bluetooth = FlutterBlue.instance;
  final NFC _nfc = NFC();

  /// è¿æ¥åˆ°ä¼´ä¾£è®¾å¤‡
  Future<Connection?> connect(String deviceId) async {
    // 1. å°è¯•è“ç‰™è¿æ¥
    final bluetoothConnection = await _connectViaBluetooth(deviceId);
    if (bluetoothConnection != null) {
      return bluetoothConnection;
    }

    // 2. å°è¯•NFCè¿æ¥
    final nfcConnection = await _connectViaNFC(deviceId);
    if (nfcConnection != null) {
      return nfcConnection;
    }

    // 3. å°è¯•æœ¬åœ°WiFiè¿æ¥
    final wifiConnection = await _connectViaWiFi(deviceId);
    return wifiConnection;
  }

  Future<BluetoothConnection?> _connectViaBluetooth(String deviceId) async {
    // æ‰«æé™„è¿‘çš„è“ç‰™è®¾å¤‡
    await _bluetooth.startScan(timeout: Duration(seconds: 5));

    final results = await _bluetooth.scanResults.first;
    for (final result in results) {
      if (result.device.id.toString() == deviceId) {
        final device = result.device;
        await device.connect();

        return BluetoothConnection(device);
      }
    }

    return null;
  }

  Future<void> sendUpdate({
    required String deviceId,
    required Uint8List update,
  }) async {
    final connection = await connect(deviceId);
    if (connection == null) {
      throw ConnectionException('æ— æ³•è¿æ¥åˆ°è®¾å¤‡ $deviceId');
    }

    await connection.send(update);
  }
}
```

#### 2.2.2 åŒæ­¥æ—¶æœº

**è‡ªåŠ¨åŒæ­¥:**
- æ¯æ—¥10æ¬¡å…è´¹è‡ªåŠ¨åŒæ­¥ï¼ˆæ¯2.4å°æ—¶ä¸€æ¬¡ï¼‰
- ä»…åœ¨åº”ç”¨æ‰“å¼€ä¸”æœ‰è¿æ¥æ—¶è§¦å‘

**æ‰‹åŠ¨åŒæ­¥:**
- ç”¨æˆ·ç‚¹å‡»"ç«‹å³åŒæ­¥"æŒ‰é’®
- åˆ›å»ºäº¤æ˜“åæç¤ºåŒæ­¥

**äº‹ä»¶è§¦å‘:**
- æ£€æµ‹åˆ°ä¼´ä¾£è®¾å¤‡åœ¨é™„è¿‘ï¼ˆè“ç‰™ä¿¡å·ï¼‰
- ä»åå°æ¢å¤åˆ°å‰å°

**å®ç°ä»£ç :**

```dart
// lib/features/family_sync/domain/use_cases/auto_sync.dart

class AutoSyncUseCase {
  final SyncEngine _syncEngine;
  final SettingsRepository _settingsRepo;
  Timer? _timer;

  Future<void> start() async {
    final settings = await _settingsRepo.getSettings();

    if (!settings.autoSyncEnabled) {
      return;
    }

    // æ¯2.4å°æ—¶åŒæ­¥ä¸€æ¬¡ï¼ˆæ¯æ—¥10æ¬¡ï¼‰
    final interval = Duration(hours: 2, minutes: 24);

    _timer = Timer.periodic(interval, (timer) async {
      if (await _shouldSync()) {
        await _syncEngine.sync();
      }
    });
  }

  Future<bool> _shouldSync() async {
    // 1. æ£€æŸ¥åº”ç”¨æ˜¯å¦åœ¨å‰å°
    final appState = WidgetsBinding.instance.lifecycleState;
    if (appState != AppLifecycleState.resumed) {
      return false;
    }

    // 2. æ£€æŸ¥æ˜¯å¦æœ‰æœªåŒæ­¥çš„æ•°æ®
    final hasUnsyncedData = await _syncEngine.hasUnsyncedData();
    if (!hasUnsyncedData) {
      return false;
    }

    // 3. æ£€æŸ¥æ˜¯å¦æœ‰å¯ç”¨è¿æ¥
    final hasConnection = await _syncEngine.hasActiveConnection();
    if (!hasConnection) {
      return false;
    }

    return true;
  }

  void stop() {
    _timer?.cancel();
  }
}
```

#### 2.2.3 å†²çªè§£å†³

**Yjsè‡ªåŠ¨è§£å†³çš„å†²çª:**
- **Last-Write-Winsï¼ˆLWWï¼‰:** æ—¶é—´æˆ³å†³å®šæœ€ç»ˆå€¼
- **Operation Transformation:** æ“ä½œè½¬æ¢
- **Causal Consistency:** å› æœä¸€è‡´æ€§

**éœ€è¦ç”¨æˆ·å¹²é¢„çš„å†²çª:**

1. **åŒä¸€ç¬”æ¶ˆè´¹è¢«é‡å¤è®°å½•:**
```
Device A: Â¥1,280 @ å‰é‡å®¶ (14:30)
Device B: Â¥1,280 @ å‰é‡å®¶ (14:31)

ç³»ç»Ÿæ£€æµ‹: é‡‘é¢ç›¸åŒã€æ—¶é—´ç›¸è¿‘ï¼ˆÂ±5åˆ†é’Ÿï¼‰ã€å•†å®¶ç›¸åŒ
æç¤º: "è¿™ç¬”æ¶ˆè´¹å¯èƒ½è¢«é‡å¤è®°å½•ï¼Œéœ€è¦åˆå¹¶å—ï¼Ÿ"
```

2. **å®¶åº­å†…éƒ¨è½¬è´¦çŠ¶æ€ä¸ä¸€è‡´:**
```
Device A: è½¬è´¦ Â¥5,000 (å¾…ç¡®è®¤)
Device B: æœªæ”¶åˆ°é€šçŸ¥

ç³»ç»Ÿæ£€æµ‹: 24å°æ—¶åä»æœªç¡®è®¤
æç¤º: "è½¬è´¦è¯·æ±‚å·²è¶…æ—¶ï¼Œéœ€è¦é‡æ–°å‘é€å—ï¼Ÿ"
```

**å®ç°ä»£ç :**

```dart
// lib/features/family_sync/domain/use_cases/detect_conflicts.dart

class DetectConflictsUseCase {
  final TransactionRepository _transactionRepo;

  Future<List<Conflict>> execute(String bookId) async {
    final conflicts = <Conflict>[];

    // æ£€æµ‹é‡å¤äº¤æ˜“
    final duplicates = await _detectDuplicateTransactions(bookId);
    conflicts.addAll(duplicates);

    // æ£€æµ‹è½¬è´¦å†²çª
    final transferConflicts = await _detectTransferConflicts(bookId);
    conflicts.addAll(transferConflicts);

    return conflicts;
  }

  Future<List<Conflict>> _detectDuplicateTransactions(String bookId) async {
    final transactions = await _transactionRepo.getTransactions(
      bookId: bookId,
      startDate: DateTime.now().subtract(Duration(days: 7)),
    );

    final duplicates = <Conflict>[];

    for (var i = 0; i < transactions.length; i++) {
      for (var j = i + 1; j < transactions.length; j++) {
        final tx1 = transactions[i];
        final tx2 = transactions[j];

        if (_isPotentialDuplicate(tx1, tx2)) {
          duplicates.add(Conflict.duplicate(tx1, tx2));
        }
      }
    }

    return duplicates;
  }

  bool _isPotentialDuplicate(Transaction tx1, Transaction tx2) {
    // 1. é‡‘é¢ç›¸åŒ
    if (tx1.amount != tx2.amount) return false;

    // 2. æ—¶é—´ç›¸è¿‘ï¼ˆÂ±5åˆ†é’Ÿï¼‰
    final timeDiff = tx1.timestamp.difference(tx2.timestamp).abs();
    if (timeDiff > Duration(minutes: 5)) return false;

    // 3. åˆ†ç±»ç›¸åŒæˆ–å•†å®¶ç›¸åŒ
    if (tx1.categoryId == tx2.categoryId) return true;
    if (tx1.note != null && tx2.note != null) {
      if (tx1.note!.contains(tx2.note!) || tx2.note!.contains(tx1.note!)) {
        return true;
      }
    }

    return false;
  }
}

class Conflict {
  final ConflictType type;
  final List<Transaction> relatedTransactions;

  Conflict.duplicate(Transaction tx1, Transaction tx2)
      : type = ConflictType.duplicate,
        relatedTransactions = [tx1, tx2];

  Conflict.transferTimeout(Transaction tx)
      : type = ConflictType.transferTimeout,
        relatedTransactions = [tx];
}

enum ConflictType {
  duplicate,
  transferTimeout,
}
```

---

### 2.3 B05: å®¶åº­å†…éƒ¨è½¬è´¦

#### 2.3.1 ä¸¤é˜¶æ®µæäº¤åè®®

**è½¬è´¦æµç¨‹:**

```
Device A (å‘èµ·æ–¹)          Device B (æ¥æ”¶æ–¹)
     â”‚                         â”‚
     â”œâ”€ REQUEST â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º â”‚
     â”‚  "è½¬è´¦Â¥5000"            â”‚
     â”‚                         â”‚
     â”‚                    æ˜¾ç¤ºé€šçŸ¥
     â”‚                    "TAè¯·æ±‚è½¬è´¦"
     â”‚                         â”‚
     â”‚â—„â”€â”€â”€â”€â”€â”€ CONFIRM â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
     â”‚  "åŒæ„"                 â”‚
     â”‚                         â”‚
åŒæ–¹å„è‡ªåˆ›å»ºè½¬è´¦è®°å½•
     â”œâ”€ æ”¯å‡º -Â¥5000            â”‚
     â”‚                    æ”¶å…¥ +Â¥5000
     â”‚                         â”‚
  [åŒæ­¥]                    [åŒæ­¥]
```

**çŠ¶æ€æœº:**

```
PENDING (24hè¶…æ—¶)
   â”œâ”€ CONFIRMED (åŒæ–¹ç¡®è®¤)
   â”œâ”€ REJECTED (ä¸€æ–¹æ‹’ç»)
   â””â”€ EXPIRED (è¶…æ—¶æœªå¤„ç†)
```

**æ•°æ®æ¨¡å‹:**

```dart
// lib/features/family_sync/data/models/internal_transfer.dart

@DataClassName('InternalTransferData')
class InternalTransfers extends Table {
  TextColumn get id => text()();
  TextColumn get bookId => text()();
  TextColumn get fromDeviceId => text()();  // å‘èµ·æ–¹
  TextColumn get toDeviceId => text()();    // æ¥æ”¶æ–¹
  IntColumn get amount => integer()();
  TextColumn get reason => text().nullable()();
  TextColumn get status => text()();  // 'pending', 'confirmed', 'rejected', 'expired'
  IntColumn get requestedAt => integer()();
  IntColumn get respondedAt => integer().nullable()();
  IntColumn get expiresAt => integer()();  // 24å°æ—¶åè¿‡æœŸ

  @override
  Set<Column> get primaryKey => {id};
}
```

**å®ç°ä»£ç :**

```dart
// lib/features/family_sync/domain/use_cases/request_transfer.dart

class RequestTransferUseCase {
  final InternalTransferRepository _transferRepo;
  final ConnectionManager _connectionManager;
  final KeyManager _keyManager;

  Future<TransferRequestResult> execute({
    required String partnerDeviceId,
    required int amount,
    String? reason,
  }) async {
    // 1. åˆ›å»ºè½¬è´¦è¯·æ±‚
    final deviceId = await _keyManager.getDeviceId();
    final bookId = await _bookRepo.getCurrentBookId();

    final transfer = InternalTransfer(
      id: uuid.v4(),
      bookId: bookId,
      fromDeviceId: deviceId!,
      toDeviceId: partnerDeviceId,
      amount: amount,
      reason: reason,
      status: TransferStatus.pending,
      requestedAt: DateTime.now(),
      expiresAt: DateTime.now().add(Duration(hours: 24)),
    );

    // 2. ä¿å­˜åˆ°æœ¬åœ°æ•°æ®åº“
    await _transferRepo.insert(transfer);

    // 3. å‘é€è¯·æ±‚åˆ°ä¼´ä¾£è®¾å¤‡
    try {
      await _connectionManager.sendTransferRequest(
        deviceId: partnerDeviceId,
        transfer: transfer,
      );

      return TransferRequestResult.sent(transfer.id);
    } catch (e) {
      // å‘é€å¤±è´¥,æ ‡è®°ä¸ºç¦»çº¿é˜Ÿåˆ—
      await _transferRepo.update(
        transfer.id,
        status: TransferStatus.queued,
      );

      return TransferRequestResult.queued(transfer.id);
    }
  }
}

// lib/features/family_sync/domain/use_cases/respond_transfer.dart

class RespondTransferUseCase {
  Future<void> confirm(String transferId) async {
    // 1. æ›´æ–°è½¬è´¦çŠ¶æ€
    await _transferRepo.update(
      transferId,
      status: TransferStatus.confirmed,
      respondedAt: DateTime.now(),
    );

    // 2. åˆ›å»ºåŒæ–¹äº¤æ˜“è®°å½•
    final transfer = await _transferRepo.getById(transferId);

    // å‘èµ·æ–¹ï¼šæ”¯å‡º
    await _transactionRepo.insert(
      Transaction(
        id: uuid.v4(),
        bookId: transfer.bookId,
        deviceId: transfer.fromDeviceId,
        amount: transfer.amount,
        type: TransactionType.transfer,
        categoryId: 'transfer_out',
        note: 'è½¬è´¦ç»™ä¼´ä¾£: ${transfer.reason ?? ""}',
        timestamp: DateTime.now(),
        // ... å…¶ä»–å­—æ®µ
      ),
    );

    // æ¥æ”¶æ–¹ï¼šæ”¶å…¥
    await _transactionRepo.insert(
      Transaction(
        id: uuid.v4(),
        bookId: transfer.bookId,
        deviceId: transfer.toDeviceId,
        amount: transfer.amount,
        type: TransactionType.transfer,
        categoryId: 'transfer_in',
        note: 'æ¥è‡ªä¼´ä¾£çš„è½¬è´¦: ${transfer.reason ?? ""}',
        timestamp: DateTime.now(),
        // ... å…¶ä»–å­—æ®µ
      ),
    );

    // 3. é€šçŸ¥å‘èµ·æ–¹
    await _connectionManager.sendTransferResponse(
      deviceId: transfer.fromDeviceId,
      transferId: transferId,
      accepted: true,
    );
  }

  Future<void> reject(String transferId) async {
    await _transferRepo.update(
      transferId,
      status: TransferStatus.rejected,
      respondedAt: DateTime.now(),
    );

    final transfer = await _transferRepo.getById(transferId);
    await _connectionManager.sendTransferResponse(
      deviceId: transfer.fromDeviceId,
      transferId: transferId,
      accepted: false,
    );
  }
}
```

**UIè®¾è®¡ï¼ˆè½¬è´¦è¯·æ±‚ï¼‰:**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ â† å®¶åº­å†…éƒ¨è½¬è´¦                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                     â”‚
â”‚  è½¬è´¦ç»™ä¼´ä¾£                          â”‚
â”‚                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚         Â¥  5,000            â”‚   â”‚
â”‚  â”‚         â”â”â”â”â”â”â”             â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                     â”‚
â”‚  è½¬è´¦åŸå› ï¼ˆå¯é€‰ï¼‰:                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚ æœ¬æœˆæˆ¿ç§Ÿåˆ†æ‘Š                â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                     â”‚
â”‚  æ¥æ”¶æ–¹ï¼š                           â”‚
â”‚  ğŸ“± ç¾æƒ ã®iPhone 14 Pro            â”‚
â”‚                                     â”‚
â”‚  â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”      â”‚
â”‚                                     â”‚
â”‚  è½¬è´¦ååŒæ–¹å°†è‡ªåŠ¨åˆ›å»ºè®°å½•ï¼š          â”‚
â”‚  â€¢ æ‚¨çš„è´¦æœ¬: æ”¯å‡º -Â¥5,000          â”‚
â”‚  â€¢ ä¼´ä¾£è´¦æœ¬: æ”¶å…¥ +Â¥5,000          â”‚
â”‚                                     â”‚
â”‚  [å‘é€è½¬è´¦è¯·æ±‚]                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**è½¬è´¦é€šçŸ¥ï¼ˆæ¥æ”¶æ–¹ï¼‰:**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  è½¬è´¦è¯·æ±‚                           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                     â”‚
â”‚  ç”°ä¸­ã•ã‚“ãŒè»¢é€ã‚’ãƒªã‚¯ã‚¨ã‚¹ãƒˆ         â”‚
â”‚                                     â”‚
â”‚  é‡‘é¢ï¼šÂ¥5,000                       â”‚
â”‚  åŸå› ï¼šæœ¬æœˆæˆ¿ç§Ÿåˆ†æ‘Š                  â”‚
â”‚  æœ‰æ•ˆæœŸï¼š23å°æ—¶52åˆ†é’Ÿ                â”‚
â”‚                                     â”‚
â”‚  ç¡®è®¤åå°†åœ¨æ‚¨çš„è´¦æœ¬ä¸­åˆ›å»ºæ”¶å…¥è®°å½•    â”‚
â”‚                                     â”‚
â”‚  [æ‹’ç»]              [ç¡®è®¤æ¥æ”¶]     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

### 2.4 ä¼´ä¾£éšç§ä¿æŠ¤

#### 2.4.1 çµé­‚è´¦æˆ·æ˜ç»†éšè—

**è§„åˆ™:**
- ä¼´ä¾£å¯ä»¥çœ‹åˆ°:çµé­‚è´¦æˆ·çš„æ€»æ”¯å‡ºå’Œé¢„ç®—è¿›åº¦
- ä¼´ä¾£ä¸èƒ½çœ‹åˆ°:å…·ä½“ä¹°äº†ä»€ä¹ˆï¼ˆäº¤æ˜“æ˜ç»†ï¼‰

**å®ç°ä»£ç :**

```dart
// lib/features/family_sync/domain/use_cases/get_partner_transactions.dart

class GetPartnerTransactionsUseCase {
  Future<List<Transaction>> execute({
    required String partnerDeviceId,
    LedgerType? ledgerType,
  }) async {
    final transactions = await _transactionRepo.getTransactionsByDevice(
      deviceId: partnerDeviceId,
    );

    // è¿‡æ»¤çµé­‚è´¦æˆ·äº¤æ˜“ï¼ˆéšç§ä¿æŠ¤ï¼‰
    return transactions.where((tx) {
      if (tx.ledgerType == LedgerType.soul) {
        return false;  // ä¸æ˜¾ç¤ºçµé­‚è´¦æˆ·æ˜ç»†
      }
      if (tx.isPrivate) {
        return false;  // ä¸æ˜¾ç¤ºç§å¯†äº¤æ˜“
      }
      return true;
    }).toList();
  }

  /// è·å–ä¼´ä¾£çµé­‚è´¦æˆ·æ±‡æ€»ï¼ˆä»…è¿›åº¦,æ— æ˜ç»†ï¼‰
  Future<SoulAccountSummary> getPartnerSoulSummary(String partnerDeviceId) async {
    final config = await _soulConfigRepo.getByDeviceId(partnerDeviceId);

    final totalSpent = await _transactionRepo.sumByLedgerType(
      deviceId: partnerDeviceId,
      ledgerType: LedgerType.soul,
      month: DateTime.now().month,
      year: DateTime.now().year,
    );

    return SoulAccountSummary(
      ownerName: config.ownerName,
      soulName: config.soulName,
      iconEmoji: config.iconEmoji,
      monthlyBudget: config.monthlyBudget,
      totalSpent: totalSpent,  // åªæœ‰æ€»é¢
      transactions: [],        // æ˜ç»†ä¸ºç©ºï¼
      progressRatio: config.monthlyBudget > 0
          ? (totalSpent / config.monthlyBudget).clamp(0.0, 1.0)
          : 0.0,
    );
  }
}
```

#### 2.4.2 ç§å¯†äº¤æ˜“æ ‡è®°

**åŠŸèƒ½æ¦‚è¿°:**
ç”¨æˆ·å¯ä»¥å°†æŸäº›äº¤æ˜“æ ‡è®°ä¸º"ç§å¯†",ä¼´ä¾£å®Œå…¨çœ‹ä¸åˆ°ï¼ˆè¿æ±‡æ€»éƒ½ä¸è®¡å…¥ï¼‰ã€‚

**UIè®¾è®¡ï¼ˆäº¤æ˜“è¯¦æƒ…ï¼‰:**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ â† äº¤æ˜“è¯¦æƒ…                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  ğŸ® è¶£å‘³                            â”‚
â”‚  Â¥2,110                             â”‚
â”‚  2026/2/3 14:30                     â”‚
â”‚                                     â”‚
â”‚  å¤‡æ³¨ï¼šHG ã‚¶ã‚¯ II                   â”‚
â”‚  åˆ†ç±»ï¼šè¶£å‘³                          â”‚
â”‚  è´¦æˆ·ï¼šğŸ’– çµé­‚                      â”‚
â”‚                                     â”‚
â”‚  â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”      â”‚
â”‚  éšç§è®¾ç½®                           â”‚
â”‚  â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”      â”‚
â”‚                                     â”‚
â”‚  ğŸ”’ æ ‡è®°ä¸ºç§å¯†äº¤æ˜“                  â”‚
â”‚  [                            â˜]   â”‚  â† å¼€å…³
â”‚                                     â”‚
â”‚  âš ï¸ å¼€å¯åï¼Œä¼´ä¾£å°†æ— æ³•çœ‹åˆ°æ­¤äº¤æ˜“    â”‚
â”‚     ï¼ˆåŒ…æ‹¬æ±‡æ€»ç»Ÿè®¡ï¼‰                 â”‚
â”‚                                     â”‚
â”‚  [ä¿å­˜]                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 3. æ•°æ®æ¨¡å‹è®¾è®¡

### 3.1 Driftè¡¨å®šä¹‰

```dart
// lib/core/database/tables.dart

@DataClassName('DeviceData')
class Devices extends Table {
  TextColumn get id => text()();
  TextColumn get bookId => text()();
  TextColumn get publicKey => text()();
  TextColumn get name => text()();
  TextColumn get role => text()();  // 'owner', 'partner'
  IntColumn get pairedAt => integer()();
  IntColumn get lastSyncAt => integer().nullable()();

  @override
  Set<Column> get primaryKey => {id};
}

@DataClassName('SyncLogData')
class SyncLogs extends Table {
  TextColumn get id => text()();
  TextColumn get bookId => text()();
  TextColumn get fromDeviceId => text()();
  TextColumn get toDeviceId => text()();
  IntColumn get syncedTransactions => integer()();  // åŒæ­¥çš„äº¤æ˜“æ•°
  TextColumn get status => text()();  // 'success', 'failed'
  IntColumn get timestamp => integer()();

  @override
  Set<Column> get primaryKey => {id};
}

@DataClassName('InternalTransferData')
class InternalTransfers extends Table {
  TextColumn get id => text()();
  TextColumn get bookId => text()();
  TextColumn get fromDeviceId => text()();
  TextColumn get toDeviceId => text()();
  IntColumn get amount => integer()();
  TextColumn get reason => text().nullable()();
  TextColumn get status => text()();
  IntColumn get requestedAt => integer()();
  IntColumn get respondedAt => integer().nullable()();
  IntColumn get expiresAt => integer()();

  @override
  Set<Column> get primaryKey => {id};
}

// æ‰©å±•äº¤æ˜“è¡¨ï¼ˆæ·»åŠ ç§å¯†æ ‡è®°ï¼‰
@DataClassName('TransactionData')
class Transactions extends Table {
  // ... å…¶ä»–å­—æ®µ ...
  BoolColumn get isPrivate => boolean().withDefault(const Constant(false))();
  TextColumn get syncStatus => text().nullable()();  // 'synced', 'pending', 'conflict'
}
```

---

## 4. UI/UXè®¾è®¡

### 4.1 å®¶åº­è§†å›¾ï¼ˆé¦–é¡µï¼‰

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Home Pocket            â˜°          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  [æˆ‘çš„è´¦æœ¬] [å®¶åº­è´¦æœ¬]              â”‚  â† æ ‡ç­¾åˆ‡æ¢
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                     â”‚
â”‚  å®¶åº­æ€»è§ˆ                           â”‚
â”‚  â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”      â”‚
â”‚                                     â”‚
â”‚  æœ¬æœˆæ”¯å‡ºï¼šÂ¥312,800                 â”‚
â”‚  (æ‚¨ Â¥155,400 + ä¼´ä¾£ Â¥157,400)     â”‚
â”‚                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚
â”‚  â”‚ ğŸ“± ç”°ä¸­ã®iPhone             â”‚      â”‚
â”‚  â”‚ Â¥155,400                   â”‚      â”‚
â”‚  â”‚ â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘ 86%             â”‚      â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚
â”‚                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚
â”‚  â”‚ ğŸ“± ç¾æƒ ã®iPhone             â”‚      â”‚
â”‚  â”‚ Â¥157,400                   â”‚      â”‚
â”‚  â”‚ â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘ 87%             â”‚      â”‚
â”‚  â”‚ [çµé­‚è´¦æˆ·: 87%] ğŸ”’          â”‚      â”‚  â† åªæ˜¾ç¤ºè¿›åº¦
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚
â”‚                                     â”‚
â”‚  æœ€è¿‘äº¤æ˜“                           â”‚
â”‚  â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”      â”‚
â”‚                                     â”‚
â”‚  ä»Šæ—¥  2/3                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ ğŸš é£Ÿè²»   Â¥1,280  ç”°ä¸­   ğŸ’–  â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ ğŸ›’ é£Ÿè²»   Â¥5,800  ç¾æƒ    ğŸ   â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                     â”‚
â”‚  [åŒæ­¥çŠ¶æ€]  âœ“ å·²åŒæ­¥ (2åˆ†é’Ÿå‰)     â”‚
â”‚  [å®¶åº­å†…éƒ¨è½¬è´¦]                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 5. éªŒæ”¶æ ‡å‡†

### 5.1 åŠŸèƒ½å®Œæ•´æ€§

- âœ… QRç é…å¯¹æˆåŠŸç‡>95%
- âœ… åŒæ­¥å†²çªç‡<1%
- âœ… 1000æ¡äº¤æ˜“åŒæ­¥æ—¶é—´<10ç§’
- âœ… å®¶åº­å†…éƒ¨è½¬è´¦ä¸¤é˜¶æ®µæäº¤æˆåŠŸ
- âœ… ç¦»çº¿æ—¶è‡ªåŠ¨è¿›å…¥é˜Ÿåˆ—,ä¸Šçº¿åè‡ªåŠ¨åŒæ­¥
- âœ… å“ˆå¸Œé“¾å®Œæ•´æ€§éªŒè¯é€šè¿‡
- âœ… ä¼´ä¾£æ— æ³•æŸ¥çœ‹çµé­‚è´¦æˆ·æ˜ç»†
- âœ… ç§å¯†äº¤æ˜“å¯¹ä¼´ä¾£å®Œå…¨ä¸å¯è§

### 5.2 æ€§èƒ½æŒ‡æ ‡

| æŒ‡æ ‡ | ç›®æ ‡ |
|------|------|
| é…å¯¹æ—¶é—´ | <10ç§’ |
| åŒæ­¥å»¶è¿Ÿ | <2ç§’ |
| è“ç‰™è¿æ¥æˆåŠŸç‡ | >90% |
| ç¦»çº¿é˜Ÿåˆ—å®¹é‡ | æ”¯æŒ10000æ¡äº¤æ˜“ |

---

## 6. æµ‹è¯•ç”¨ä¾‹

### 6.1 å•å…ƒæµ‹è¯•

```dart
void main() {
  group('PairWithDeviceUseCase', () {
    test('should pair successfully with valid QR code', () async {
      // Given
      final qrData = PairingQRData(...);
      final qrCode = qrData.toJSON();

      // When
      final result = await useCase.execute(qrCode);

      // Then
      expect(result.status, PairingStatus.success);
    });

    test('should reject expired QR code', () async {
      // Given
      final expiredQRCode = PairingQRData(
        expiresAt: DateTime.now().subtract(Duration(minutes: 10)).millisecondsSinceEpoch,
      ).toJSON();

      // When
      final result = await useCase.execute(expiredQRCode);

      // Then
      expect(result.status, PairingStatus.expired);
    });
  });

  group('SyncEngine', () {
    test('should merge concurrent edits correctly', () async {
      // Given
      final deviceA = SyncEngine(bookId: 'book-001');
      final deviceB = SyncEngine(bookId: 'book-001');

      // When - concurrent edits
      await deviceA.addTransaction(tx1);
      await deviceB.addTransaction(tx2);

      // Sync
      final updateA = await deviceA.getUpdate();
      final updateB = await deviceB.getUpdate();

      await deviceA.receiveUpdate(updateB);
      await deviceB.receiveUpdate(updateA);

      // Then - both devices have same state
      final stateA = await deviceA.getState();
      final stateB = await deviceB.getState();

      expect(stateA, equals(stateB));
      expect(stateA.length, 2);
    });
  });
}
```

---

## 7. å¼€å‘é‡Œç¨‹ç¢‘ï¼ˆ12å¤©ï¼‰

| Day | ä»»åŠ¡ | äº§å‡º |
|-----|------|------|
| **Day 1-2** | QRç é…å¯¹ | ç”Ÿæˆ/æ‰«æQRç ,å¯†é’¥äº¤æ¢ |
| **Day 3-4** | è¿æ¥ç®¡ç†å™¨ | è“ç‰™/NFC/WiFiè¿æ¥ |
| **Day 5-6** | Yjsé›†æˆ | CRDTåŒæ­¥å¼•æ“ |
| **Day 7-8** | å®¶åº­å†…éƒ¨è½¬è´¦ | ä¸¤é˜¶æ®µæäº¤,çŠ¶æ€ç®¡ç† |
| **Day 9-10** | éšç§ä¿æŠ¤ | çµé­‚è´¦æˆ·è¿‡æ»¤,ç§å¯†äº¤æ˜“ |
| **Day 11** | UIå®ç° | å®¶åº­è§†å›¾,åŒæ­¥çŠ¶æ€ |
| **Day 12** | æµ‹è¯•ä¸ä¼˜åŒ– | é›†æˆæµ‹è¯•,æ€§èƒ½ä¼˜åŒ– |

---

**æ–‡æ¡£çŠ¶æ€:** å®Œæˆ
**å®¡æ ¸çŠ¶æ€:** å¾…è¯„å®¡

**å˜æ›´æ—¥å¿—:**
- 2026-02-03: åˆç‰ˆå®Œæˆ
