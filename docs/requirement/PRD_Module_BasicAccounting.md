# PRD - åŸºç¡€è®°è´¦æ¨¡å—

**æ¨¡å—ID:** MOD-001, MOD-002
**æ¨¡å—åç§°:** åŸºç¡€è®°è´¦ + åˆ†ç±»ç®¡ç†
**ç‰ˆæœ¬:** 1.0
**åˆ›å»ºæ—¥æœŸ:** 2026å¹´2æœˆ3æ—¥
**ä¼˜å…ˆçº§:** P0ï¼ˆMVPå¿…å¤‡ï¼‰
**é¢„ä¼°å·¥æ—¶:** 13å¤©ï¼ˆåŸºç¡€è®°è´¦8å¤© + åˆ†ç±»ç®¡ç†5å¤©ï¼‰

---

## 1. æ¨¡å—æ¦‚è¿°

### 1.1 åŠŸèƒ½å®šä¹‰

åŸºç¡€è®°è´¦æ¨¡å—æ˜¯Home Pocketçš„æ ¸å¿ƒåŸºç¡€åŠŸèƒ½ï¼Œè´Ÿè´£å¤„ç†ç”¨æˆ·çš„æ—¥å¸¸æ”¶æ”¯è®°å½•ã€‚åŒ…æ‹¬ï¼š
- æ”¯å‡ºè®°å½•ï¼ˆA01ï¼‰
- æ”¶å…¥è®°å½•ï¼ˆA02ï¼‰
- äº¤æ˜“åˆ—è¡¨ä¸æŸ¥è¯¢ï¼ˆA05ï¼‰
- äº¤æ˜“æœç´¢ï¼ˆA06ï¼‰
- äº¤æ˜“ä¿®æ­£ï¼ˆA07ï¼‰

åˆ†ç±»ç®¡ç†æ¨¡å—è´Ÿè´£ç»„ç»‡å’Œç®¡ç†äº¤æ˜“åˆ†ç±»ï¼ŒåŒ…æ‹¬ï¼š
- åˆ†ç±»ç®¡ç†ï¼ˆA03ï¼‰
- åˆ†ç±»å›¾æ ‡ä¸é¢œè‰²ï¼ˆA04ï¼‰

### 1.2 ç”¨æˆ·ä»·å€¼

**å¯¹ç”¨æˆ·çš„ä»·å€¼:**
- å¿«é€Ÿè®°å½•æ¯ä¸€ç¬”æ¶ˆè´¹å’Œæ”¶å…¥
- æ¸…æ™°æŸ¥çœ‹å†å²äº¤æ˜“
- é€šè¿‡åˆ†ç±»ç»„ç»‡æ”¯å‡ºï¼Œä¾¿äºåˆ†æ
- ä¿®æ­£é”™è¯¯è®°å½•ï¼Œä¿æŒæ•°æ®å‡†ç¡®æ€§

**å¯¹äº§å“çš„ä»·å€¼:**
- æ‰€æœ‰é«˜çº§åŠŸèƒ½çš„åŸºç¡€ï¼ˆåŒè½¨è´¦æœ¬ã€å®¶åº­åŒæ­¥ç­‰ä¾èµ–äºæ­¤ï¼‰
- ç”¨æˆ·ç²˜æ€§çš„å…³é”®ï¼ˆè®°è´¦é¢‘ç‡å†³å®šç•™å­˜ç‡ï¼‰
- æ•°æ®å®Œæ•´æ€§ä¿è¯ï¼ˆå“ˆå¸Œé“¾ä»è¿™é‡Œå¼€å§‹ï¼‰

### 1.3 ä¾èµ–å…³ç³»

**å‰ç½®ä¾èµ–:**
- æ•°æ®åº“åˆå§‹åŒ–ï¼ˆDrift + SQLCipherï¼‰
- å¯†é’¥ç®¡ç†ç³»ç»Ÿï¼ˆç”¨äºåŠ å¯†noteå­—æ®µï¼‰
- ä¸»é¢˜ç³»ç»Ÿï¼ˆå’Œé£/èµ›åšåŒæ¨¡å¼ï¼‰

**è¢«ä¾èµ–:**
- MOD-003 åŒè½¨è´¦æœ¬ï¼ˆéœ€è¦åˆ†ç±»ä¿¡æ¯ï¼‰
- MOD-005 OCRæ‰«æï¼ˆè‡ªåŠ¨å¡«å……äº¤æ˜“ï¼‰
- MOD-007 æ•°æ®åˆ†æï¼ˆç»Ÿè®¡äº¤æ˜“æ•°æ®ï¼‰
- MOD-004 å®¶åº­åŒæ­¥ï¼ˆåŒæ­¥äº¤æ˜“è®°å½•ï¼‰

---

## 2. åŠŸèƒ½è¯¦ç»†è§„æ ¼

### 2.1 A01: æ”¯å‡ºè®°å½•

#### 2.1.1 åŠŸèƒ½æè¿°

ç”¨æˆ·å¯ä»¥å¿«é€Ÿè®°å½•ä¸€ç¬”æ”¯å‡ºï¼ŒåŒ…æ‹¬é‡‘é¢ã€åˆ†ç±»ã€å¤‡æ³¨ã€æ—¶é—´ã€ç…§ç‰‡ç­‰ä¿¡æ¯ã€‚

#### 2.1.2 äº¤äº’æµç¨‹

```
é¦–é¡µ â†’ ç‚¹å‡»"â•"æŒ‰é’® â†’ æ”¯å‡ºè®°å½•é¡µé¢
         â†“
   é€‰æ‹©"æ”¯å‡º"Tabï¼ˆé»˜è®¤ï¼‰
         â†“
   è¾“å…¥é‡‘é¢ï¼ˆå¤§æ•°å­—é”®ç›˜ï¼‰
         â†“
   é€‰æ‹©åˆ†ç±»ï¼ˆè‡ªåŠ¨æ¨èï¼‰
         â†“
   [å¯é€‰] æ·»åŠ å¤‡æ³¨
   [å¯é€‰] æ‹ç…§
   [å¯é€‰] é€‰æ‹©æ—¶é—´ï¼ˆé»˜è®¤å½“å‰æ—¶é—´ï¼‰
   [å¯é€‰] æ ‡è®°ä¸ºç§å¯†
         â†“
   ç‚¹å‡»"ä¿å­˜"
         â†“
   ç³»ç»Ÿè‡ªåŠ¨åˆ¤å®šç”Ÿå­˜/çµé­‚è´¦æˆ·
         â†“
   å“ˆå¸Œé“¾è®¡ç®—å¹¶ä¿å­˜
         â†“
   [å¦‚å¯ç”¨] æ˜¾ç¤ºè¶£å‘³æ¢ç®—Toast
   [å¦‚ä¸ºçµé­‚æ¶ˆè´¹] æ’­æ”¾åº†ç¥åŠ¨ç”»
         â†“
   è¿”å›é¦–é¡µï¼Œåˆ—è¡¨é¡¶éƒ¨æ˜¾ç¤ºæ–°äº¤æ˜“
```

#### 2.1.3 UIè®¾è®¡ï¼ˆå’Œé£æ¨¡å¼ï¼‰

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ â† æ–°å¢æ”¯å‡º                     ä¿å­˜ â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚         Â¥  1,280            â”‚   â”‚  â† å¤§æ•°å­—æ˜¾ç¤º
â”‚  â”‚         â”â”â”â”â”â”â”             â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                     â”‚
â”‚  â”Œâ”€â”€â”¬â”€â”€â”¬â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚1 â”‚2 â”‚3 â”‚  [ä»Šæ—¥ 14:30] â–¼â”‚    â”‚  â† æ—¶é—´é€‰æ‹©
â”‚  â”œâ”€â”€â”¼â”€â”€â”¼â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤    â”‚
â”‚  â”‚4 â”‚5 â”‚6 â”‚                  â”‚    â”‚
â”‚  â”œâ”€â”€â”¼â”€â”€â”¼â”€â”€â”¤                  â”‚    â”‚
â”‚  â”‚7 â”‚8 â”‚9 â”‚  æ•°å­—é”®ç›˜        â”‚    â”‚
â”‚  â”œâ”€â”€â”¼â”€â”€â”¼â”€â”€â”¤                  â”‚    â”‚
â”‚  â”‚00â”‚0 â”‚âŒ« â”‚                  â”‚    â”‚
â”‚  â””â”€â”€â”´â”€â”€â”´â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                     â”‚
â”‚  åˆ†ç±»ï¼š                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚ ğŸš é£Ÿè²»                â–¼   â”‚    â”‚  â† åˆ†ç±»é€‰æ‹©å™¨
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                     â”‚
â”‚  è´¦æˆ·ç±»å‹ï¼š                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚
â”‚  â”‚ ğŸ  ç”Ÿå­˜  â”‚  â”‚ ğŸ’– çµé­‚  â”‚        â”‚  â† è‡ªåŠ¨åˆ¤æ–­é«˜äº®
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚
â”‚  (ç³»ç»Ÿè‡ªåŠ¨åˆ¤æ–­ï¼Œå¯æ‰‹åŠ¨åˆ‡æ¢)          â”‚
â”‚                                     â”‚
â”‚  å¤‡æ³¨ï¼š                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚ åˆé¤ @ å‰é‡å®¶              â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                     â”‚
â”‚  [ğŸ“· æ‹ç…§]  [ğŸ“ ä½ç½®]  [ğŸ”’ ç§å¯†] â”‚
â”‚                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### 2.1.4 æ•°æ®æ¨¡å‹

```dart
class Transaction {
  final String id;              // UUID
  final String bookId;          // å…³è”è´¦æœ¬
  final String deviceId;        // åˆ›å»ºè®¾å¤‡
  final int amount;             // é‡‘é¢ï¼ˆæ—¥å…ƒï¼Œæ•´æ•°ï¼‰
  final TransactionType type;   // expense | income | transfer
  final String categoryId;      // åˆ†ç±»ID
  final LedgerType ledgerType;  // survival | soul
  final DateTime timestamp;     // å‘ç”Ÿæ—¶é—´
  final String? note;           // å¤‡æ³¨ï¼ˆåŠ å¯†å­˜å‚¨ï¼‰
  final String? photoHash;      // ç…§ç‰‡å“ˆå¸Œ
  final String? prevHash;       // å‰ä¸€ç¬”äº¤æ˜“çš„å“ˆå¸Œ
  final String currentHash;     // å½“å‰äº¤æ˜“çš„å“ˆå¸Œ
  final DateTime createdAt;     // åˆ›å»ºæ—¶é—´
  final bool isPrivate;         // æ˜¯å¦ç§å¯†ï¼ˆå•äººæ¨¡å¼æ— æ•ˆï¼‰
}
```

#### 2.1.5 ä¸šåŠ¡é€»è¾‘

**é‡‘é¢éªŒè¯:**
```dart
class AmountValidator {
  static const int maxAmount = 99999999;  // 9999ä¸‡9999æ—¥å…ƒ
  static const int minAmount = 1;

  ValidationResult validate(int amount) {
    if (amount < minAmount) {
      return ValidationResult.error('é‡‘é¢å¿…é¡»å¤§äº0');
    }
    if (amount > maxAmount) {
      return ValidationResult.error('é‡‘é¢è¶…è¿‡ä¸Šé™ï¼ˆ9999ä¸‡æ—¥å…ƒï¼‰');
    }
    return ValidationResult.success();
  }
}
```

**å“ˆå¸Œé“¾è®¡ç®—:**
```dart
class HashChainService {
  Future<String> calculateHash(Transaction tx) async {
    // è·å–å‰ä¸€ç¬”äº¤æ˜“çš„å“ˆå¸Œ
    final prevHash = tx.prevHash ?? 'genesis';

    // æ„é€ å¾…å“ˆå¸Œæ•°æ®ï¼ˆå…³é”®å­—æ®µï¼‰
    final data = '${tx.id}|${tx.amount}|${tx.type}|${tx.categoryId}|'
                 '${tx.timestamp.millisecondsSinceEpoch}|$prevHash';

    // SHA-256å“ˆå¸Œ
    final bytes = utf8.encode(data);
    final digest = sha256.convert(bytes);

    return digest.toString();
  }

  Future<bool> verifyChain(String bookId) async {
    final transactions = await _repo.getTransactions(
      bookId: bookId,
      orderBy: 'timestamp ASC',
    );

    String prevHash = 'genesis';
    for (final tx in transactions) {
      final expectedHash = await calculateHash(
        tx.copyWith(prevHash: prevHash),
      );

      if (tx.currentHash != expectedHash) {
        // æ£€æµ‹åˆ°ç¯¡æ”¹
        await _logTamperDetection(tx);
        return false;
      }

      prevHash = tx.currentHash;
    }

    return true;
  }
}
```

**è‡ªåŠ¨åˆ†ç±»ï¼ˆç”Ÿå­˜/çµé­‚ï¼‰:**
```dart
class LedgerTypeClassifier {
  Future<LedgerType> classify(String categoryId) async {
    final category = await _categoryRepo.getById(categoryId);

    // å¦‚æœåˆ†ç±»æ˜ç¡®æŒ‡å®šäº†è´¦æˆ·ç±»å‹
    if (category.ledgerType != LedgerType.auto) {
      return category.ledgerType;
    }

    // ä½¿ç”¨è§„åˆ™å¼•æ“
    return _ruleEngine.classify(category);
  }
}

class RuleEngine {
  LedgerType classify(Category category) {
    // è§„åˆ™1ï¼šå¿…éœ€æ¶ˆè´¹ â†’ ç”Ÿå­˜è´¦æˆ·
    final survivalCategories = [
      'food_groceries',      // è¶…å¸‚é£Ÿå“
      'housing_rent',        // æˆ¿ç§Ÿ
      'transport_commute',   // é€šå‹¤äº¤é€š
      'utilities',           // æ°´ç”µç…¤
      'medical',             // åŒ»ç–—
      'education',           // æ•™è‚²ï¼ˆå¿…éœ€ï¼‰
    ];

    if (survivalCategories.contains(category.id)) {
      return LedgerType.survival;
    }

    // è§„åˆ™2ï¼šäº«ä¹æ¶ˆè´¹ â†’ çµé­‚è´¦æˆ·
    final soulCategories = [
      'food_restaurant',     // å¤–é£Ÿ
      'entertainment',       // å¨±ä¹
      'hobby',               // çˆ±å¥½
      'travel',              // æ—…è¡Œ
      'shopping_luxury',     // å¥¢ä¾ˆå“
    ];

    if (soulCategories.contains(category.id)) {
      return LedgerType.soul;
    }

    // é»˜è®¤ï¼šç”Ÿå­˜è´¦æˆ·ï¼ˆä¿å®ˆç­–ç•¥ï¼‰
    return LedgerType.survival;
  }
}
```

#### 2.1.6 éªŒæ”¶æ ‡å‡†

- âœ… ç”¨æˆ·å¯ä»¥åœ¨3ç§’å†…å®Œæˆä¸€ç¬”æ”¯å‡ºè®°å½•
- âœ… é‡‘é¢è¾“å…¥æ”¯æŒæ•°å­—é”®ç›˜ï¼ˆ0-9ã€00ã€åˆ é™¤ï¼‰
- âœ… åˆ†ç±»é€‰æ‹©å™¨æ˜¾ç¤ºå›¾æ ‡+åç§°ï¼Œæ”¯æŒæœç´¢
- âœ… æ—¶é—´é»˜è®¤å½“å‰æ—¶é—´ï¼Œå¯é€‰æ‹©è¿‡å»7å¤©å†…ä»»æ„æ—¶é—´
- âœ… å¤‡æ³¨å­—æ®µåŠ å¯†å­˜å‚¨ï¼ˆChaCha20-Poly1305ï¼‰
- âœ… å“ˆå¸Œé“¾æ­£ç¡®è®¡ç®—å¹¶ä¿å­˜
- âœ… ä¿å­˜æˆåŠŸåè‡ªåŠ¨è¿”å›é¦–é¡µï¼Œåˆ—è¡¨é¡¶éƒ¨æ˜¾ç¤ºæ–°äº¤æ˜“
- âœ… å¦‚å¯ç”¨è¶£å‘³åŠŸèƒ½ï¼Œæ˜¾ç¤ºæ¢ç®—å™¨Toastï¼ˆ3ç§’åæ¶ˆå¤±ï¼‰
- âœ… å¦‚ä¸ºçµé­‚æ¶ˆè´¹ï¼Œæ’­æ”¾åº†ç¥åŠ¨ç”»ï¼ˆ2ç§’ï¼Œå¯è·³è¿‡ï¼‰

---

### 2.2 A02: æ”¶å…¥è®°å½•

#### 2.2.1 åŠŸèƒ½æè¿°

ç”¨æˆ·å¯ä»¥è®°å½•æ”¶å…¥ï¼ŒåŒ…æ‹¬å·¥èµ„ã€å¥–é‡‘ã€å‰¯ä¸šç­‰ã€‚æ”¶å…¥ç±»å‹å½±å“åˆ†ææŠ¥è¡¨çš„è®¡ç®—ã€‚

#### 2.2.2 ä¸æ”¯å‡ºçš„å·®å¼‚

| ç‰¹æ€§ | æ”¯å‡º | æ”¶å…¥ |
|------|------|------|
| è´¦æˆ·ç±»å‹ | ç”Ÿå­˜/çµé­‚ | ä¸åŒºåˆ†ï¼ˆç»Ÿä¸€ä¸ºæ”¶å…¥ï¼‰|
| é»˜è®¤åˆ†ç±» | é£Ÿè²»ç­‰ | å·¥èµ„ã€å¥–é‡‘ã€å‰¯ä¸š |
| åº†ç¥åŠ¨ç”» | ä»…çµé­‚æ¶ˆè´¹ | æ— åŠ¨ç”» |
| è¶£å‘³æ¢ç®— | æ”¯æŒ | ä¸æ”¯æŒ |

#### 2.2.3 æ”¶å…¥åˆ†ç±»é¢„è®¾

```dart
const incomeCategories = [
  Category(
    id: 'income_salary',
    name: 'çµ¦æ–™ï¼ˆæœˆçµ¦ï¼‰',
    icon: 'ğŸ’¼',
    color: '#4CAF50',
    ledgerType: LedgerType.income,
  ),
  Category(
    id: 'income_bonus',
    name: 'ãƒœãƒ¼ãƒŠã‚¹',
    icon: 'ğŸ',
    color: '#8BC34A',
    ledgerType: LedgerType.income,
  ),
  Category(
    id: 'income_sidejob',
    name: 'å‰¯æ¥­',
    icon: 'ğŸ’»',
    color: '#CDDC39',
    ledgerType: LedgerType.income,
  ),
  Category(
    id: 'income_investment',
    name: 'æŠ•è³‡åç›Š',
    icon: 'ğŸ“ˆ',
    color: '#FFC107',
    ledgerType: LedgerType.income,
  ),
  Category(
    id: 'income_other',
    name: 'ãã®ä»–åå…¥',
    icon: 'ğŸ’°',
    color: '#FF9800',
    ledgerType: LedgerType.income,
  ),
];
```

---

### 2.3 A03-A04: åˆ†ç±»ç®¡ç†

#### 2.3.1 é¢„è®¾åˆ†ç±»æ¸…å•ï¼ˆ20ä¸ªï¼‰

**æ”¯å‡ºåˆ†ç±»ï¼ˆ15ä¸ªï¼‰:**
```dart
const expenseCategories = [
  // ç”Ÿå­˜å¿…éœ€ï¼ˆ8ä¸ªï¼‰
  Category(id: 'food_groceries', name: 'é£Ÿè²»ï¼ˆã‚¹ãƒ¼ãƒ‘ãƒ¼ï¼‰', icon: 'ğŸ›’', color: '#4CAF50', ledgerType: LedgerType.survival),
  Category(id: 'housing_rent', name: 'ä½å®…ï¼ˆå®¶è³ƒï¼‰', icon: 'ğŸ ', color: '#795548', ledgerType: LedgerType.survival),
  Category(id: 'utilities', name: 'å…‰ç†±è²»', icon: 'ğŸ’¡', color: '#FF9800', ledgerType: LedgerType.survival),
  Category(id: 'transport_commute', name: 'äº¤é€šè²»ï¼ˆé€šå‹¤ï¼‰', icon: 'ğŸš‡', color: '#2196F3', ledgerType: LedgerType.survival),
  Category(id: 'medical', name: 'åŒ»ç™‚è²»', icon: 'ğŸ’Š', color: '#F44336', ledgerType: LedgerType.survival),
  Category(id: 'insurance', name: 'ä¿é™º', icon: 'ğŸ›¡ï¸', color: '#9C27B0', ledgerType: LedgerType.survival),
  Category(id: 'communication', name: 'é€šä¿¡è²»', icon: 'ğŸ“±', color: '#3F51B5', ledgerType: LedgerType.survival),
  Category(id: 'daily_goods', name: 'æ—¥ç”¨å“', icon: 'ğŸ§´', color: '#00BCD4', ledgerType: LedgerType.survival),

  // çµé­‚äº«ä¹ï¼ˆ7ä¸ªï¼‰
  Category(id: 'food_restaurant', name: 'é£Ÿè²»ï¼ˆå¤–é£Ÿï¼‰', icon: 'ğŸœ', color: '#FF9800', ledgerType: LedgerType.soul),
  Category(id: 'entertainment', name: 'å¨¯æ¥½', icon: 'ğŸ®', color: '#E91E63', ledgerType: LedgerType.soul),
  Category(id: 'hobby', name: 'è¶£å‘³', icon: 'ğŸ¨', color: '#9C27B0', ledgerType: LedgerType.soul),
  Category(id: 'shopping_fashion', name: 'ãƒ•ã‚¡ãƒƒã‚·ãƒ§ãƒ³', icon: 'ğŸ‘”', color: '#FF5722', ledgerType: LedgerType.soul),
  Category(id: 'beauty', name: 'ç¾å®¹', icon: 'ğŸ’…', color: '#E91E63', ledgerType: LedgerType.soul),
  Category(id: 'travel', name: 'æ—…è¡Œ', icon: 'âœˆï¸', color: '#00BCD4', ledgerType: LedgerType.soul),
  Category(id: 'education_hobby', name: 'å­¦ç¿’ï¼ˆè¶£å‘³ï¼‰', icon: 'ğŸ“š', color: '#3F51B5', ledgerType: LedgerType.soul),
];
```

#### 2.3.2 è‡ªå®šä¹‰åˆ†ç±»

**åˆ›å»ºè‡ªå®šä¹‰åˆ†ç±»:**
```dart
class CreateCategoryUseCase {
  Future<Category> execute({
    required String name,
    required String icon,
    required String color,
    required LedgerType ledgerType,
  }) async {
    // éªŒè¯
    if (name.isEmpty || name.length > 20) {
      throw ValidationException('åˆ†ç±»åç§°é•¿åº¦å¿…é¡»åœ¨1-20å­—ç¬¦ä¹‹é—´');
    }

    if (!_isValidIcon(icon)) {
      throw ValidationException('è¯·é€‰æ‹©æœ‰æ•ˆçš„å›¾æ ‡');
    }

    if (!_isValidColor(color)) {
      throw ValidationException('è¯·é€‰æ‹©æœ‰æ•ˆçš„é¢œè‰²');
    }

    // åˆ›å»ºåˆ†ç±»
    final category = Category(
      id: 'custom_${uuid.v4()}',
      name: name,
      icon: icon,
      color: color,
      ledgerType: ledgerType,
      isSystem: false,
      createdAt: DateTime.now(),
    );

    await _categoryRepo.insert(category);
    return category;
  }

  bool _isValidIcon(String icon) {
    // éªŒè¯æ˜¯å¦ä¸ºemoji
    return icon.runes.length == 1 || icon.runes.length == 2;
  }

  bool _isValidColor(String color) {
    // éªŒè¯åå…­è¿›åˆ¶é¢œè‰²æ ¼å¼
    return RegExp(r'^#[0-9A-Fa-f]{6}$').hasMatch(color);
  }
}
```

**å›¾æ ‡é€‰æ‹©å™¨:**
```
å¸¸ç”¨å›¾æ ‡åˆ†ç±»ï¼š
- é£Ÿç‰©ï¼šğŸœğŸšğŸ—ğŸ•ğŸ°ğŸºğŸ±
- è´­ç‰©ï¼šğŸ›’ğŸ‘”ğŸ‘—ğŸ‘œğŸ’„ğŸ’
- äº¤é€šï¼šğŸš‡ğŸšŒğŸš—âœˆï¸ğŸšƒ
- å¨±ä¹ï¼šğŸ®ğŸ¬ğŸµğŸ¨ğŸ“šâš½
- ç”Ÿæ´»ï¼šğŸ ğŸ’¡ğŸ’ŠğŸ§´ğŸ›
- å…¶ä»–ï¼šğŸ’°ğŸ’³ğŸ“±ğŸ’»ğŸ“·
```

**é¢œè‰²é€‰æ‹©å™¨:**
```
é¢„è®¾é¢œè‰²æ¿ï¼ˆMaterial Designï¼‰:
- çº¢è‰²ç³»ï¼š#F44336, #E91E63, #FF5722
- è“è‰²ç³»ï¼š#2196F3, #3F51B5, #00BCD4
- ç»¿è‰²ç³»ï¼š#4CAF50, #8BC34A, #009688
- é»„è‰²ç³»ï¼š#FFEB3B, #FFC107, #FF9800
- ç´«è‰²ç³»ï¼š#9C27B0, #673AB7
- ç°è‰²ç³»ï¼š#9E9E9E, #607D8B, #795548
```

#### 2.3.3 åˆ†ç±»ç¼–è¾‘

**é™åˆ¶:**
- âœ… ç³»ç»Ÿé¢„è®¾åˆ†ç±»å¯ä»¥ä¿®æ”¹é¢œè‰²å’Œå›¾æ ‡
- âŒ ç³»ç»Ÿé¢„è®¾åˆ†ç±»ä¸èƒ½ä¿®æ”¹åç§°å’Œè´¦æˆ·ç±»å‹
- âœ… è‡ªå®šä¹‰åˆ†ç±»å¯ä»¥å®Œå…¨ä¿®æ”¹
- âŒ å¦‚åˆ†ç±»å·²è¢«äº¤æ˜“ä½¿ç”¨ï¼Œä¸èƒ½åˆ é™¤ï¼ˆåªèƒ½å½’æ¡£ï¼‰

**å½’æ¡£æœºåˆ¶:**
```dart
class ArchiveCategoryUseCase {
  Future<void> execute(String categoryId) async {
    // æ£€æŸ¥æ˜¯å¦è¢«ä½¿ç”¨
    final usageCount = await _transactionRepo.countByCategory(categoryId);

    if (usageCount > 0) {
      // ä¸èƒ½åˆ é™¤ï¼Œæ”¹ä¸ºå½’æ¡£
      await _categoryRepo.update(
        categoryId,
        isArchived: true,
      );

      // å½’æ¡£åçš„åˆ†ç±»ä¸å†æ˜¾ç¤ºåœ¨é€‰æ‹©å™¨ä¸­
      // ä½†å·²æœ‰äº¤æ˜“ä»æ˜¾ç¤ºè¯¥åˆ†ç±»
    } else {
      // æœªè¢«ä½¿ç”¨ï¼Œç›´æ¥åˆ é™¤
      await _categoryRepo.delete(categoryId);
    }
  }
}
```

---

### 2.4 A05-A06: äº¤æ˜“åˆ—è¡¨ä¸æœç´¢

#### 2.4.1 åˆ—è¡¨å±•ç¤º

**åˆ†ç»„æ–¹å¼:**
- æŒ‰æ—¥æœŸåˆ†ç»„ï¼ˆä»Šæ—¥ã€æ˜¨æ—¥ã€æœ¬å‘¨ã€æœ¬æœˆã€æ›´æ—©ï¼‰
- æ¯ç»„æ˜¾ç¤ºæ—¥æœŸ + æ€»é‡‘é¢
- æ”¯æŒæ— é™æ»šåŠ¨åŠ è½½ï¼ˆæ¯é¡µ50æ¡ï¼‰

**åˆ—è¡¨é¡¹æ ·å¼ï¼ˆå’Œé£æ¨¡å¼ï¼‰:**
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ä»Šæ—¥  2/3                 Â¥3,390   â”‚  â† ç»„å¤´
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ ğŸš é£Ÿè²»             Â¥1,280 ğŸ  â”‚  â”‚  â† ç”Ÿå­˜æ ‡è®°
â”‚  â”‚ åˆé¤ @ å‰é‡å®¶                â”‚  â”‚
â”‚  â”‚ 14:30                         â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ ğŸ® è¶£å‘³             Â¥2,110 ğŸ’– â”‚  â”‚  â† çµé­‚æ ‡è®°
â”‚  â”‚ HG ã‚¶ã‚¯ II                   â”‚  â”‚
â”‚  â”‚ 11:20                 [ç…§ç‰‡]  â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**æ»‘åŠ¨æ“ä½œ:**
- å·¦æ»‘ï¼šåˆ é™¤ï¼ˆæ˜¾ç¤ºç¡®è®¤å¯¹è¯æ¡†ï¼‰
- å³æ»‘ï¼šç¼–è¾‘

**ç©ºçŠ¶æ€:**
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                     â”‚
â”‚           ğŸ“                        â”‚
â”‚       ã¾ã è¨˜éŒ²ãŒã‚ã‚Šã¾ã›ã‚“           â”‚
â”‚                                     â”‚
â”‚   [â• æœ€åˆã®è¨˜éŒ²ã‚’è¿½åŠ ]             â”‚
â”‚                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### 2.4.2 æœç´¢åŠŸèƒ½

**æœç´¢èŒƒå›´:**
- é‡‘é¢ï¼ˆç²¾ç¡®åŒ¹é…æˆ–èŒƒå›´ï¼‰
- åˆ†ç±»
- å¤‡æ³¨å…³é”®è¯
- æ—¥æœŸèŒƒå›´

**æœç´¢UI:**
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ â† æœç´¢äº¤æ˜“                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” ğŸ” â”‚
â”‚  â”‚ å…³é”®è¯ã€é‡‘é¢ã€åˆ†ç±»...       â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                     â”‚
â”‚  å¿«é€Ÿç­›é€‰ï¼š                         â”‚
â”‚  [ä»Šæ—¥] [æœ¬å‘¨] [æœ¬æœˆ]               â”‚
â”‚  [ç”Ÿå­˜] [çµé­‚] [æ”¶å…¥]               â”‚
â”‚                                     â”‚
â”‚  é«˜çº§ç­›é€‰ï¼š                         â”‚
â”‚  é‡‘é¢èŒƒå›´ï¼šÂ¥1000 - Â¥5000           â”‚
â”‚  åˆ†ç±»ï¼šé£Ÿè²»ã€äº¤é€šè²»                 â”‚
â”‚  æ—¥æœŸï¼š2026/1/1 - 2026/1/31        â”‚
â”‚                                     â”‚
â”‚  â”Œâ”€ ç»“æœ (23ç¬”) â”€â”                 â”‚
â”‚  â”‚ ...           â”‚                 â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**æœç´¢é€»è¾‘:**
```dart
class SearchTransactionsUseCase {
  Future<List<Transaction>> execute(SearchQuery query) async {
    return await _repo.search(
      keyword: query.keyword,
      minAmount: query.minAmount,
      maxAmount: query.maxAmount,
      categoryIds: query.categoryIds,
      ledgerTypes: query.ledgerTypes,
      startDate: query.startDate,
      endDate: query.endDate,
    );
  }
}

// SQLç¤ºä¾‹
SELECT * FROM transactions
WHERE book_id = ?
  AND (note LIKE ? OR category_id IN (?))
  AND amount BETWEEN ? AND ?
  AND timestamp BETWEEN ? AND ?
  AND ledger_type IN (?)
ORDER BY timestamp DESC
LIMIT ? OFFSET ?
```

---

### 2.5 A07: äº¤æ˜“ä¿®æ­£

#### 2.5.1 åŠŸèƒ½æè¿°

ç”¨æˆ·å‘ç°è®°å½•é”™è¯¯åï¼Œå¯ä»¥åˆ›å»ºä¿®æ­£è®°å½•ã€‚ä¿®æ­£é‡‡ç”¨"æ’å…¥ä¿®æ­£äº‹ä»¶"è€Œé"ç›´æ¥ä¿®æ”¹"ï¼Œä¿è¯å“ˆå¸Œé“¾ä¸è¢«ç ´åã€‚

#### 2.5.2 ä¿®æ­£æµç¨‹

```
æŸ¥çœ‹äº¤æ˜“è¯¦æƒ… â†’ ç‚¹å‡»"ä¿®æ­£"
         â†“
   é€‰æ‹©ä¿®æ­£ç±»å‹ï¼š
   - ä¿®æ”¹é‡‘é¢
   - ä¿®æ”¹åˆ†ç±»
   - ä¿®æ”¹å¤‡æ³¨
   - ä¿®æ”¹è´¦æˆ·ç±»å‹
         â†“
   è¾“å…¥æ–°å€¼
         â†“
   ç¡®è®¤ä¿®æ­£
         â†“
   ç”Ÿæˆä¿®æ­£è®°å½•ï¼ˆæ–°transactionï¼‰:
   - type = 'correction'
   - original_tx_id = è¢«ä¿®æ­£çš„äº¤æ˜“ID
   - correction_type = 'amount' | 'category' | ...
   - correction_value = æ–°å€¼
         â†“
   æ ‡è®°åŸäº¤æ˜“ä¸º"å·²ä¿®æ­£"çŠ¶æ€
         â†“
   æ›´æ–°æ˜¾ç¤ºï¼ˆåˆ—è¡¨ä¸­æ˜¾ç¤ºä¿®æ­£åçš„å€¼ï¼‰
```

#### 2.5.3 æ•°æ®æ¨¡å‹

```dart
class CorrectionTransaction extends Transaction {
  final String originalTxId;       // è¢«ä¿®æ­£çš„äº¤æ˜“ID
  final CorrectionType correctionType;
  final dynamic correctionValue;
  final String? reason;             // ä¿®æ­£åŸå› ï¼ˆå¯é€‰ï¼‰

  CorrectionTransaction({
    required super.id,
    required super.bookId,
    required super.deviceId,
    required this.originalTxId,
    required this.correctionType,
    required this.correctionValue,
    this.reason,
    // ... å…¶ä»–å­—æ®µ
  }) : super(type: TransactionType.correction);
}

enum CorrectionType {
  amount,
  category,
  note,
  ledgerType,
  timestamp,
}
```

#### 2.5.4 UIè®¾è®¡

**ä¿®æ­£å¯¹è¯æ¡†:**
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ä¿®æ­£äº¤æ˜“                           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  åŸè®°å½•ï¼š                           â”‚
â”‚  ğŸš é£Ÿè²»  Â¥1,280  åˆé¤ @ å‰é‡å®¶     â”‚
â”‚  2/3 14:30                          â”‚
â”‚                                     â”‚
â”‚  ä¿®æ­£å†…å®¹ï¼š                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚ [âœ“] é‡‘é¢      Â¥1,380       â”‚    â”‚
â”‚  â”‚ [ ] åˆ†ç±»                   â”‚    â”‚
â”‚  â”‚ [ ] å¤‡æ³¨                   â”‚    â”‚
â”‚  â”‚ [ ] è´¦æˆ·ç±»å‹               â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                     â”‚
â”‚  ä¿®æ­£åŸå› ï¼ˆå¯é€‰ï¼‰:                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚ å¿˜è®°ç®—ç¨è´¹äº†                â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                     â”‚
â”‚  âš ï¸ ä¿®æ­£ååŸè®°å½•ä»ä¿ç•™ï¼Œ           â”‚
â”‚     ä½†åˆ—è¡¨ä¸­æ˜¾ç¤ºä¿®æ­£åçš„å€¼         â”‚
â”‚                                     â”‚
â”‚  [å–æ¶ˆ]              [ç¡®è®¤ä¿®æ­£]     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**åˆ—è¡¨ä¸­æ˜¾ç¤ºä¿®æ­£æ ‡è®°:**
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ğŸš é£Ÿè²»         Â¥1,380 ğŸ  ğŸ”„ â”‚  â† ä¿®æ­£æ ‡è®°
â”‚ åˆé¤ @ å‰é‡å®¶  (å·²ä¿®æ­£)       â”‚
â”‚ 14:30                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### 2.5.5 å®¡è®¡æ—¥å¿—æŸ¥çœ‹

ç”¨æˆ·å¯ä»¥æŸ¥çœ‹äº¤æ˜“çš„å®Œæ•´ä¿®æ­£å†å²ï¼š

```
äº¤æ˜“è¯¦æƒ… â†’ ç‚¹å‡»"ä¿®æ­£å†å²"

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ä¿®æ­£å†å²                           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  åŸå§‹è®°å½•ï¼ˆ2/3 14:30ï¼‰              â”‚
â”‚  é‡‘é¢ï¼šÂ¥1,280                       â”‚
â”‚  åˆ†ç±»ï¼šé£Ÿè²»                         â”‚
â”‚  å¤‡æ³¨ï¼šåˆé¤ @ å‰é‡å®¶                â”‚
â”‚  å“ˆå¸Œï¼šabc123...                    â”‚
â”‚                                     â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€       â”‚
â”‚                                     â”‚
â”‚  ä¿®æ­£è®°å½•1ï¼ˆ2/3 15:00ï¼‰             â”‚
â”‚  ä¿®æ­£äººï¼šDevice A (è‡ªå·±)            â”‚
â”‚  ä¿®æ­£å†…å®¹ï¼šé‡‘é¢ Â¥1,280 â†’ Â¥1,380    â”‚
â”‚  ä¿®æ­£åŸå› ï¼šå¿˜è®°ç®—ç¨è´¹äº†             â”‚
â”‚  å“ˆå¸Œï¼šdef456...                    â”‚
â”‚                                     â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€       â”‚
â”‚                                     â”‚
â”‚  å½“å‰æ˜¾ç¤ºå€¼ï¼šÂ¥1,380                 â”‚
â”‚  å“ˆå¸Œé“¾çŠ¶æ€ï¼šâœ… å®Œæ•´                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 3. æŠ€æœ¯å®ç°

### 3.1 Repositoryå®ç°

```dart
// lib/features/transaction/data/repositories/transaction_repository_impl.dart

class TransactionRepositoryImpl implements TransactionRepository {
  final AppDatabase db;
  final EncryptionService encryption;

  @override
  Future<void> insert(Transaction transaction) async {
    // åŠ å¯†noteå­—æ®µ
    final encryptedNote = transaction.note != null
        ? await encryption.encrypt(transaction.note!)
        : null;

    // æ’å…¥æ•°æ®åº“
    await db.into(db.transactions).insert(
      TransactionsCompanion.insert(
        id: transaction.id,
        bookId: transaction.bookId,
        deviceId: transaction.deviceId,
        amount: transaction.amount,
        type: transaction.type.name,
        categoryId: transaction.categoryId,
        ledgerType: transaction.ledgerType.name,
        timestamp: transaction.timestamp.millisecondsSinceEpoch,
        note: Value(encryptedNote),
        photoHash: Value(transaction.photoHash),
        prevHash: Value(transaction.prevHash),
        currentHash: transaction.currentHash,
        createdAt: transaction.createdAt.millisecondsSinceEpoch,
      ),
    );
  }

  @override
  Future<List<Transaction>> getTransactions({
    required String bookId,
    LedgerType? ledgerType,
    DateTime? startDate,
    DateTime? endDate,
    int limit = 50,
    int offset = 0,
  }) async {
    final query = db.select(db.transactions)
      ..where((t) => t.bookId.equals(bookId));

    if (ledgerType != null) {
      query.where((t) => t.ledgerType.equals(ledgerType.name));
    }

    if (startDate != null) {
      query.where((t) => t.timestamp.isBiggerOrEqualValue(
        startDate.millisecondsSinceEpoch,
      ));
    }

    if (endDate != null) {
      query.where((t) => t.timestamp.isSmallerOrEqualValue(
        endDate.millisecondsSinceEpoch,
      ));
    }

    query
      ..orderBy([(t) => OrderingTerm.desc(t.timestamp)])
      ..limit(limit, offset: offset);

    final rows = await query.get();
    return rows.map((row) => _mapToTransaction(row)).toList();
  }

  Transaction _mapToTransaction(TransactionData row) {
    return Transaction(
      id: row.id,
      bookId: row.bookId,
      deviceId: row.deviceId,
      amount: row.amount,
      type: TransactionType.values.byName(row.type),
      categoryId: row.categoryId,
      ledgerType: LedgerType.values.byName(row.ledgerType),
      timestamp: DateTime.fromMillisecondsSinceEpoch(row.timestamp),
      note: row.note != null ? encryption.decrypt(row.note!) : null,
      photoHash: row.photoHash,
      prevHash: row.prevHash,
      currentHash: row.currentHash,
      createdAt: DateTime.fromMillisecondsSinceEpoch(row.createdAt),
    );
  }
}
```

### 3.2 UIç»„ä»¶

**é‡‘é¢è¾“å…¥ç»„ä»¶:**
```dart
class AmountInput extends StatefulWidget {
  final Function(int) onAmountChanged;

  @override
  State<AmountInput> createState() => _AmountInputState();
}

class _AmountInputState extends State<AmountInput> {
  String _displayAmount = '0';

  void _onNumberPressed(String digit) {
    setState(() {
      if (_displayAmount == '0') {
        _displayAmount = digit;
      } else {
        _displayAmount += digit;
      }
      widget.onAmountChanged(int.parse(_displayAmount));
    });
  }

  void _onDeletePressed() {
    setState(() {
      if (_displayAmount.length > 1) {
        _displayAmount = _displayAmount.substring(0, _displayAmount.length - 1);
      } else {
        _displayAmount = '0';
      }
      widget.onAmountChanged(int.parse(_displayAmount));
    });
  }

  @override
  Widget build(BuildContext context) {
    return Column(
      children: [
        Text(
          'Â¥ ${_formatAmount(_displayAmount)}',
          style: Theme.of(context).textTheme.displayLarge,
        ),
        SizedBox(height: 24),
        // æ•°å­—é”®ç›˜å¸ƒå±€
        GridView.count(
          crossAxisCount: 3,
          shrinkWrap: true,
          children: [
            _buildKey('1'),
            _buildKey('2'),
            _buildKey('3'),
            _buildKey('4'),
            _buildKey('5'),
            _buildKey('6'),
            _buildKey('7'),
            _buildKey('8'),
            _buildKey('9'),
            _buildKey('00'),
            _buildKey('0'),
            _buildDeleteKey(),
          ],
        ),
      ],
    );
  }

  String _formatAmount(String amount) {
    final formatter = NumberFormat('#,###', 'ja_JP');
    return formatter.format(int.parse(amount));
  }
}
```

---

## 4. æµ‹è¯•è®¡åˆ’

### 4.1 å•å…ƒæµ‹è¯•

```dart
void main() {
  group('TransactionRepository', () {
    test('should insert and retrieve transaction', () async {
      final repo = TransactionRepositoryImpl(db, encryption);
      final tx = Transaction(...);

      await repo.insert(tx);
      final retrieved = await repo.getById(tx.id);

      expect(retrieved, isNotNull);
      expect(retrieved!.id, equals(tx.id));
      expect(retrieved.amount, equals(tx.amount));
    });

    test('should verify hash chain integrity', () async {
      final hashChain = HashChainService(repo);
      final result = await hashChain.verifyChain(bookId);

      expect(result, isTrue);
    });
  });
}
```

### 4.2 Widgetæµ‹è¯•

```dart
void main() {
  testWidgets('should create transaction', (tester) async {
    await tester.pumpWidget(MyApp());

    // ç‚¹å‡»æ·»åŠ æŒ‰é’®
    await tester.tap(find.byIcon(Icons.add));
    await tester.pumpAndSettle();

    // è¾“å…¥é‡‘é¢
    await tester.tap(find.text('1'));
    await tester.tap(find.text('2'));
    await tester.tap(find.text('8'));
    await tester.tap(find.text('0'));
    await tester.pumpAndSettle();

    // éªŒè¯æ˜¾ç¤º
    expect(find.text('Â¥ 1,280'), findsOneWidget);

    // é€‰æ‹©åˆ†ç±»
    await tester.tap(find.text('é£Ÿè²»'));
    await tester.pumpAndSettle();

    // ä¿å­˜
    await tester.tap(find.text('ä¿å­˜'));
    await tester.pumpAndSettle();

    // éªŒè¯åˆ—è¡¨
    expect(find.text('Â¥1,280'), findsOneWidget);
  });
}
```

---

## 5. é™„å½•

### 5.1 å·¥æ—¶ä¼°ç®—æ˜ç»†

| ä»»åŠ¡ | å­ä»»åŠ¡ | å·¥æ—¶ |
|------|--------|------|
| A01 æ”¯å‡ºè®°å½• | UIå®ç° | 2å¤© |
|             | ä¸šåŠ¡é€»è¾‘ | 1å¤© |
|             | å“ˆå¸Œé“¾é›†æˆ | 1å¤© |
| A02 æ”¶å…¥è®°å½• | UIå®ç° | 1å¤© |
|             | ä¸šåŠ¡é€»è¾‘ | 0.5å¤© |
| A03 åˆ†ç±»ç®¡ç† | é¢„è®¾åˆ†ç±» | 1å¤© |
|             | è‡ªå®šä¹‰åˆ†ç±» | 2å¤© |
| A04 å›¾æ ‡é¢œè‰² | UIç»„ä»¶ | 2å¤© |
| A05 äº¤æ˜“åˆ—è¡¨ | åˆ—è¡¨UI | 1å¤© |
|             | åˆ†é¡µåŠ è½½ | 1å¤© |
| A06 æœç´¢åŠŸèƒ½ | æœç´¢UI | 1å¤© |
|             | æŸ¥è¯¢é€»è¾‘ | 1å¤© |
| A07 äº¤æ˜“ä¿®æ­£ | UIå®ç° | 1å¤© |
|             | ä¿®æ­£é€»è¾‘ | 1å¤© |
| **æ€»è®¡** | | **13å¤©** |

### 5.2 ç›¸å…³æ–‡æ¡£

- [PRD_MVP_Global.md](./PRD_MVP_Global.md) - MVPå…¨å±€éœ€æ±‚
- [PRD_MVP_App.md](./PRD_MVP_App.md) - Appç«¯æ€»ä½“éœ€æ±‚
- [PRD_Module_DualLedger.md](./PRD_Module_DualLedger.md) - åŒè½¨è´¦æœ¬æ¨¡å—ï¼ˆä¾èµ–æœ¬æ¨¡å—ï¼‰

---

**æ–‡æ¡£çŠ¶æ€:** Draft
**éœ€è¦è¯„å®¡:** äº§å“ç»ç†ã€å‰ç«¯å¼€å‘ã€UI/UXè®¾è®¡å¸ˆ
