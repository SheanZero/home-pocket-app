# ADR-010 Review 总结

**文档:** `ADR-010_CRDT_Conflict_Resolution_Strategy.md`
**状态:** 📝 草稿 - 待 Review
**创建日期:** 2026-02-03

---

## 📋 文档概览

本 ADR 分析了当前 CRDT 实现中冲突解决策略过于简化的问题，提出了 4 种改进方案。

---

## 🎯 核心问题

### 当前实现的问题

```dart
// 当前: 简单的 Last-Write-Wins
Transaction resolveConflict(Transaction local, Transaction remote) {
  if (remote.updatedAt!.isAfter(local.updatedAt!)) {
    return remote;  // ❌ 直接覆盖
  }
  return local;
}
```

**存在的风险:**
1. ✗ 并发修改会丢失数据（一方的修改被覆盖）
2. ✗ 依赖设备时间（时钟漂移问题）
3. ✗ 无法处理字段级冲突
4. ✗ 用户不知道发生了冲突
5. ✗ 财务数据丢失是严重问题

**示例场景:**
```
初始: 交易(金额=100, 备注='晚餐')

Device A: 修改金额 → 120
Device B: 修改备注 → '晚餐+宵夜'

同步后: ❌ 金额修改丢失！
结果: 交易(金额=100, 备注='晚餐+宵夜')
```

---

## 🔍 分析的方案

### 方案 1: 字段级合并

**核心思想:** 针对每个字段单独判断冲突

**优点:**
- ✅ 减少数据丢失
- ✅ 实现简单
- ✅ 无额外存储

**缺点:**
- ❌ 仍依赖时间戳
- ❌ 无法处理复杂依赖

**推荐度:** ⭐⭐⭐

---

### 方案 2: 向量时钟 + 因果关系判断 ⭐ (推荐)

**核心思想:** 使用向量时钟精确判断操作的因果关系

**关键机制:**

```dart
// 向量时钟示例
VectorClock {
  'device-a': 5,  // Device A 的逻辑时钟
  'device-b': 3,  // Device B 的逻辑时钟
}

// 比较两个版本
ClockComparison {
  before,      // 本地版本过时 → 使用远程
  after,       // 本地版本更新 → 保留本地
  concurrent,  // 并发修改 → 需要合并
  equal,       // 相同版本 → 无需处理
}
```

**优点:**
- ✅ **精确检测并发**（不依赖设备时间）
- ✅ **确定性冲突解决**（相同输入相同输出）
- ✅ **理论基础扎实**（学术界广泛研究）
- ✅ **可扩展**（支持任意数量设备）

**缺点:**
- ⚠️ 数据模型需变更（添加 vectorClock 字段）
- ⚠️ 存储开销增加（~60 bytes/交易）
- ⚠️ 实现复杂度中等

**推荐度:** ⭐⭐⭐⭐⭐

---

### 方案 3: 用户手动解决

**核心思想:** 检测到冲突时记录，让用户选择

**优点:**
- ✅ 零数据丢失
- ✅ 用户完全控制
- ✅ 可审计

**缺点:**
- ❌ 用户体验差
- ❌ 增加认知负担
- ❌ 实现复杂

**推荐度:** ⭐⭐

---

### 方案 4: 操作型 CRDT

**核心思想:** 传输操作序列而非最终状态

**优点:**
- ✅ 理论上最准确

**缺点:**
- ❌ 实现极其复杂
- ❌ 存储开销巨大
- ❌ 不适合财务应用

**推荐度:** ⭐ (不推荐)

---

## 📊 方案对比

| 方案 | 数据丢失风险 | 用户体验 | 实现复杂度 | 存储开销 | 推荐度 |
|------|------------|---------|-----------|---------|--------|
| 字段级合并 | ⚠️ 中 | ✅ 好 | ✅ 低 | ✅ 无 | ⭐⭐⭐ |
| **向量时钟** | **✅ 低** | **✅ 好** | **⚠️ 中** | **⚠️ 小** | **⭐⭐⭐⭐⭐** |
| 用户手动 | ✅ 极低 | ❌ 差 | ❌ 高 | ⚠️ 中 | ⭐⭐ |
| 操作型 | ✅ 极低 | ⚠️ 中 | ❌ 极高 | ❌ 大 | ⭐ |

---

## 💡 推荐决策

### 推荐方案: 向量时钟 + 因果关系判断

**理由:**
1. 精确解决核心问题（并发检测）
2. 不依赖设备时间（解决时钟漂移）
3. 实现复杂度适中（团队可维护）
4. 存储开销可接受（~60 bytes/交易）
5. 可扩展性好（后续可增强）

### 分阶段实施

**Phase 1 (MVP):**
- 实现向量时钟
- 基本冲突检测
- 简单字段级合并

**Phase 2 (V1.0):**
- 冲突通知
- 冲突历史查看
- 优化合并策略

**Phase 3 (V2.0):**
- 用户可配置策略
- 关键冲突转手动解决

---

## ❓ 需要决策的问题

以下 4 个问题需要团队讨论：

### 1. 并发修改金额的处理

**场景:** Device A 和 B 同时修改金额

**选项:**
- A. 使用设备ID字典序（确定性）
- B. 使用较大的金额
- C. 使用较小的金额（保守）
- D. 转为用户手动解决

**你的建议:** ？

---

### 2. 删除冲突的处理

**场景:** 一方删除，一方修改

**选项:**
- A. 删除优先
- B. 修改优先（保留数据）
- C. 转为用户手动解决
- D. 标记为"曾被删除"

**你的建议:** ？

---

### 3. 冲突通知的时机

**选项:**
- A. 立即通知（可能频繁）
- B. 批量通知（同步后汇总）
- C. 不通知（后台记录）
- D. 仅关键冲突通知（金额冲突）

**你的建议:** ？

---

### 4. 向量时钟的清理策略

**问题:** 向量时钟会随设备增加而膨胀

**选项:**
- A. 不清理（接受开销）
- B. 定期清理离线设备
- C. 使用版本向量
- D. 设置设备数量上限

**你的建议:** ？

---

## 📝 Review 清单

请 Review 以下方面：

### 内容完整性
- [ ] 问题分析是否准确？
- [ ] 方案对比是否全面？
- [ ] 是否有遗漏的场景？
- [ ] 是否有遗漏的方案？

### 推荐方案
- [ ] 向量时钟方案是否合适？
- [ ] 实现复杂度评估是否准确？
- [ ] 存储开销是否可接受？
- [ ] 分阶段实施计划是否合理？

### 待决策问题
- [ ] 4 个待决策问题是否清晰？
- [ ] 是否还有其他需要决策的问题？
- [ ] 每个问题的选项是否完整？

### 文档质量
- [ ] 代码示例是否清晰？
- [ ] 是否易于理解？
- [ ] 是否需要补充说明？

---

## 🎯 下一步行动

1. **Review ADR-010 完整文档**
   - 文件: `arch2/03-adr/ADR-010_CRDT_Conflict_Resolution_Strategy.md`
   - 大小: ~40KB
   - 包含详细代码实现示例

2. **讨论和决策**
   - 团队会议讨论 4 个待决策问题
   - 确认推荐方案
   - 评估实施成本

3. **更新 ADR 状态**
   - 从"草稿"更新为"已接受"或"已拒绝"
   - 记录决策理由

4. **开始实施**
   - 根据 Phase 1 计划开始开发

---

## 📞 反馈方式

**期待你的反馈:**
- 直接在 ADR-010 文档中标注评论
- 或在团队会议中讨论
- 或通过 Slack #architecture-decisions

**关键决策点:**
- 是否接受向量时钟方案？
- 4 个待决策问题的答案是什么？
- 实施时间表是否合理？

---

**文档状态:** 📝 草稿 - 等待 Review
**预计 Review 时间:** 1-2 天
**下次更新:** Review 完成后
