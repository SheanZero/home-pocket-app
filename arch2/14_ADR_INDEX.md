# Architecture Decision Records (ADR) 索引

**项目:** Home Pocket MVP
**最后更新:** 2026-02-03

---

## 📋 ADR概述

Architecture Decision Records (ADR) 记录了项目中的重要架构决策,包括背景、备选方案分析、最终决策及理由。

---

## 📚 ADR列表

### [ADR-001: 选择Riverpod作为状态管理方案](./14_ADR_001_State_Management.md)

**状态:** ✅ 已接受
**日期:** 2026-02-03
**影响范围:** 整个应用的状态管理层

**核心决策:**
选择 **flutter_riverpod 2.x** 作为状态管理方案

**关键理由:**
- 编译时类型安全
- 自动依赖注入
- 优秀的DevTools支持
- 代码生成减少样板代码
- 测试友好

**备选方案:**
- flutter_bloc (样板代码过多)
- GetX (类型安全性差)
- Provider (功能较弱)

**下次Review:** 2026-08-03

---

### [ADR-002: 选择Drift+SQLCipher作为数据库方案](./14_ADR_002_Database_Solution.md)

**状态:** ✅ 已接受
**日期:** 2026-02-03
**影响范围:** 数据持久化层、安全架构

**核心决策:**
选择 **Drift + SQLCipher** 组合

**关键理由:**
- 类型安全的SQL查询(编译时检查)
- 透明的数据库级加密(SQLCipher)
- 优秀的迁移支持
- 成熟的生态和活跃维护

**备选方案:**
- Hive + 自定义加密 (NoSQL限制,自定义加密风险)
- Isar (生态不成熟)
- sqflite + SQLCipher (无类型安全)

**安全特性:**
- AES-256-CBC加密
- PBKDF2密钥派生(256,000次迭代)
- FIPS 140-2验证

**下次Review:** 2026-08-03

---

### [ADR-003: 多层加密策略](./14_ADR_003_Multi_Layer_Encryption.md)

**状态:** ✅ 已接受
**日期:** 2026-02-03
**影响范围:** 整个应用的数据安全层

**核心决策:**
采用 **4层纵深防御加密策略**

**加密层次:**

| 层级 | 技术 | 范围 | 算法 |
|------|------|------|------|
| Layer 1 | SQLCipher | 数据库文件 | AES-256-CBC |
| Layer 2 | cryptography | 敏感字段 | ChaCha20-Poly1305 |
| Layer 3 | cryptography | 照片文件 | AES-256-GCM |
| Layer 4 | 自定义E2EE | 设备间同步 | ChaCha20-Poly1305 |

**密钥管理:**
- 主密钥 → HKDF派生专用密钥
- iOS Keychain / Android KeyStore存储
- Ed25519设备密钥对

**安全标准:**
- ✅ FIPS 140-2验证
- ✅ OWASP移动应用安全标准
- ✅ GDPR合规

**下次Review:** 2026-05-03 (每季度)

---

### [ADR-004: 选择Yjs-inspired CRDT方案](./14_ADR_004_CRDT_Sync.md)

**状态:** ✅ 已接受
**日期:** 2026-02-03
**影响范围:** 家庭同步功能(MOD-004)

**核心决策:**
选择 **Yjs-inspired CRDT (Last-Write-Wins + 向量时钟)**

**关键理由:**
- 自动冲突解决,无需用户介入
- 向量时钟精确检测并发
- 最终一致性保证
- P2P友好,无需中央服务器
- 生产验证(Yjs广泛使用)

**核心机制:**
- **向量时钟:** 追踪因果关系
- **Lamport时间戳:** 全局顺序
- **Last-Write-Wins:** 冲突解决策略
- **墓碑(Tombstone):** 处理删除

**备选方案:**
- Operational Transformation (实现极其复杂)
- 简单LWW (时钟漂移问题)
- 三路合并 (存储开销大)

**限制:**
- LWW可能丢失并发修改
- 向量时钟膨胀(需定期清理)
- 删除需要墓碑(软删除)

**下次Review:** 2026-08-03

---

### [ADR-005: OCR和ML技术选型](./14_ADR_005_OCR_ML_Tech.md)

**状态:** ✅ 已接受
**日期:** 2026-02-03
**影响范围:** OCR扫描功能(MOD-005), 智能分类功能(MOD-003)

**核心决策:**

#### OCR方案: 平台原生OCR
- **Android:** ML Kit Text Recognition v2
- **iOS:** Vision Framework

**关键理由:**
- 免费,无API成本
- 本地处理,隐私保护
- 准确率高(>90%)
- 零维护成本

#### 智能分类方案: 三层引擎

**MVP阶段:**
- Layer 1: 规则引擎 (100%准确率,70%覆盖率)
- Layer 2: 商家数据库 (85%准确率,20%覆盖率)
- 默认: 保守策略(生存账本)

**V1.0阶段:**
- Layer 3: TFLite自训练模型 (75-85%准确率)

**备选方案:**
- TFLite自训练OCR (训练成本高)
- 云端OCR API (违反隐私原则)
- Gemini Nano (设备兼容性差,移至Premium功能)

**性能指标:**
- OCR准确率: 90-95%
- OCR响应时间: 1-2秒
- 分类准确率: 85-90%
- 分类响应时间: <50ms

**下次Review:** 2026-08-03

---

## 🔗 ADR关系图

```
ADR-001 (Riverpod)
   ↓ 集成
ADR-002 (Drift+SQLCipher)
   ↓ 加密
ADR-003 (多层加密)
   ↓ 同步
ADR-004 (CRDT)

ADR-005 (OCR+ML)
   ↓ 使用
ADR-001 (Riverpod)
   ↓ 存储
ADR-002 (Drift)
```

---

## 📊 决策统计

| 状态 | 数量 |
|------|------|
| ✅ 已接受 | 5 |
| 🔄 讨论中 | 0 |
| ❌ 已拒绝 | 0 |
| 📝 草稿 | 0 |

**总计:** 5个ADR

---

## 🎯 下次Review计划

| ADR | 下次Review日期 | 频率 |
|-----|---------------|------|
| ADR-001 | 2026-08-03 | 每6个月 |
| ADR-002 | 2026-08-03 | 每6个月 |
| ADR-003 | 2026-05-03 | 每3个月(安全) |
| ADR-004 | 2026-08-03 | 每6个月 |
| ADR-005 | 2026-08-03 | 每6个月 |

---

## 📝 ADR模板

创建新ADR时使用以下模板:

```markdown
# ADR-XXX: [决策标题]

**状态:** 🔄 讨论中 / ✅ 已接受 / ❌ 已拒绝
**日期:** YYYY-MM-DD
**决策者:** [决策团队]
**影响范围:** [影响的模块/层]

---

## 背景与问题陈述

### 业务需求
...

### 技术要求
...

---

## 决策驱动因素

### 关键考虑因素
1. ...
2. ...

---

## 备选方案分析

### 方案1: [方案名称] ✅ (选择)

**优势:**
- ✅ ...

**劣势:**
- ⚠️ ...

---

### 方案2: [方案名称]

**为何不选择:**
...

---

## 最终决策

**选择 [方案名称]**

### 核心理由
1. ...

---

## 实施计划

...

---

## 后果分析

### 正面影响
...

### 负面影响
...

---

## 相关决策

- ADR-XXX: ...

---

## 参考资料

...

---

## 变更历史

| 日期 | 版本 | 变更内容 | 作者 |
|------|------|---------|------|
| YYYY-MM-DD | 1.0 | 初始版本 | ... |

---

**文档维护者:** ...
**审核者:** ...
**下次Review日期:** ...
```

---

## 🔄 ADR流程

### 1. 提出ADR

当遇到以下情况时,应创建ADR:

- 技术栈选型
- 架构模式选择
- 关键设计决策
- 第三方库选择
- 安全策略制定

### 2. 讨论与评审

- 技术团队讨论
- 备选方案分析
- 原型验证(如需要)

### 3. 决策与记录

- 确定最终方案
- 记录决策理由
- 文档化备选方案

### 4. 实施与跟踪

- 按计划实施
- 跟踪实施进度
- 记录实际效果

### 5. 定期Review

- 按频率Review
- 评估决策有效性
- 必要时更新或废弃

---

## 📞 联系方式

**ADR维护者:** 技术架构团队
**Email:** architecture@homepocket.com
**Slack:** #architecture-decisions

---

**最后更新:** 2026-02-03
**文档版本:** 1.0
