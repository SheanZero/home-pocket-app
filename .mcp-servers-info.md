# MCP Servers Configuration

本项目配置了以下 MCP (Model Context Protocol) Servers 来增强 Claude Code 的开发能力。

## 配置的 MCP Servers

### 1. Dart Server (自定义)
**位置:** `~/.claude/mcp-servers/dart-server/`
**类型:** 自定义 MCP Server
**用途:** Dart/Flutter 开发专用工具集

**提供的功能:**
- 代码分析（dart_analyze）
- 代码格式化（dart_format）
- 包管理（flutter_pub_get, flutter_pub_add, flutter_pub_outdated）
- 代码生成（build_runner_build）
- 项目结构分析（get_project_structure）
- 环境检查（flutter_doctor）
- 测试运行（flutter_test）

**适用场景:**
- 开发 Flutter 应用时的代码质量检查
- 自动化依赖管理
- 代码生成（Riverpod, Freezed, Drift 等）
- 项目结构探索

---

### 2. Memory Server (官方)
**包名:** `@modelcontextprotocol/server-memory`
**类型:** Anthropic 官方 MCP Server
**用途:** 跨会话持久化内存

**提供的功能:**
- **create_entities**: 创建实体（如人物、项目、概念等）并存储到知识图谱
- **create_relations**: 建立实体间的关系
- **add_observations**: 为实体添加观察记录
- **delete_entities**: 删除实体
- **delete_observations**: 删除观察记录
- **delete_relations**: 删除关系
- **read_graph**: 读取整个知识图谱
- **search_nodes**: 搜索节点
- **open_nodes**: 打开特定节点查看详情

**适用场景:**
- 记录项目架构决策和演进历史
- 跟踪代码库中的关键概念和模块关系
- 保存开发过程中的重要发现
- 建立项目知识库，方便团队协作
- 记住用户偏好和项目约定

**示例用法:**
```markdown
# 记录架构决策
创建实体：MOD-006 Security Module
添加观察：使用 4 层加密策略（SQLCipher + ChaCha20 + AES-256-GCM + TLS 1.3）
建立关系：MOD-006 → depends_on → SQLCipher

# 记录问题解决
创建实体：iOS Build Error
添加观察：需要在 Podfile 中添加 EXCLUDED_ARCHS 配置
建立关系：iOS Build Error → solved_by → Podfile Configuration
```

---

### 3. Sequential Thinking Server (官方)
**包名:** `@modelcontextprotocol/server-sequential-thinking`
**类型:** Anthropic 官方 MCP Server
**用途:** 结构化思维链推理

**提供的功能:**
- **create_dream**: 创建思考序列
- **append_thought**: 追加思考步骤
- **final_answer**: 给出最终答案

**适用场景:**
- 复杂问题的分步推理
- 架构设计决策分析
- 调试问题的逻辑推导
- 代码重构的影响分析
- 多方案对比评估

**示例用法:**
```markdown
# 复杂问题分析
1. create_dream: "分析 MOD-006 加密模块的性能影响"
2. append_thought: "第一层 SQLCipher 加密影响数据库读写性能"
3. append_thought: "第二层字段加密增加 CPU 开销"
4. append_thought: "可以通过缓存解密后的数据减少开销"
5. final_answer: "综合评估，性能影响可控，建议实现缓存机制"

# 架构决策分析
1. create_dream: "评估状态管理方案：Riverpod vs Provider vs Bloc"
2. append_thought: "Riverpod 提供编译时安全和代码生成"
3. append_thought: "项目已使用 build_runner，Riverpod 集成成本低"
4. final_answer: "选择 Riverpod 作为状态管理方案"
```

---

## 配置文件

### `.mcp.json`
```json
{
  "mcpServers": {
    "dart": {
      "command": "node",
      "args": [
        "/Users/xinz/.claude/mcp-servers/dart-server/index.js"
      ],
      "env": {
        "PATH": "/Users/xinz/flutter/bin:/Users/xinz/.nvm/versions/node/v22.18.0/bin:/usr/local/bin:/usr/bin:/bin"
      }
    },
    "memory": {
      "command": "npx",
      "args": ["-y", "@modelcontextprotocol/server-memory"],
      "description": "Persistent memory across sessions"
    },
    "sequential-thinking": {
      "command": "npx",
      "args": ["-y", "@modelcontextprotocol/server-sequential-thinking"],
      "description": "Chain-of-thought reasoning"
    }
  }
}
```

### `~/.claude/settings.json`
确保启用了项目级 MCP servers：
```json
{
  "enableAllProjectMcpServers": true
}
```

---

## 使用建议

### 开发工作流集成

1. **代码开发阶段:**
   - 使用 **Dart Server** 进行代码分析和格式化
   - 使用 **Memory Server** 记录设计决策和架构选择

2. **问题调试阶段:**
   - 使用 **Sequential Thinking** 进行问题分析
   - 使用 **Memory Server** 记录问题和解决方案

3. **代码审查阶段:**
   - 使用 **Dart Server** 检查代码质量
   - 使用 **Memory Server** 记录审查发现和改进建议

4. **知识积累:**
   - 使用 **Memory Server** 建立项目知识图谱
   - 记录模块关系、依赖关系、设计模式

### 团队协作

Memory Server 的知识图谱可以：
- 帮助新成员快速了解项目架构
- 保存团队共识和约定
- 记录历史决策和演进路径
- 建立可搜索的项目文档

---

## 启用方法

1. 确保 `.mcp.json` 配置正确
2. 确保 `~/.claude/settings.json` 中启用了 `enableAllProjectMcpServers: true`
3. **重启 Claude Code 会话**（重要！）
4. MCP Servers 将自动加载

---

## 验证 MCP Servers 是否加载

重启 Claude Code 后，可以通过以下方式验证：

1. 观察启动日志，查看是否有 MCP server 加载信息
2. 使用 `/mcp` 命令查看已加载的 MCP servers
3. 尝试使用相关功能（如请求分析代码、记录信息等）

---

## 故障排查

### MCP Server 未加载

1. **检查配置文件:**
   ```bash
   cat .mcp.json
   cat ~/.claude/settings.json
   ```

2. **检查 npx 可用性:**
   ```bash
   npx --version
   ```

3. **检查 Node.js 版本:**
   ```bash
   node --version  # 需要 >= 18.0.0
   ```

4. **手动测试 MCP Server:**
   ```bash
   npx -y @modelcontextprotocol/server-memory
   npx -y @modelcontextprotocol/server-sequential-thinking
   ```

### Dart Server 无法运行

1. **检查 Flutter 环境:**
   ```bash
   flutter doctor
   which dart
   ```

2. **检查 Dart Server 安装:**
   ```bash
   ls -la ~/.claude/mcp-servers/dart-server/
   ```

3. **检查依赖:**
   ```bash
   cd ~/.claude/mcp-servers/dart-server && npm list
   ```

---

## 更新日志

### 2026-02-03
- 添加 Dart Server (自定义)
- 添加 Memory Server (官方)
- 添加 Sequential Thinking Server (官方)
- 创建配置文档

---

## 参考资源

- [Model Context Protocol 文档](https://modelcontextprotocol.io/)
- [Anthropic MCP Servers](https://github.com/modelcontextprotocol)
- [Dart MCP Server README](~/.claude/mcp-servers/dart-server/README.md)

---

**配置完成！** 重启 Claude Code 后即可使用这些强大的开发工具。
